# 要件定義書 - 家計シミュレーター

## 1. プロジェクト概要

### 1.1 目的
月ごとの支出・収入の想定額を入力し、支払いごとに口座残高の推移を確認することで、将来の貯金・預金残高の見通しを立てられるWebアプリケーションを開発する。

### 1.2 ターゲットユーザー
- 個人の家計管理を行いたいユーザー
- 将来の資金計画を立てたいユーザー
- 収支のシミュレーションを視覚的に確認したいユーザー

### 1.3 開発の背景
- 将来の家計状況を事前に把握したい
- 月ごとの収支を管理し、計画的な貯蓄を行いたい
- Pythonで計算ロジックを実装しながら学習したい
- Webアプリケーション開発の経験を積みたい

## 2. 機能要件

### 2.1 初期設定機能

#### 2.1.1 初期残高設定
- **必須項目**
  - 初期口座残高（整数）
  - シミュレーション開始日（年月日）
  - シミュレーション期間（月数: 1〜60ヶ月）

- **機能詳細**
  - 初期残高は正・負どちらも入力可能
  - 開始日は過去・未来どちらも設定可能
  - 期間は最小1ヶ月、最大60ヶ月（5年）

- **制約**
  - 有効な設定は常に1つのみ（is_activeフラグで管理）

### 2.2 月次計画入力機能

#### 2.2.1 収入項目
| 項目名 | フィールド名 | 型 | デフォルト値 | 備考 |
|--------|-------------|-----|-------------|------|
| 給与 | salary | 整数 | 0 | 毎月の固定給 |
| ボーナス | bonus | 整数 | 0 | 該当月のみ入力 |

#### 2.2.2 支出項目
| 項目名 | フィールド名 | 型 | デフォルト値 | 備考 |
|--------|-------------|-----|-------------|------|
| 食費 | food | 整数 | 0 | 月次変動可 |
| 家賃 | rent | 整数 | 0 | 通常は固定 |
| レイク返済 | lake | 整数 | 0 | ローン返済 |
| クレカ引落 | credit | 整数 | 0 | CSV取込可能 |
| 定期預金 | savings | 整数 | 0 | 月次積立 |
| マネーアシスト返済 | loan | 整数 | 0 | ローン返済 |
| 光熱費 | utilities | 整数 | 0 | 月次変動可 |
| 交通費 | transportation | 整数 | 0 | 月次変動可 |
| 娯楽費 | entertainment | 整数 | 0 | 月次変動可 |
| その他 | other | 整数 | 0 | 予備費 |

#### 2.2.3 月次計画の操作
- **新規作成**: 対象月（YYYY-MM形式）を指定して新規作成
- **編集**: 既存の月次計画を選択して編集
- **複製**: 前月のデータをコピーして新規作成
- **削除**: 不要な月次計画を削除

#### 2.2.4 入力補助機能
- 前月のデータを初期値として表示
- 固定費（家賃など）は自動コピー機能（将来実装）
- 入力値のバリデーション（負の値チェックなど）

### 2.3 シミュレーション計算機能

#### 2.3.1 計算ロジック
1. **初期化**
   - 有効なSimulationConfigから初期残高を取得
   - 開始日と期間から対象月リストを生成

2. **月次イベント生成**
   - 各月のMonthlyPlanから収支項目を抽出
   - 各項目を個別のTransactionEventとして作成
   - イベント発生日を設定（後述のルール参照）

3. **残高計算**
   - イベントを日付順にソート
   - 初期残高から順次加減算
   - 各イベント後の残高を記録

4. **結果保存**
   - TransactionEventテーブルに計算結果を保存
   - 既存の計算結果は削除して再計算

#### 2.3.2 イベント発生日のルール
| イベント種類 | 発生日 | 備考 |
|-------------|-------|------|
| 給与 | 毎月25日 | カスタマイズ可能 |
| ボーナス | 6月25日、12月25日 | 設定月の25日 |
| 食費 | 毎月1日 | 月初想定 |
| 家賃 | 毎月27日 | 引落日 |
| レイク返済 | 毎月5日 | 引落日 |
| クレカ引落 | 毎月10日 | カード会社による |
| 定期預金 | 毎月26日 | 給与後想定 |
| マネーアシスト返済 | 毎月15日 | 引落日 |
| 光熱費 | 毎月20日 | 平均的な引落日 |
| 交通費 | 毎月1日 | 月初想定 |
| 娯楽費 | 毎月15日 | 月中想定 |
| その他 | 毎月末日 | 月末想定 |

**注意**: 上記の日付は初期設定であり、将来的にユーザーがカスタマイズ可能にする予定

#### 2.3.3 再計算
- 月次計画が更新された場合、「再計算」ボタンで最新データに更新
- 再計算時は既存のTransactionEventを全削除して新規作成

### 2.4 結果表示機能

#### 2.4.1 テーブル表示
- **表示項目**
  - 日付（YYYY-MM-DD）
  - イベント名（日本語表示）
  - 金額（カンマ区切り、正負の符号付き）
  - 取引後残高（カンマ区切り）

- **表示機能**
  - 日付順にソート
  - 月ごとにグループ化
  - 負の残高は赤字で表示
  - ページネーション（100件/ページ）

- **フィルタリング**
  - 月で絞り込み
  - イベント種類で絞り込み
  - 金額範囲で絞り込み

#### 2.4.2 グラフ表示
- **グラフ種類**: 折れ線グラフ
- **X軸**: 日付
- **Y軸**: 残高
- **機能**
  - ズーム機能
  - ホバーで詳細表示
  - 月の境界線表示
  - 残高0のラインを表示

- **視覚的表現**
  - 正の残高: 青系の色
  - 負の残高: 赤系の色
  - ボーナス月: マーカーで強調

#### 2.4.3 サマリー表示
- **月次サマリー**
  - 月初残高
  - 月末残高
  - 月次収入合計
  - 月次支出合計
  - 月次収支（純増減）

- **全体サマリー**
  - 期間開始時残高
  - 期間終了時残高
  - 総収入
  - 総支出
  - 純増減

### 2.5 データ管理機能

#### 2.5.1 CSV エクスポート（将来実装）
- **エクスポート対象**
  - 月次計画データ
  - 取引イベントデータ
  - サマリーデータ

- **ファイル形式**
  - UTF-8エンコーディング
  - カンマ区切り
  - ヘッダー行あり

#### 2.5.2 CSV インポート（将来実装）
- **インポート対象**
  - クレジットカード明細
  - 銀行口座明細

- **機能**
  - ファイルアップロード
  - データマッピング設定
  - インポート前プレビュー
  - 重複チェック

#### 2.5.3 外部API連携（将来実装）
- **Zaim API連携**
  - 実際の支出データ取得
  - 自動データ反映
  - カテゴリマッピング

### 2.6 管理画面機能

#### 2.6.1 Django Admin
- すべてのモデルを管理画面で操作可能
- 日本語表示
- 検索・フィルタリング機能
- 一括操作機能

#### 2.6.2 データメンテナンス
- 古いシミュレーションデータの削除
- データのバックアップ・復元
- データベースの最適化

## 3. 非機能要件

### 3.1 パフォーマンス
- ページ読み込み時間: 3秒以内
- シミュレーション計算: 5秒以内（24ヶ月分）
- グラフ描画: 2秒以内

### 3.2 使いやすさ
- レスポンシブデザイン（スマホ・タブレット対応）
- 直感的なUI
- エラーメッセージの分かりやすい表示

### 3.3 保守性
- コードの可読性を重視
- 適切なコメント
- ドキュメントの整備

### 3.4 拡張性
- 新しい支出項目の追加が容易
- 外部API連携が可能な設計
- マルチユーザー対応への拡張が可能

### 3.5 セキュリティ
- CSRF対策（Django標準）
- SQLインジェクション対策（ORMの使用）
- XSS対策（テンプレートエスケープ）

### 3.6 可用性
- エラー時の適切なハンドリング
- データ損失の防止
- バックアップ機能

## 4. 画面遷移

```
[トップページ]
    │
    ├─→ [初期設定画面]
    │       └─→ 設定保存 → [トップページ]
    │
    ├─→ [月次計画一覧]
    │       ├─→ [月次計画新規作成]
    │       │       └─→ 保存 → [月次計画一覧]
    │       │
    │       └─→ [月次計画編集]
    │               └─→ 保存 → [月次計画一覧]
    │
    ├─→ [シミュレーション実行]
    │       └─→ 計算完了 → [結果表示]
    │
    └─→ [結果表示]
            ├─→ [テーブル表示]
            ├─→ [グラフ表示]
            └─→ [サマリー表示]
```

## 5. データフロー

```
1. ユーザー入力
   ↓
2. 月次計画データ保存（MonthlyPlan）
   ↓
3. シミュレーション実行
   ↓
4. 計算処理
   - 初期残高取得（SimulationConfig）
   - 月次計画読込（MonthlyPlan）
   - イベント生成・ソート
   - 残高計算
   ↓
5. 結果保存（TransactionEvent）
   ↓
6. 結果表示
   - テーブル
   - グラフ
   - サマリー
```

## 6. 今後の拡張計画

### フェーズ1（現在）
- 基本機能の実装
- 手動データ入力
- 簡易的な表示

### フェーズ2
- CSV入出力機能
- グラフの高度化
- レスポンシブデザイン

### フェーズ3
- Zaim API連携
- マルチユーザー対応
- クラウドへのデプロイ

### フェーズ4
- AI による支出予測
- 予算アラート機能
- モバイルアプリ化

## 7. 用語集

| 用語 | 説明 |
|------|------|
| 月次計画 | 1ヶ月分の収支計画データ |
| イベント | 入金または出金の発生 |
| シミュレーション | 将来の残高推移を計算すること |
| 初期残高 | シミュレーション開始時の口座残高 |
| 取引後残高 | 各イベント発生後の口座残高 |

## 8. 参考資料

- Django公式ドキュメント: https://docs.djangoproject.com/
- Chart.js公式ドキュメント: https://www.chartjs.org/
- Zaim API ドキュメント: https://dev.zaim.net/
