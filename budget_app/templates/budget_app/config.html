{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-4 md:mb-6">
        <h2 class="text-2xl md:text-3xl font-bold">設定</h2>
    </div>

    <!-- 月次計画デフォルト項目セクション -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">デフォルト項目</h3>
            <button onclick="openDefaultCreateModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm">
                新規追加
            </button>
        </div>

        {% if not defaults %}
        <!-- データがない場合のメッセージ -->
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-600 text-lg font-medium">まだデフォルト項目は登録されていません</p>
            <p class="text-gray-500 text-sm mt-2">右上の「新規追加」ボタンからデフォルト項目を追加できます</p>
        </div>
        {% else %}

        <!-- デフォルト金額が登録されている項目 -->
        <h4 class="hidden md:block text-lg font-bold mb-3 text-gray-800">金額設定済み</h4>

        <!-- デスクトップ表示：テーブル -->
        <div class="hidden md:block overflow-x-auto mb-6">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th class="px-3 py-2 text-left whitespace-nowrap">項目名</th>
                        <th class="px-3 py-2 text-right whitespace-nowrap">デフォルト金額</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">種別</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">引落日 / 振込日</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">休日考慮</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">締め日</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in defaults %}
                    {% if d.amount %}
                    <tr class="border-b" data-id="{{ d.id }}">
                        <td class="px-3 py-2 align-middle">{{ d.title }}</td>
                        <td class="px-3 py-2 align-middle text-right font-semibold">¥{{ d.amount|stringformat:'d'|intcomma }}</td>
                        <td class="px-3 py-2 align-middle text-center">
                            {% if d.payment_type == 'deposit' %}
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded whitespace-nowrap">振込</span>
                            {% else %}
                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded whitespace-nowrap">引落</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center whitespace-nowrap">
                            {% if d.is_withdrawal_end_of_month %}
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded whitespace-nowrap">末日</span>
                            {% elif d.withdrawal_day %}{{ d.withdrawal_day }}日
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center">
                            {% if d.consider_holidays %}
                                {% if d.payment_type == 'deposit' %}
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded whitespace-nowrap">前営業日</span>
                                {% else %}
                                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded whitespace-nowrap">翌営業日</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center whitespace-nowrap">
                            {% if d.is_end_of_month %}
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded whitespace-nowrap">末日</span>
                            {% elif d.closing_day %}{{ d.closing_day }}日
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 text-center align-middle">
                            <button type="button" class="text-blue-600 hover:text-blue-800 mr-2" onclick="openDefaultEditModal({{ d.id }}, '{{ d.title|escapejs }}', {{ d.amount|default:0|stringformat:'d' }}, '{{ d.payment_type }}', {{ d.withdrawal_day|default:'null' }}, {{ d.is_withdrawal_end_of_month|yesno:'true,false' }}, {{ d.consider_holidays|yesno:'true,false' }}, {{ d.closing_day|default:'null' }}, {{ d.is_end_of_month|yesno:'true,false' }})">
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <form method="post" action="{% url 'budget_app:monthly_plan_default_delete' d.pk %}" class="delete-form inline">
                                {% csrf_token %}
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- デフォルト金額が登録されていない項目 -->
        <h4 class="hidden md:block text-lg font-bold mb-3 text-gray-800">金額未設定</h4>

        <!-- デスクトップ表示：テーブル -->
        <div class="hidden md:block overflow-x-auto mb-6">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th class="px-3 py-2 text-left whitespace-nowrap">項目名</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">種別</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">引落日 / 振込日</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">休日考慮</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">締め日</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in defaults %}
                    {% if not d.amount %}
                    <tr class="border-b" data-id="{{ d.id }}">
                        <td class="px-3 py-2 align-middle">{{ d.title }}</td>
                        <td class="px-3 py-2 align-middle text-center">
                            {% if d.payment_type == 'deposit' %}
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded whitespace-nowrap">振込</span>
                            {% else %}
                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded whitespace-nowrap">引落</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center whitespace-nowrap">
                            {% if d.is_withdrawal_end_of_month %}
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded whitespace-nowrap">末日</span>
                            {% elif d.withdrawal_day %}{{ d.withdrawal_day }}日
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center">
                            {% if d.consider_holidays %}
                                {% if d.payment_type == 'deposit' %}
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded whitespace-nowrap">前営業日</span>
                                {% else %}
                                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded whitespace-nowrap">翌営業日</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 align-middle text-center whitespace-nowrap">
                            {% if d.is_end_of_month %}
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded whitespace-nowrap">末日</span>
                            {% elif d.closing_day %}{{ d.closing_day }}日
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-2 text-center align-middle">
                            <button type="button" class="text-blue-600 hover:text-blue-800 mr-2" onclick="openDefaultEditModal({{ d.id }}, '{{ d.title|escapejs }}', {{ d.amount|default:0|stringformat:'d' }}, '{{ d.payment_type }}', {{ d.withdrawal_day|default:'null' }}, {{ d.is_withdrawal_end_of_month|yesno:'true,false' }}, {{ d.consider_holidays|yesno:'true,false' }}, {{ d.closing_day|default:'null' }}, {{ d.is_end_of_month|yesno:'true,false' }})">
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <form method="post" action="{% url 'budget_app:monthly_plan_default_delete' d.pk %}" class="delete-form inline">
                                {% csrf_token %}
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- モバイル表示：カード形式 - デフォルト金額が登録されている項目 -->
        {% if defaults_with_amount %}
        <h4 class="md:hidden text-lg font-bold mb-3 text-gray-800">金額設定済み</h4>
        <div class="md:hidden space-y-4 mb-6">
            {% for d in defaults_with_amount %}
            <div class="border-l-4 border-blue-400 rounded-r-lg p-4 bg-white shadow-md hover:shadow-lg transition" data-id="{{ d.id }}">
                <div class="mb-3">
                    <h4 class="font-bold text-base text-gray-800 mb-2">{{ d.title }}</h4>
                    <p class="text-lg font-bold text-blue-600 mb-2">¥{{ d.amount|stringformat:'d'|intcomma }}</p>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p class="flex gap-1 flex-wrap">
                            {% if d.payment_type == 'deposit' %}
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">振込</span>
                            {% else %}
                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">引落</span>
                            {% endif %}
                            {% if d.consider_holidays %}
                                {% if d.payment_type == 'deposit' %}
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">前営業日</span>
                                {% else %}
                                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">翌営業日</span>
                                {% endif %}
                            {% endif %}
                        </p>
                        {% if d.is_withdrawal_end_of_month %}
                            <p>
                                {% if d.payment_type == 'deposit' %}振込日{% else %}引落日{% endif %}:
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">末日</span>
                            </p>
                        {% elif d.withdrawal_day %}
                            <p>
                                {% if d.payment_type == 'deposit' %}振込日{% else %}引落日{% endif %}:
                                {{ d.withdrawal_day }}日
                            </p>
                        {% endif %}
                        {% if d.is_end_of_month %}
                            <p>締め日: <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">末日</span></p>
                        {% elif d.closing_day %}
                            <p>締め日: {{ d.closing_day }}日</p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" class="flex-1 bg-blue-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-blue-600 font-medium transition flex items-center justify-center gap-2" onclick="openDefaultEditModal({{ d.id }}, '{{ d.title|escapejs }}', {{ d.amount|default:0|stringformat:'d' }}, '{{ d.payment_type }}', {{ d.withdrawal_day|default:'null' }}, {{ d.is_withdrawal_end_of_month|yesno:'true,false' }}, {{ d.consider_holidays|yesno:'true,false' }}, {{ d.closing_day|default:'null' }}, {{ d.is_end_of_month|yesno:'true,false' }})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        編集
                    </button>
                    <button type="submit" form="delete-config-form-{{ d.pk }}" class="flex-1 bg-red-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-red-600 font-medium transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        削除
                    </button>
                    <form method="post" action="{% url 'budget_app:monthly_plan_default_delete' d.pk %}" class="delete-form" id="delete-config-form-{{ d.pk }}" style="display:none;">
                        {% csrf_token %}
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- モバイル表示：カード形式 - デフォルト金額が登録されていない項目 -->
        {% if defaults_without_amount %}
        <h4 class="md:hidden text-lg font-bold mb-3 text-gray-800">金額未設定</h4>
        <div class="md:hidden space-y-4 mb-6">
            {% for d in defaults_without_amount %}
            <div class="border-l-4 border-gray-400 rounded-r-lg p-4 bg-white shadow-md hover:shadow-lg transition" data-id="{{ d.id }}">
                <div class="mb-3">
                    <h4 class="font-bold text-base text-gray-800 mb-2">{{ d.title }}</h4>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p class="flex gap-1 flex-wrap">
                            {% if d.payment_type == 'deposit' %}
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">振込</span>
                            {% else %}
                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">引落</span>
                            {% endif %}
                            {% if d.consider_holidays %}
                                {% if d.payment_type == 'deposit' %}
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">前営業日</span>
                                {% else %}
                                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">翌営業日</span>
                                {% endif %}
                            {% endif %}
                        </p>
                        {% if d.is_withdrawal_end_of_month %}
                            <p>
                                {% if d.payment_type == 'deposit' %}振込日{% else %}引落日{% endif %}:
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">末日</span>
                            </p>
                        {% elif d.withdrawal_day %}
                            <p>
                                {% if d.payment_type == 'deposit' %}振込日{% else %}引落日{% endif %}:
                                {{ d.withdrawal_day }}日
                            </p>
                        {% endif %}
                        {% if d.is_end_of_month %}
                            <p>締め日: <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">末日</span></p>
                        {% elif d.closing_day %}
                            <p>締め日: {{ d.closing_day }}日</p>
                        {% endif %}
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" class="flex-1 bg-blue-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-blue-600 font-medium transition flex items-center justify-center gap-2" onclick="openDefaultEditModal({{ d.id }}, '{{ d.title|escapejs }}', {{ d.amount|default:0|stringformat:'d' }}, '{{ d.payment_type }}', {{ d.withdrawal_day|default:'null' }}, {{ d.is_withdrawal_end_of_month|yesno:'true,false' }}, {{ d.consider_holidays|yesno:'true,false' }}, {{ d.closing_day|default:'null' }}, {{ d.is_end_of_month|yesno:'true,false' }})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        編集
                    </button>
                    <button type="submit" form="delete-config-form-{{ d.pk }}" class="flex-1 bg-red-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-red-600 font-medium transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        削除
                    </button>
                    <form method="post" action="{% url 'budget_app:monthly_plan_default_delete' d.pk %}" class="delete-form" id="delete-config-form-{{ d.pk }}" style="display:none;">
                        {% csrf_token %}
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- デフォルト項目新規作成モーダル -->
    <div id="defaultCreateModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden">
            <!-- ヘッダー -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center sticky top-0 z-10">
                <h3 class="text-lg font-bold text-white">月次計画デフォルト新規追加</h3>
                <button type="button" onclick="closeDefaultCreateModal()" class="text-white hover:text-gray-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- ボディ -->
            <form id="defaultCreateForm" method="post" action="{% url 'budget_app:monthly_plan_defaults' %}" class="p-4 pb-6 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">{{ default_form.title.label }}</label>
                    {{ default_form.title }}
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">{{ default_form.amount.label }}</label>
                    {{ default_form.amount }}
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">{{ default_form.payment_type.label }}</label>
                    {{ default_form.payment_type }}
                    <p class="text-xs text-gray-500 mt-1">振込（給与など）または引き落とし（家賃など）</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">{{ default_form.withdrawal_day.label }}</label>
                    {{ default_form.withdrawal_day }}
                    <p class="text-xs text-gray-500 mt-1">引落日または振込日を設定する場合は1-31の数値を入力</p>
                </div>

                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        {{ default_form.is_withdrawal_end_of_month }}
                        <span class="ml-2 text-sm font-medium text-gray-700">{{ default_form.is_withdrawal_end_of_month.label }}</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">チェックすると引落日 / 振込日が月末になります</p>
                </div>

                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        {{ default_form.consider_holidays }}
                        <span class="ml-2 text-sm font-medium text-gray-700">{{ default_form.consider_holidays.label }}</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">振込:休日なら前営業日（金曜）、引落:休日なら翌営業日</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">{{ default_form.closing_day.label }}</label>
                    {{ default_form.closing_day }}
                    <p class="text-xs text-gray-500 mt-1">クレジットカードの場合のみ設定</p>
                </div>

                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        {{ default_form.is_end_of_month }}
                        <span class="ml-2 text-sm font-medium text-gray-700">{{ default_form.is_end_of_month.label }}</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">チェックすると締め日が月末になります</p>
                </div>

                <div class="flex gap-2 pt-3">
                    <button type="button" onclick="closeDefaultCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                        キャンセル
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                        追加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- デフォルト項目編集モーダル -->
    <div id="defaultEditModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden">
            <!-- ヘッダー -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center sticky top-0 z-10">
                <h3 class="text-lg font-bold text-white">デフォルト項目編集</h3>
                <button type="button" onclick="closeDefaultEditModal()" class="text-white hover:text-gray-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- ボディ -->
            <form id="defaultEditForm" method="post" action="{% url 'budget_app:monthly_plan_defaults' %}" class="p-4 pb-6 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="id" id="default_edit_id">

                <!-- 項目名 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">項目名</label>
                    <input type="text" name="title" id="default_edit_title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="例: 家賃" required>
                </div>

                <!-- 金額 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">デフォルト金額（円）</label>
                    <input type="number" name="amount" id="default_edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="50000">
                </div>

                <!-- 種別 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">種別</label>
                    <select name="payment_type" id="default_edit_payment_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                        <option value="withdrawal">引き落とし</option>
                        <option value="deposit">振込</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">振込（給与など）または引き落とし（家賃など）</p>
                </div>

                <!-- 引落日 / 振込日 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">引落日 / 振込日</label>
                    <input type="number" name="withdrawal_day" id="default_edit_withdrawal_day" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="1" max="31" placeholder="1-31">
                    <p class="text-xs text-gray-500 mt-1">引落日または振込日を設定する場合は1-31の数値を入力</p>
                </div>

                <!-- 引落日 / 振込日を月末にする -->
                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" name="is_withdrawal_end_of_month" id="default_edit_is_withdrawal_end_of_month" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">引落日 / 振込日を月末にする</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">チェックすると引落日 / 振込日が月末になります</p>
                </div>

                <!-- 休日を考慮 -->
                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" name="consider_holidays" id="default_edit_consider_holidays" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">休日を考慮</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">引落日 / 振込日が休日の場合、翌営業日に調整</p>
                </div>

                <!-- 締め日 -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">締め日（クレカの場合）</label>
                    <input type="number" name="closing_day" id="default_edit_closing_day" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="1" max="31" placeholder="1-31">
                    <p class="text-xs text-gray-500 mt-1">クレジットカードの場合のみ設定</p>
                </div>

                <!-- 締め日を月末にする -->
                <div>
                    <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" name="is_end_of_month" id="default_edit_is_end_of_month" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium text-gray-700">締め日を月末にする</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">チェックすると締め日が月末になります</p>
                </div>

                <!-- ボタン -->
                <div class="flex gap-2 pt-3">
                    <button type="button" onclick="closeDefaultEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                        キャンセル
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <hr class="my-8 border-gray-200">

    <!-- 貯蓄設定セクション -->
    <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4">貯蓄設定</h3>

        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <div class="flex items-center mb-4">
                    {{ form.savings_enabled }}
                    <label class="ml-2 text-gray-700 font-bold">{{ form.savings_enabled.label }}</label>
                </div>
                {% if form.savings_enabled.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.savings_enabled.errors.0 }}</p>
                {% endif %}

                <div id="savings_fields" class="ml-6">
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <div>
                            <label class="block text-gray-600 text-sm mb-1">{{ form.savings_amount.label }}</label>
                            {{ form.savings_amount }}
                            {% if form.savings_amount.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.savings_amount.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-gray-600 text-sm mb-1">{{ form.savings_day.label }}</label>
                            {{ form.savings_day }}
                            {% if form.savings_day.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.savings_day.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-600 text-sm mb-1">{{ form.savings_year.label }}</label>
                            {{ form.savings_year }}
                            {% if form.savings_year.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.savings_year.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-gray-600 text-sm mb-1">{{ form.savings_month.label }}</label>
                            {{ form.savings_month }}
                            {% if form.savings_month.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.savings_month.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {{ form.savings_start_month }}
                    {% if form.savings_start_month.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.savings_start_month.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium shadow-md transition text-sm">
                保存
            </button>
        </form>
    </div>

</div>

<script>
// デフォルト項目新規作成モーダル制御関数
function openDefaultCreateModal() {
    const modal = document.getElementById('defaultCreateModal');
    modal.classList.remove('hidden');

    // フォームをリセット
    const form = document.getElementById('defaultCreateForm');
    if (form) {
        form.reset();
    }
}

function closeDefaultCreateModal() {
    document.getElementById('defaultCreateModal').classList.add('hidden');
}

// 新規作成フォームの締め日・引落日のチェックボックス処理を初期化
function initializeCreateFormCheckboxes() {
    // 引落日チェックボックス
    const createIsWithdrawalEndOfMonthCheckbox = document.getElementById('id_is_withdrawal_end_of_month');
    const createWithdrawalDayInput = document.getElementById('id_withdrawal_day');

    if (createIsWithdrawalEndOfMonthCheckbox && createWithdrawalDayInput) {
        // 現在の状態に応じて初期化
        if (createIsWithdrawalEndOfMonthCheckbox.checked) {
            createWithdrawalDayInput.disabled = true;
            createWithdrawalDayInput.value = '';
            createWithdrawalDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
            createWithdrawalDayInput.disabled = false;
            createWithdrawalDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    }

    // 締め日チェックボックス
    const createIsEndOfMonthCheckbox = document.getElementById('id_is_end_of_month');
    const createClosingDayInput = document.getElementById('id_closing_day');

    if (createIsEndOfMonthCheckbox && createClosingDayInput) {
        // 現在の状態に応じて初期化
        if (createIsEndOfMonthCheckbox.checked) {
            createClosingDayInput.disabled = true;
            createClosingDayInput.value = '';
            createClosingDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
            createClosingDayInput.disabled = false;
            createClosingDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    }
}

function toggleDefaultCreateForm() {
    const formSection = document.getElementById('defaultCreateFormSection');
    const toggleIcon = document.getElementById('toggleDefaultIcon');

    formSection.classList.toggle('hidden');
    toggleIcon.classList.toggle('rotate-180');

    // フォームを開いた時にチェックボックスの状態を初期化
    if (!formSection.classList.contains('hidden')) {
        initializeCreateFormCheckboxes();
    }
}

function openDefaultEditModal(id, title, amount, paymentType, withdrawalDay, isWithdrawalEndOfMonth, considerHolidays, closingDay, isEndOfMonth) {
    const modal = document.getElementById('defaultEditModal');

    // フォームのフィールドに値を設定
    document.getElementById('default_edit_id').value = id;
    document.getElementById('default_edit_title').value = title;
    document.getElementById('default_edit_amount').value = amount;
    document.getElementById('default_edit_payment_type').value = paymentType;
    document.getElementById('default_edit_withdrawal_day').value = withdrawalDay !== null ? withdrawalDay : '';
    document.getElementById('default_edit_is_withdrawal_end_of_month').checked = isWithdrawalEndOfMonth;
    document.getElementById('default_edit_consider_holidays').checked = considerHolidays;
    document.getElementById('default_edit_closing_day').value = closingDay !== null ? closingDay : '';
    document.getElementById('default_edit_is_end_of_month').checked = isEndOfMonth;

    // 引落日入力フォームの有効/無効を設定
    toggleWithdrawalDayInput();
    // 締め日入力フォームの有効/無効を設定
    toggleClosingDayInput();

    modal.classList.remove('hidden');
}

function closeDefaultEditModal() {
    document.getElementById('defaultEditModal').classList.add('hidden');
}

function toggleWithdrawalDayInput() {
    const isWithdrawalEndOfMonthCheckbox = document.getElementById('default_edit_is_withdrawal_end_of_month');
    const withdrawalDayInput = document.getElementById('default_edit_withdrawal_day');

    if (isWithdrawalEndOfMonthCheckbox && withdrawalDayInput) {
        if (isWithdrawalEndOfMonthCheckbox.checked) {
            withdrawalDayInput.disabled = true;
            withdrawalDayInput.value = '';
            withdrawalDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
            withdrawalDayInput.disabled = false;
            withdrawalDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    }
}

function toggleClosingDayInput() {
    const isEndOfMonthCheckbox = document.getElementById('default_edit_is_end_of_month');
    const closingDayInput = document.getElementById('default_edit_closing_day');

    if (isEndOfMonthCheckbox && closingDayInput) {
        if (isEndOfMonthCheckbox.checked) {
            closingDayInput.disabled = true;
            closingDayInput.value = '';
            closingDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
            closingDayInput.disabled = false;
            closingDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const savingsEnabledCheckbox = document.getElementById('savings_enabled_checkbox');
    const savingsFields = document.getElementById('savings_fields');
    const savingsAmountField = document.getElementById('savings_amount_field');
    const savingsYearSelect = document.querySelector('select[name="savings_year"]');
    const savingsMonthSelect = document.querySelector('select[name="savings_month"]');

    function toggleSavingsFields() {
        if (!savingsEnabledCheckbox) return;

        const isEnabled = savingsEnabledCheckbox.checked;

        // 見た目を変更
        if (isEnabled) {
            if (savingsFields) savingsFields.classList.remove('opacity-50');
        } else {
            if (savingsFields) savingsFields.classList.add('opacity-50');
        }
    }

    // 初期状態を設定
    if (savingsEnabledCheckbox) {
        toggleSavingsFields();
        // チェックボックスの変更を監視
        savingsEnabledCheckbox.addEventListener('change', toggleSavingsFields);
    }

    // 編集モーダルの引落日チェックボックス
    const editIsWithdrawalEndOfMonthCheckbox = document.getElementById('default_edit_is_withdrawal_end_of_month');
    if (editIsWithdrawalEndOfMonthCheckbox) {
        editIsWithdrawalEndOfMonthCheckbox.addEventListener('change', toggleWithdrawalDayInput);
    }

    // 編集モーダルの締め日チェックボックス
    const editIsEndOfMonthCheckbox = document.getElementById('default_edit_is_end_of_month');
    if (editIsEndOfMonthCheckbox) {
        editIsEndOfMonthCheckbox.addEventListener('change', toggleClosingDayInput);
    }

    // 新規作成フォームの引落日チェックボックス
    const createIsWithdrawalEndOfMonthCheckbox = document.getElementById('id_is_withdrawal_end_of_month');
    const createWithdrawalDayInput = document.getElementById('id_withdrawal_day');

    if (createIsWithdrawalEndOfMonthCheckbox && createWithdrawalDayInput) {
        createIsWithdrawalEndOfMonthCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createWithdrawalDayInput.disabled = true;
                createWithdrawalDayInput.value = '';
                createWithdrawalDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                createWithdrawalDayInput.disabled = false;
                createWithdrawalDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            }
        });
    }

    // 新規作成フォームの締め日チェックボックス
    const createIsEndOfMonthCheckbox = document.getElementById('id_is_end_of_month');
    const createClosingDayInput = document.getElementById('id_closing_day');

    if (createIsEndOfMonthCheckbox && createClosingDayInput) {
        createIsEndOfMonthCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createClosingDayInput.disabled = true;
                createClosingDayInput.value = '';
                createClosingDayInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                createClosingDayInput.disabled = false;
                createClosingDayInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            }
        });
    }

    // 背景クリックでモーダルを閉じる
    const createModal = document.getElementById('defaultCreateModal');
    const editModal = document.getElementById('defaultEditModal');

    if (createModal) {
        createModal.addEventListener('click', function(e) {
            if (e.target === this) closeDefaultCreateModal();
        });
    }

    if (editModal) {
        editModal.addEventListener('click', function(e) {
            if (e.target === this) closeDefaultEditModal();
        });
    }

    // CSRFトークンを取得
    const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfTokenElement) {
        const csrfToken = csrfTokenElement.value;

        // --- フォームの非同期処理 ---
        const handleFormSubmit = async (form, isDelete = false) => {
            if (isDelete && !confirm('本当に削除しますか？')) {
                return;
            }

            const actionUrl = form.getAttribute('action');
            const formData = new FormData(form);

            await window.sendAjaxRequest(actionUrl, formData, {
                closeModal: form.id === 'defaultCreateForm' ? closeDefaultCreateModal : (form.id === 'defaultEditForm' ? closeDefaultEditModal : null),
                reloadDelay: 800
            });
        };

        // イベントリスナーを設定
        const defaultCreateForm = document.getElementById('defaultCreateForm');
        if (defaultCreateForm) {
            defaultCreateForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.currentTarget); });
        }

        const defaultEditForm = document.getElementById('defaultEditForm');
        if (defaultEditForm) {
            defaultEditForm.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.currentTarget); });
        }
        document.querySelectorAll('.delete-form').forEach(form => {
            form.addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.currentTarget, true); });
        });
    }

    // Djangoメッセージをトーストとして表示
    {% if messages %}
        {% for message in messages %}
            if (typeof window.showToast === 'function') {
                window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
            } else {
                console.error('window.showToast is not defined');
                alert("{{ message|escapejs }}");
            }
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
