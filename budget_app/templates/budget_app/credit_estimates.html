{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-4 md:mb-6 flex justify-between items-center">
        <h2 class="text-2xl md:text-3xl font-bold">ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Š</h2>
        <button onclick="openCreateModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
            æ–°è¦è¿½åŠ 
        </button>
    </div>

    <div class="mt-10">
        {% comment %} ç™»éŒ²æ¸ˆã¿è¦‹ç©ã‚‚ã‚Šã‚’è¡¨ç¤º {% endcomment %}

        <div class="space-y-8">
            {% include 'budget_app/_summary_section.html' with summary_data=future_summary title='æœªæ¥' %}
        </div>

        {% if not future_summary %}
            <!-- ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                <p class="text-gray-600 text-lg font-medium">ã¾ã ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Šã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                <p class="text-gray-500 text-sm mt-2">å³ä¸Šã®ã€Œæ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Šã‚’è¿½åŠ ã§ãã¾ã™</p>
            </div>
        {% else %}
        {% endif %}
    </div>
</div>

<!-- æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">è¦‹ç©ã‚Šæ–°è¦è¿½åŠ </h3>
            <button type="button" onclick="closeCreateModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="createEstimateForm" method="post" class="p-4 pb-6 space-y-4" data-year-month-form>
            {% csrf_token %}
            <input type="hidden" name="action" value="create_estimate">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.card_type.label }}</label>
                <select name="card_type" id="create_card_type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    {% for card in card_choices %}
                    <option value="{{ card.key }}"{% if forloop.first %} selected{% endif %}>{{ card.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.description.label }}</label>
                {{ form.description }}
            </div>

            <!-- é‡‘é¡å…¥åŠ› -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="create_estimate_amount_label">é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="create_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('create')">
                        <span>ğŸ’µ ãƒ‰ãƒ«</span>
                    </label>
                </div>
                <!-- å††å…¥åŠ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰ -->
                <div id="create_estimate_jpy_input">
                    <input type="number" name="amount" id="create_estimate_amount_jpy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- ãƒ‰ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <div id="create_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="create_estimate_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.purchase_date.label }}</label>
                {{ form.purchase_date }}
            </div>

            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_split_payment_wrapper">
                    {{ form.is_split_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_split_payment.label }}</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_bonus_payment_wrapper">
                    {{ form.is_bonus_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_bonus_payment.label }}</span>
                </label>
            </div>

            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    è¿½åŠ 
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¢ãƒ€ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">è¦‹ç©ã‚Šç·¨é›†</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="card_type" id="edit_card_type_hidden" disabled>

            <!-- ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</label>
                <div class="grid grid-cols-2 gap-2">
                    {% for card in card_choices %}
                    <label class="relative cursor-pointer card-type-label" data-value="{{ card.key }}">
                        <input type="radio" name="card_type" value="{{ card.key }}" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">{{ card.title }}</span>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
                <!-- åˆ†å‰²æ‰•ã„ã®å ´åˆã®æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <p id="edit_split_payment_notice" class="text-sm text-amber-600 mt-2 hidden">
                    <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    åˆ†å‰²æ‰•ã„ã®ãŸã‚ã€ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã¯å¤‰æ›´ã§ãã¾ã›ã‚“
                </p>
            </div>

            <!-- å†…å®¹ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">å†…å®¹</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="ä¾‹: æ—…è¡Œã€å®¶é›»ãªã©">
            </div>

            <!-- é‡‘é¡å…¥åŠ› -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="edit_estimate_amount_label">é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="edit_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('edit')">
                        <span>ğŸ’µ ãƒ‰ãƒ«</span>
                    </label>
                </div>
                <!-- å††å…¥åŠ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰ -->
                <div id="edit_estimate_jpy_input">
                    <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- ãƒ‰ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <div id="edit_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="edit_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <!-- åˆ©ç”¨æ—¥ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">åˆ©ç”¨æ—¥</label>
                <input type="date" name="purchase_date" id="edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" required>
            </div>

            <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">åˆ†å‰²2å›æ‰•ã„</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„</span>
                </label>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¢ãƒ€ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ -->
<div id="defaultEditModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">å®šæœŸé …ç›®ç·¨é›†</h3>
            <button type="button" onclick="closeDefaultEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="defaultEditForm" method="post" action="{% url 'budget_app:credit_estimates' %}" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_default">
            <input type="hidden" name="id" id="default_edit_id">
            <input type="hidden" name="label" id="default_edit_hidden_label">
            <input type="hidden" name="year_month" id="default_edit_year_month">

            <!-- é …ç›®å -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">é …ç›®å</label>
                <input type="text" id="default_edit_label" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-sm" readonly>
            </div>

            <!-- ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</label>
                <div class="grid grid-cols-2 gap-2">
                    {% for card in card_choices %}
                    <label class="relative cursor-pointer default-card-type-label" data-value="{{ card.key }}">
                        <input type="radio" name="card_type" value="{{ card.key }}" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">{{ card.title }}</span>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- é‡‘é¡å…¥åŠ› -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="default_edit_estimate_amount_label">é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="default_edit_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('default_edit')">
                        <span>ğŸ’µ ãƒ‰ãƒ«</span>
                    </label>
                </div>
                <!-- å††å…¥åŠ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰ -->
                <div id="default_edit_estimate_jpy_input">
                    <input type="number" name="amount" id="default_edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- ãƒ‰ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <div id="default_edit_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="default_edit_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <!-- åˆ©ç”¨æ—¥ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">åˆ©ç”¨æ—¥</label>
                <input type="date" name="purchase_date" id="default_edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" required>
            </div>

            <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            <div>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                    <input type="checkbox" name="is_split_payment" id="default_edit_is_split_payment" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">åˆ†å‰²2å›æ‰•ã„</span>
                </label>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeDefaultEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 font-medium transition shadow-md text-sm">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // é€šè²¨å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function toggleEstimateCurrencyInput(mode) {
        // mode: 'create', 'edit', 'default_edit'
        const isUsdCheckbox = document.getElementById(`${mode}_estimate_is_usd`);
        const jpyInput = document.getElementById(`${mode}_estimate_jpy_input`);
        const usdInput = document.getElementById(`${mode}_estimate_usd_input`);
        const label = document.getElementById(`${mode}_estimate_amount_label`);

        if (isUsdCheckbox && jpyInput && usdInput) {
            const jpyField = jpyInput.querySelector('input');
            const usdField = usdInput.querySelector('input');
            if (isUsdCheckbox.checked) {
                jpyInput.classList.add('hidden');
                usdInput.classList.remove('hidden');
                if (jpyField) { jpyField.disabled = true; jpyField.value = ''; }
                if (usdField) usdField.disabled = false;
                if (label) label.textContent = 'é‡‘é¡ï¼ˆãƒ‰ãƒ«ï¼‰';
            } else {
                jpyInput.classList.remove('hidden');
                usdInput.classList.add('hidden');
                if (jpyField) jpyField.disabled = false;
                if (usdField) { usdField.disabled = true; usdField.value = ''; }
                if (label) label.textContent = 'é‡‘é¡ï¼ˆå††ï¼‰';
            }
        }
    }

    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•°
    function openCreateModal() {
        const modal = document.getElementById('createModal');
        modal.classList.remove('hidden');

        // åˆ†å‰²ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
        if (typeof toggleCreatePaymentOptions === 'function') {
            toggleCreatePaymentOptions();
        }
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•°
    function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        form.action = `/credit-estimates/${pk}/edit/`;

        // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’è¨­å®šï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å½¢å¼ï¼‰
        const cardTypeHidden = document.getElementById('edit_card_type_hidden');

        // åˆ†å‰²æ‰•ã„ã®å ´åˆã¯hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        if (isSplitPayment) {
            cardTypeHidden.disabled = false;
            cardTypeHidden.value = cardType;
        } else {
            cardTypeHidden.disabled = true;
            cardTypeHidden.value = '';
        }

        document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.card-type-label');
            const box = label.querySelector('.card-type-box');
            const indicator = label.querySelector('.radio-indicator');
            const dot = label.querySelector('.radio-dot');

            // åˆ†å‰²æ‰•ã„ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’å¤‰æ›´ä¸å¯ã«ã™ã‚‹
            if (isSplitPayment) {
                radio.disabled = true;
                label.classList.remove('cursor-pointer');
                label.classList.add('cursor-not-allowed', 'opacity-60');
            } else {
                radio.disabled = false;
                label.classList.add('cursor-pointer');
                label.classList.remove('cursor-not-allowed', 'opacity-60');
            }

            if (radio.checked) {
                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-blue-600', 'bg-blue-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-blue-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_amount').value = amount;

        // åˆ©ç”¨æ—¥ã‚’è¨­å®šï¼ˆåˆ©ç”¨æ—¥ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°dueDateï¼‰
        if (purchaseDate) {
            document.getElementById('edit_purchase_date').value = purchaseDate;
        } else if (dueDate) {
            document.getElementById('edit_purchase_date').value = dueDate;
        }

        document.getElementById('edit_is_split_payment').checked = isSplitPayment;
        document.getElementById('edit_is_bonus_payment').checked = isBonusPayment;

        // åˆ†å‰²æ‰•ã„ã®å ´åˆã®æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚’æ›´æ–°
        const splitNotice = document.getElementById('edit_split_payment_notice');
        if (splitNotice) {
            if (isSplitPayment) {
                splitNotice.classList.remove('hidden');
            } else {
                splitNotice.classList.add('hidden');
            }
        }

        // åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
        if (typeof window.toggleEditPaymentOptions === 'function') {
            window.toggleEditPaymentOptions();
        }

        // æœ€å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate) {
        const modal = document.getElementById('defaultEditModal');

        // é‡‘é¡ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸå ´åˆï¼‰
        const numericAmount = typeof amount === 'string' ? parseInt(amount.replace(/,/g, ''), 10) : amount;

        console.log('openDefaultEditModal called with:', { id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate, numericAmount });

        // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’è¨­å®šï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å½¢å¼ï¼‰
        document.querySelectorAll('#defaultEditModal .default-card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.default-card-type-label');
            const box = label.querySelector('.default-card-type-box');
            const indicator = label.querySelector('.default-radio-indicator');
            const dot = label.querySelector('.default-radio-dot');

            if (radio.checked) {
                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-green-600', 'bg-green-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-green-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
        document.getElementById('default_edit_id').value = id;
        document.getElementById('default_edit_label').value = label;
        document.getElementById('default_edit_year_month').value = yearMonth;
        document.getElementById('default_edit_hidden_label').value = label; // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚å€¤ã‚’è¨­å®š
        document.getElementById('default_edit_amount').value = numericAmount;
        document.getElementById('default_edit_is_split_payment').checked = isSplitPayment || false;
        document.getElementById('default_edit_purchase_date').value = purchaseDate || '';

        // æœ€å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.remove('hidden');
    }

    function closeDefaultEditModal() {
        document.getElementById('defaultEditModal').classList.add('hidden');
    }

    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.getElementById('createModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeCreateModal();
    });

    document.getElementById('editModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    document.getElementById('defaultEditModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeDefaultEditModal();
    });

    document.addEventListener('DOMContentLoaded', () => {
        // é€šå¸¸é …ç›®ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll('#editModal .card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.card-type-radio');
                const cardType = radio.value;

                // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('#editModal .card-type-label').forEach(l => {
                    const r = l.querySelector('.card-type-radio');
                    const box = l.querySelector('.card-type-box');
                    const indicator = l.querySelector('.radio-indicator');
                    const dot = l.querySelector('.radio-dot');

                    r.checked = false;
                    box.classList.remove('border-blue-600', 'bg-blue-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-blue-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’é¸æŠçŠ¶æ…‹ã«
                radio.checked = true;
                const box = this.querySelector('.card-type-box');
                const indicator = this.querySelector('.radio-indicator');
                const dot = this.querySelector('.radio-dot');

                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');

                // åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
                if (typeof window.toggleEditPaymentOptions === 'function') {
                    window.toggleEditPaymentOptions();
                }
            });
        });

        // å®šæœŸé …ç›®ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.default-card-type-radio');

                // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(l => {
                    const r = l.querySelector('.default-card-type-radio');
                    const box = l.querySelector('.default-card-type-box');
                    const indicator = l.querySelector('.default-radio-indicator');
                    const dot = l.querySelector('.default-radio-dot');

                    r.checked = false;
                    box.classList.remove('border-green-600', 'bg-green-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-green-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’é¸æŠçŠ¶æ…‹ã«
                radio.checked = true;
                const box = this.querySelector('.default-card-type-box');
                const indicator = this.querySelector('.default-radio-indicator');
                const dot = this.querySelector('.default-radio-dot');

                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            });
        });

        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šã®æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
        document.querySelectorAll('[data-toggle-estimate]').forEach(function(header) {
            const ym = header.getAttribute('data-toggle-estimate');

            header.addEventListener('click', function() {
                const desktopContent = document.getElementById('estimate-content-' + ym);
                const mobileContent = document.getElementById('estimate-content-mobile-' + ym);
                const icon = document.getElementById('collapse-icon-' + ym);

                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ»ãƒ¢ãƒã‚¤ãƒ«ä¸¡æ–¹ï¼šcollapsedã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«
                if (desktopContent) {
                    desktopContent.classList.toggle('collapsed');
                }

                // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºï¼šå€‹åˆ¥é …ç›®ãƒªã‚¹ãƒˆã®ã¿ã‚’ãƒˆã‚°ãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å¸¸ã«è¡¨ç¤ºï¼‰
                if (mobileContent) {
                    const cardDetailsMobile = mobileContent.querySelectorAll('.card-details-mobile');
                    cardDetailsMobile.forEach(details => {
                        details.classList.toggle('hidden');
                    });
                }

                if (icon) {
                    icon.classList.toggle('rotate-180');
                }
            });
        });

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ãé–¢æ•°ï¼ˆã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šãƒšãƒ¼ã‚¸ã§ã¯åˆæœŸçŠ¶æ…‹ã§å…¨ã¦é–‹ã„ã¦ã„ã‚‹ã®ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã¿ï¼‰
        function expandEstimateSection(hash) {
            if (hash && hash.startsWith('#estimate-content-')) {
                // ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰å¹´æœˆã‚’æŠ½å‡ºï¼ˆä¾‹ï¼š#estimate-content-2025-12 â†’ 2025-12ï¼‰
                const yearMonth = hash.replace('#estimate-content-', '').replace('-mobile', '');

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å…ˆã«ã™ã‚‹ï¼ˆå¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
                const targetElement = document.querySelector(`[data-toggle-estimate="${yearMonth}"]`);

                if (targetElement) {
                    setTimeout(() => {
                        const header = document.querySelector('nav');
                        const headerHeight = header ? header.offsetHeight : 0;
                        const elementPosition = targetElement.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    }, 200);
                }
            }
        }

        // sessionStorageã‹ã‚‰ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å–å¾—ï¼ˆcommon.jsã§ãƒªãƒ­ãƒ¼ãƒ‰å‰ã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
        const savedAnchor = sessionStorage.getItem('scrollToAnchor');
        if (savedAnchor) {
            // URLã®ãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
            window.location.hash = savedAnchor;
            // sessionStorageã‚’ã‚¯ãƒªã‚¢ï¼ˆbase.htmlã§ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚ï¼‰
            sessionStorage.removeItem('scrollToAnchor');
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
            expandEstimateSection(savedAnchor);
        } else {
            // URLã®ãƒãƒƒã‚·ãƒ¥ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€è©²å½“ã™ã‚‹æœˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•çš„ã«é–‹ã
            expandEstimateSection(window.location.hash);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆbase.htmlã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã®å¾Œã«å®Ÿè¡Œï¼‰
        window.addEventListener('load', function() {
            // å°‘ã—é…å»¶ã•ã›ã¦ã€base.htmlã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
            setTimeout(() => {
                const hash = window.location.hash;
                if (hash) {
                    expandEstimateSection(hash);
                }
            }, 400);
        });

        // ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¨åˆ†å‰²æ‰•ã„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆæ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
        const createCardTypeSelect = document.getElementById('create_card_type');
        const createBonusWrapper = document.getElementById('create_bonus_payment_wrapper');
        const createSplitWrapper = document.getElementById('create_split_payment_wrapper');
        const createBonusCheckbox = document.getElementById('id_is_bonus_payment');
        const createSplitCheckbox = document.getElementById('id_is_split_payment');

        window.toggleCreatePaymentOptions = function() {
            const isViewCard = createCardTypeSelect.value === 'item_6';

            // åˆ†å‰²æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
            if (createSplitWrapper) {
                createSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createSplitCheckbox) {
                    createSplitCheckbox.checked = false;
                }
            }

            // ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
            if (createBonusWrapper) {
                createBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createBonusCheckbox) {
                    createBonusCheckbox.checked = false;
                }
            }
        }

        if (createCardTypeSelect) {
            createCardTypeSelect.addEventListener('change', function() {
                window.toggleCreatePaymentOptions();
            });
            window.toggleCreatePaymentOptions(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        }

        // åˆ†å‰²ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®æ’ä»–åˆ¶å¾¡
        if (createSplitCheckbox && createBonusCheckbox) {
            createSplitCheckbox.addEventListener('change', function() {
                if (this.checked && createBonusCheckbox.checked) {
                    createBonusCheckbox.checked = false;
                }
            });
            createBonusCheckbox.addEventListener('change', function() {
                if (this.checked && createSplitCheckbox.checked) {
                    createSplitCheckbox.checked = false;
                }
            });
        }

        // åˆ†å‰²æ‰•ã„ã¨ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
        const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
        const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
        const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');
        const editSplitCheckbox = document.getElementById('edit_is_split_payment');

        window.toggleEditPaymentOptions = function() {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’å–å¾—ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰
            const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
            const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

            // åˆ†å‰²æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
            if (editSplitWrapper) {
                editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editSplitCheckbox) {
                    editSplitCheckbox.checked = false;
                }
            }

            // ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
            if (editBonusWrapper) {
                editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editBonusCheckbox) {
                    editBonusCheckbox.checked = false;
                }
            }
        }

        // åˆ†å‰²ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®æ’ä»–åˆ¶å¾¡ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
        if (editSplitCheckbox && editBonusCheckbox) {
            editSplitCheckbox.addEventListener('change', function() {
                if (this.checked && editBonusCheckbox.checked) {
                    editBonusCheckbox.checked = false;
                }
            });
            editBonusCheckbox.addEventListener('change', function() {
                if (this.checked && editSplitCheckbox.checked) {
                    editSplitCheckbox.checked = false;
                }
            });
        }

        // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿®æ­£
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - datasetå…¨ä½“:', this.dataset);
                const pk = this.dataset.pk;
                const yearMonth = this.dataset.yearMonth;
                const cardType = this.dataset.cardType;
                const description = this.dataset.description;
                const amount = this.dataset.amount;
                const dueDate = this.dataset.dueDate;
                const purchaseDate = this.dataset.purchaseDate;
                const isSplit = this.dataset.split === 'true';
                const isBonus = this.dataset.bonus === 'true';

                console.log('å–å¾—ã—ãŸcardType:', cardType);
                openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplit, isBonus);
            });
        });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.default-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('å®šæœŸç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - datasetå…¨ä½“:', this.dataset);
                const id = this.dataset.defaultId;
                const label = this.dataset.label;
                const amount = this.dataset.amount;
                const cardType = this.dataset.cardType;
                const yearMonth = this.dataset.yearMonth;
                const isSplit = this.dataset.split === 'true';
                const purchaseDate = this.dataset.purchaseDate;

                console.log('å–å¾—ã—ãŸcardType:', cardType, 'purchaseDate:', purchaseDate);
                openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplit, purchaseDate);
            });
        });

        // --- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç† ---
        const createForm = document.getElementById('createEstimateForm');
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(createForm), {
                closeModal: closeCreateModal
            });
        });

        // --- è¦‹ç©ã‚Šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç† ---
        const editForm = document.getElementById('editForm');
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);

            await window.sendAjaxRequest(editForm.action, formData, {
                closeModal: closeEditModal
                // target_urlã®å‡¦ç†ã¯sendAjaxRequestå†…ã§è‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹ï¼ˆsessionStorageä¿å­˜â†’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
            });
        });

        // --- å®šæœŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç† ---
        const defaultEditForm = document.getElementById('defaultEditForm');
        defaultEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(defaultEditForm), {
                closeModal: closeDefaultEditModal
            });
        });

        // --- ã‚«ãƒ¼ãƒ‰ã”ã¨ã®åæ˜ ãƒœã‚¿ãƒ³ã®éåŒæœŸå‡¦ç† ---
        document.querySelectorAll('.reflect-card-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã®åˆè¨ˆé¡ã‚’æœˆæ¬¡è¨ˆç”»ã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form), {
                    toastDuration: 3000,  // 3ç§’è¡¨ç¤º
                    reloadOnSuccess: true  // è‡ªå‹•çš„ã«æœˆæ¬¡è¨ˆç”»ãƒšãƒ¼ã‚¸ã¸é·ç§»
                });
            });
        });

        // --- å‰Šé™¤ãƒœã‚¿ãƒ³ã®éåŒæœŸå‡¦ç† ---
        document.querySelectorAll('form[action*="/credit-estimates/delete/"]').forEach(deleteForm => {
            deleteForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const isRecurring = deleteForm.dataset.recurring === 'true';
                let confirmed = false;
                let deleteType = 'single';

                if (isRecurring) {
                    confirmed = confirm('ã“ã®é …ç›®ã¯å®šæœŸçš„ãªè¦‹ç©ã‚‚ã‚Šã§ã™ã€‚ã“ã®æœˆã®è¦‹ç©ã‚‚ã‚Šã®ã¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€ã§ã“ã®æœˆã®ã¿å‰Šé™¤ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ä¸­æ­¢ã—ã¾ã™ã€‚');
                    if (confirmed) {
                        deleteType = 'single';
                    }
                } else {
                    confirmed = confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
                }

                if (!confirmed) return;

                const formData = new FormData();
                formData.append('delete_type', deleteType);

                await window.sendAjaxRequest(deleteForm.action, formData);
            });
        });

        // --- å®šæœŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã®å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç† ---
        document.querySelectorAll('.delete-default-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!confirm('ã“ã®æœˆã®å®šæœŸé …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form));
            });
        });

        // å¹´æœˆãƒ•ã‚©ãƒ¼ãƒ ã®åŒæœŸ
        document.querySelectorAll('[data-year-month-form]').forEach(form => {
            const yearSelect = form.querySelector('[data-year-select]');
            const monthSelect = form.querySelector('[data-month-select]');
            const target = form.querySelector('[data-year-month]');

            const sync = () => {
                if (yearSelect && monthSelect && target) {
                    target.value = `${yearSelect.value}-${monthSelect.value}`;
                }
            };

            sync();
            yearSelect?.addEventListener('change', sync);
            monthSelect?.addEventListener('change', sync);
        });
    });
</script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Djangoã®messagesãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒˆãƒ¼ã‚¹ãƒˆã§è¡¨ç¤º
    {% for message in messages %}
        window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}
});
</script>
{% endblock %}
{% endblock %}
