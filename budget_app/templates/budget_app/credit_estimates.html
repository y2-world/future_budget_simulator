{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-4 md:mb-6 flex justify-between items-center">
        <h2 class="text-2xl md:text-3xl font-bold">„ÇØ„É¨„Ç´Ë¶ãÁ©ç„Çä</h2>
        <button onclick="openCreateModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
            Êñ∞Ë¶èËøΩÂä†
        </button>
    </div>

    <div class="mt-10">
        {% comment %} ÁôªÈå≤Ê∏à„ÅøË¶ãÁ©ç„ÇÇ„Çä„ÇíË°®Á§∫ {% endcomment %}

        <div class="space-y-8">
            {% include 'budget_app/_summary_section.html' with summary_data=future_summary title='Êú™Êù•' %}
        </div>

        {% if not future_summary %}
            <!-- „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ -->
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                <p class="text-gray-600 text-lg font-medium">„Åæ„Å†„ÇØ„É¨„Ç´Ë¶ãÁ©ç„Çä„ÅØÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                <p class="text-gray-500 text-sm mt-2">Âè≥‰∏ä„ÅÆ„ÄåÊñ∞Ë¶èËøΩÂä†„Äç„Éú„Çø„É≥„Åã„Çâ„ÇØ„É¨„Ç´Ë¶ãÁ©ç„Çä„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô</p>
            </div>
        {% else %}
        {% endif %}
    </div>
</div>

<!-- Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">Ë¶ãÁ©ç„ÇäÊñ∞Ë¶èËøΩÂä†</h3>
            <button type="button" onclick="closeCreateModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- „Éú„Éá„Ç£ -->
        <form id="createEstimateForm" method="post" class="p-4 pb-6 space-y-4" data-year-month-form>
            {% csrf_token %}
            <input type="hidden" name="action" value="create_estimate">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.card_type.label }}</label>
                <select name="card_type" id="create_card_type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    {% for card in card_choices %}
                    <option value="{{ card.key }}"{% if forloop.first %} selected{% endif %}>{{ card.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.description.label }}</label>
                {{ form.description }}
            </div>

            <!-- ÈáëÈ°çÂÖ•Âäõ -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="create_estimate_amount_label">ÈáëÈ°çÔºàÂÜÜÔºâ</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="create_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('create')">
                        <span>üíµ „Éâ„É´</span>
                    </label>
                </div>
                <!-- ÂÜÜÂÖ•ÂäõÔºà„Éá„Éï„Ç©„É´„ÉàË°®Á§∫Ôºâ -->
                <div id="create_estimate_jpy_input">
                    <input type="number" name="amount" id="create_estimate_amount_jpy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- „Éâ„É´ÂÖ•ÂäõÔºàÈùûË°®Á§∫Ôºâ -->
                <div id="create_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="create_estimate_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.purchase_date.label }}</label>
                {{ form.purchase_date }}
            </div>

            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_split_payment_wrapper">
                    {{ form.is_split_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_split_payment.label }}</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_bonus_payment_wrapper">
                    {{ form.is_bonus_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_bonus_payment.label }}</span>
                </label>
            </div>

            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    ËøΩÂä†
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´Ôºà„É¢„ÉÄ„É≥„Éá„Ç∂„Ç§„É≥Ôºâ -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">Ë¶ãÁ©ç„ÇäÁ∑®ÈõÜ</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- „Éú„Éá„Ç£ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="card_type" id="edit_card_type_hidden" disabled>

            <!-- „Ç´„Éº„ÉâÁ®ÆÂà•Ôºà„Ç´„Éº„ÉâÂΩ¢ÂºèÔºâ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">„Ç´„Éº„ÉâÁ®ÆÂà•</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEW„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Ê•ΩÂ§©„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPay„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
                <!-- ÂàÜÂâ≤Êâï„ÅÑ„ÅÆÂ†¥Âêà„ÅÆÊ≥®ÊÑè„É°„ÉÉ„Çª„Éº„Ç∏ -->
                <p id="edit_split_payment_notice" class="text-sm text-amber-600 mt-2 hidden">
                    <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    ÂàÜÂâ≤Êâï„ÅÑ„ÅÆ„Åü„ÇÅ„ÄÅ„Ç´„Éº„ÉâÁ®ÆÂà•„ÅØÂ§âÊõ¥„Åß„Åç„Åæ„Åõ„Çì
                </p>
            </div>

            <!-- ÂÜÖÂÆπ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ÂÜÖÂÆπ</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="‰æã: ÊóÖË°å„ÄÅÂÆ∂Èõª„Å™„Å©">
            </div>

            <!-- ÈáëÈ°çÂÖ•Âäõ -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="edit_estimate_amount_label">ÈáëÈ°çÔºàÂÜÜÔºâ</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="edit_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('edit')">
                        <span>üíµ „Éâ„É´</span>
                    </label>
                </div>
                <!-- ÂÜÜÂÖ•ÂäõÔºà„Éá„Éï„Ç©„É´„ÉàË°®Á§∫Ôºâ -->
                <div id="edit_estimate_jpy_input">
                    <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- „Éâ„É´ÂÖ•ÂäõÔºàÈùûË°®Á§∫Ôºâ -->
                <div id="edit_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="edit_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <!-- Âà©Áî®Êó• -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Âà©Áî®Êó•</label>
                <input type="date" name="purchase_date" id="edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" required>
            </div>

            <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ÂàÜÂâ≤2ÂõûÊâï„ÅÑ</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">„Éú„Éº„Éä„ÇπÊâï„ÅÑ</span>
                </label>
            </div>

            <!-- „Éú„Çø„É≥ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    ‰øùÂ≠ò
                </button>
            </div>
        </form>
    </div>
</div>

<!-- „Éá„Éï„Ç©„É´„ÉàÈ†ÖÁõÆÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´Ôºà„É¢„ÉÄ„É≥„Éá„Ç∂„Ç§„É≥Ôºâ -->
<div id="defaultEditModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">ÂÆöÊúüÈ†ÖÁõÆÁ∑®ÈõÜ</h3>
            <button type="button" onclick="closeDefaultEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- „Éú„Éá„Ç£ -->
        <form id="defaultEditForm" method="post" action="{% url 'budget_app:credit_estimates' %}" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_default">
            <input type="hidden" name="id" id="default_edit_id">
            <input type="hidden" name="label" id="default_edit_hidden_label">
            <input type="hidden" name="year_month" id="default_edit_year_month">

            <!-- È†ÖÁõÆÂêç -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">È†ÖÁõÆÂêç</label>
                <input type="text" id="default_edit_label" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-sm" readonly>
            </div>

            <!-- „Ç´„Éº„ÉâÁ®ÆÂà•Ôºà„Ç´„Éº„ÉâÂΩ¢ÂºèÔºâ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">„Ç´„Éº„ÉâÁ®ÆÂà•</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEW„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Ê•ΩÂ§©„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPay„Ç´„Éº„Éâ</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- ÈáëÈ°çÂÖ•Âäõ -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="default_edit_estimate_amount_label">ÈáëÈ°çÔºàÂÜÜÔºâ</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="default_edit_estimate_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="toggleEstimateCurrencyInput('default_edit')">
                        <span>üíµ „Éâ„É´</span>
                    </label>
                </div>
                <!-- ÂÜÜÂÖ•ÂäõÔºà„Éá„Éï„Ç©„É´„ÉàË°®Á§∫Ôºâ -->
                <div id="default_edit_estimate_jpy_input">
                    <input type="number" name="amount" id="default_edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- „Éâ„É´ÂÖ•ÂäõÔºàÈùûË°®Á§∫Ôºâ -->
                <div id="default_edit_estimate_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="default_edit_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <!-- Âà©Áî®Êó• -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Âà©Áî®Êó•</label>
                <input type="date" name="purchase_date" id="default_edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" required>
            </div>

            <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
            <div>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                    <input type="checkbox" name="is_split_payment" id="default_edit_is_split_payment" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ÂàÜÂâ≤2ÂõûÊâï„ÅÑ</span>
                </label>
            </div>

            <!-- „Éú„Çø„É≥ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeDefaultEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 font-medium transition shadow-md text-sm">
                    ‰øùÂ≠ò
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // ÈÄöË≤®ÂÖ•ÂäõÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
    function toggleEstimateCurrencyInput(mode) {
        // mode: 'create', 'edit', 'default_edit'
        const isUsdCheckbox = document.getElementById(`${mode}_estimate_is_usd`);
        const jpyInput = document.getElementById(`${mode}_estimate_jpy_input`);
        const usdInput = document.getElementById(`${mode}_estimate_usd_input`);
        const label = document.getElementById(`${mode}_estimate_amount_label`);

        if (isUsdCheckbox && jpyInput && usdInput) {
            if (isUsdCheckbox.checked) {
                jpyInput.classList.add('hidden');
                usdInput.classList.remove('hidden');
                if (label) label.textContent = 'ÈáëÈ°çÔºà„Éâ„É´Ôºâ';
            } else {
                jpyInput.classList.remove('hidden');
                usdInput.classList.add('hidden');
                if (label) label.textContent = 'ÈáëÈ°çÔºàÂÜÜÔºâ';
            }
        }
    }

    // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„ÉÄ„É´Âà∂Âæ°Èñ¢Êï∞
    function openCreateModal() {
        const modal = document.getElementById('createModal');
        modal.classList.remove('hidden');

        // ÂàÜÂâ≤„Éª„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅÆË°®Á§∫Âà∂Âæ°„ÇíÊõ¥Êñ∞
        if (typeof toggleCreatePaymentOptions === 'function') {
            toggleCreatePaymentOptions();
        }
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´Âà∂Âæ°Èñ¢Êï∞
    function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        form.action = `/credit-estimates/${pk}/edit/`;

        // „Ç´„Éº„ÉâÁ®ÆÂà•„ÇíË®≠ÂÆöÔºà„É©„Ç∏„Ç™„Éú„Çø„É≥ÂΩ¢ÂºèÔºâ
        const cardTypeHidden = document.getElementById('edit_card_type_hidden');

        // ÂàÜÂâ≤Êâï„ÅÑ„ÅÆÂ†¥Âêà„ÅØhidden„Éï„Ç£„Éº„É´„Éâ„ÇíÊúâÂäπÂåñ„Åó„ÄÅ„É©„Ç∏„Ç™„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
        if (isSplitPayment) {
            cardTypeHidden.disabled = false;
            cardTypeHidden.value = cardType;
        } else {
            cardTypeHidden.disabled = true;
            cardTypeHidden.value = '';
        }

        document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.card-type-label');
            const box = label.querySelector('.card-type-box');
            const indicator = label.querySelector('.radio-indicator');
            const dot = label.querySelector('.radio-dot');

            // ÂàÜÂâ≤Êâï„ÅÑ„ÅÆÂ†¥Âêà„ÅØ„Ç´„Éº„ÉâÁ®ÆÂà•„ÇíÂ§âÊõ¥‰∏çÂèØ„Å´„Åô„Çã
            if (isSplitPayment) {
                radio.disabled = true;
                label.classList.remove('cursor-pointer');
                label.classList.add('cursor-not-allowed', 'opacity-60');
            } else {
                radio.disabled = false;
                label.classList.add('cursor-pointer');
                label.classList.remove('cursor-not-allowed', 'opacity-60');
            }

            if (radio.checked) {
                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-blue-600', 'bg-blue-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-blue-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÇíË®≠ÂÆö
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_amount').value = amount;

        // Âà©Áî®Êó•„ÇíË®≠ÂÆöÔºàÂà©Áî®Êó•„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞dueDateÔºâ
        if (purchaseDate) {
            document.getElementById('edit_purchase_date').value = purchaseDate;
        } else if (dueDate) {
            document.getElementById('edit_purchase_date').value = dueDate;
        }

        document.getElementById('edit_is_split_payment').checked = isSplitPayment;
        document.getElementById('edit_is_bonus_payment').checked = isBonusPayment;

        // ÂàÜÂâ≤Êâï„ÅÑ„ÅÆÂ†¥Âêà„ÅÆÊ≥®ÊÑè„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„ÇíÊõ¥Êñ∞
        const splitNotice = document.getElementById('edit_split_payment_notice');
        if (splitNotice) {
            if (isSplitPayment) {
                splitNotice.classList.remove('hidden');
            } else {
                splitNotice.classList.add('hidden');
            }
        }

        // ÂàÜÂâ≤Êâï„ÅÑ„Éª„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        if (typeof window.toggleEditPaymentOptions === 'function') {
            window.toggleEditPaymentOptions();
        }

        // ÊúÄÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        modal.classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate) {
        const modal = document.getElementById('defaultEditModal');

        // ÈáëÈ°ç„ÇíÊï∞ÂÄ§„Å´Â§âÊèõÔºàÊñáÂ≠óÂàó„Å®„Åó„Å¶Ê∏°„Åï„Çå„ÅüÂ†¥ÂêàÔºâ
        const numericAmount = typeof amount === 'string' ? parseInt(amount.replace(/,/g, ''), 10) : amount;

        console.log('openDefaultEditModal called with:', { id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate, numericAmount });

        // „Ç´„Éº„ÉâÁ®ÆÂà•„ÇíË®≠ÂÆöÔºà„É©„Ç∏„Ç™„Éú„Çø„É≥ÂΩ¢ÂºèÔºâ
        document.querySelectorAll('#defaultEditModal .default-card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.default-card-type-label');
            const box = label.querySelector('.default-card-type-box');
            const indicator = label.querySelector('.default-radio-indicator');
            const dot = label.querySelector('.default-radio-dot');

            if (radio.checked) {
                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-green-600', 'bg-green-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-green-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // „Éï„Ç©„Éº„É†„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö
        document.getElementById('default_edit_id').value = id;
        document.getElementById('default_edit_label').value = label;
        document.getElementById('default_edit_year_month').value = yearMonth;
        document.getElementById('default_edit_hidden_label').value = label; // hidden„Éï„Ç£„Éº„É´„Éâ„Å´„ÇÇÂÄ§„ÇíË®≠ÂÆö
        document.getElementById('default_edit_amount').value = numericAmount;
        document.getElementById('default_edit_is_split_payment').checked = isSplitPayment || false;
        document.getElementById('default_edit_purchase_date').value = purchaseDate || '';

        // ÊúÄÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        modal.classList.remove('hidden');
    }

    function closeDefaultEditModal() {
        document.getElementById('defaultEditModal').classList.add('hidden');
    }

    // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    document.getElementById('createModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeCreateModal();
    });

    document.getElementById('editModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    document.getElementById('defaultEditModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeDefaultEditModal();
    });

    document.addEventListener('DOMContentLoaded', () => {
        // ÈÄöÂ∏∏È†ÖÁõÆ„ÅÆ„Ç´„Éº„ÉâÁ®ÆÂà•„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        document.querySelectorAll('#editModal .card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.card-type-radio');
                const cardType = radio.value;

                // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„ÉâÁ®ÆÂà•„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('#editModal .card-type-label').forEach(l => {
                    const r = l.querySelector('.card-type-radio');
                    const box = l.querySelector('.card-type-box');
                    const indicator = l.querySelector('.radio-indicator');
                    const dot = l.querySelector('.radio-dot');

                    r.checked = false;
                    box.classList.remove('border-blue-600', 'bg-blue-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-blue-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç´„Éº„ÉâÁ®ÆÂà•„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                radio.checked = true;
                const box = this.querySelector('.card-type-box');
                const indicator = this.querySelector('.radio-indicator');
                const dot = this.querySelector('.radio-dot');

                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');

                // ÂàÜÂâ≤Êâï„ÅÑ„Éª„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅÆË°®Á§∫Âà∂Âæ°„ÇíÊõ¥Êñ∞
                if (typeof window.toggleEditPaymentOptions === 'function') {
                    window.toggleEditPaymentOptions();
                }
            });
        });

        // ÂÆöÊúüÈ†ÖÁõÆ„ÅÆ„Ç´„Éº„ÉâÁ®ÆÂà•„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.default-card-type-radio');

                // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„ÉâÁ®ÆÂà•„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(l => {
                    const r = l.querySelector('.default-card-type-radio');
                    const box = l.querySelector('.default-card-type-box');
                    const indicator = l.querySelector('.default-radio-indicator');
                    const dot = l.querySelector('.default-radio-dot');

                    r.checked = false;
                    box.classList.remove('border-green-600', 'bg-green-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-green-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç´„Éº„ÉâÁ®ÆÂà•„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                radio.checked = true;
                const box = this.querySelector('.default-card-type-box');
                const indicator = this.querySelector('.default-radio-indicator');
                const dot = this.querySelector('.default-radio-dot');

                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            });
        });

        // CSRF„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // „ÇØ„É¨„Ç´Ë¶ãÁ©ç„ÇÇ„Çä„ÅÆÊäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
        document.querySelectorAll('[data-toggle-estimate]').forEach(function(header) {
            const ym = header.getAttribute('data-toggle-estimate');

            header.addEventListener('click', function() {
                const desktopContent = document.getElementById('estimate-content-' + ym);
                const mobileContent = document.getElementById('estimate-content-mobile-' + ym);
                const icon = document.getElementById('collapse-icon-' + ym);

                // „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóË°®Á§∫„ÅØÂ∏∏„Å´md:block„ÅßÂà∂Âæ°„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                // „É¢„Éê„Ç§„É´Ë°®Á§∫ÔºöÂÄãÂà•È†ÖÁõÆ„É™„Çπ„Éà„ÅÆ„Åø„Çí„Éà„Ç∞„É´Ôºà„Ç´„Éº„ÉâÁ®ÆÂà•„Éò„ÉÉ„ÉÄ„Éº„ÅØÂ∏∏„Å´Ë°®Á§∫Ôºâ
                if (mobileContent) {
                    const cardDetailsMobile = mobileContent.querySelectorAll('.card-details-mobile');
                    cardDetailsMobile.forEach(details => {
                        details.classList.toggle('hidden');
                    });
                }

                if (icon) {
                    icon.classList.toggle('rotate-180');
                }
            });
        });

        // „Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„ÅèÈñ¢Êï∞Ôºà„ÇØ„É¨„Ç´Ë¶ãÁ©ç„ÇÇ„Çä„Éö„Éº„Ç∏„Åß„ÅØÂàùÊúüÁä∂ÊÖã„ÅßÂÖ®„Å¶Èñã„ÅÑ„Å¶„ÅÑ„Çã„ÅÆ„Åß„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„ÅøÔºâ
        function expandEstimateSection(hash) {
            if (hash && hash.startsWith('#estimate-content-')) {
                // „Éè„ÉÉ„Ç∑„É•„Åã„ÇâÂπ¥Êúà„ÇíÊäΩÂá∫Ôºà‰æãÔºö#estimate-content-2025-12 ‚Üí 2025-12Ôºâ
                const yearMonth = hash.replace('#estimate-content-', '').replace('-mobile', '');

                // „Éò„ÉÉ„ÉÄ„ÉºË¶ÅÁ¥†„Çí„Çπ„ÇØ„É≠„Éº„É´ÂÖà„Å´„Åô„ÇãÔºàÂ∏∏„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅÔºâ
                const targetElement = document.querySelector(`[data-toggle-estimate="${yearMonth}"]`);

                if (targetElement) {
                    setTimeout(() => {
                        const header = document.querySelector('nav');
                        const headerHeight = header ? header.offsetHeight : 0;
                        const elementPosition = targetElement.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    }, 200);
                }
            }
        }

        // sessionStorage„Åã„Çâ„Ç¢„É≥„Ç´„Éº„ÇíÂèñÂæóÔºàcommon.js„Åß„É™„É≠„Éº„ÉâÂâç„Å´‰øùÂ≠ò„Åï„Çå„ÇãÔºâ
        const savedAnchor = sessionStorage.getItem('scrollToAnchor');
        if (savedAnchor) {
            // URL„ÅÆ„Éè„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
            window.location.hash = savedAnchor;
            // sessionStorage„Çí„ÇØ„É™„Ç¢Ôºàbase.html„Åß„ÇÇ„ÇØ„É™„Ç¢„Åï„Çå„Çã„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅÔºâ
            sessionStorage.removeItem('scrollToAnchor');
            // „Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂ±ïÈñã
            expandEstimateSection(savedAnchor);
        } else {
            // URL„ÅÆ„Éè„ÉÉ„Ç∑„É•Ôºà„Ç¢„É≥„Ç´„ÉºÔºâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÄÅË©≤ÂΩì„Åô„ÇãÊúà„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËá™ÂãïÁöÑ„Å´Èñã„Åè
            expandEstimateSection(window.location.hash);
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØÔºàbase.html„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Âá¶ÁêÜ„ÅÆÂæå„Å´ÂÆüË°åÔºâ
        window.addEventListener('load', function() {
            // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„ÄÅbase.html„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÅåÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâÂÆüË°å
            setTimeout(() => {
                const hash = window.location.hash;
                if (hash) {
                    expandEstimateSection(hash);
                }
            }, 400);
        });

        // „Éú„Éº„Éä„ÇπÊâï„ÅÑ„Å®ÂàÜÂâ≤Êâï„ÅÑ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÊñ∞Ë¶èËøΩÂä†„Éï„Ç©„Éº„É†Ôºâ
        const createCardTypeSelect = document.getElementById('create_card_type');
        const createBonusWrapper = document.getElementById('create_bonus_payment_wrapper');
        const createSplitWrapper = document.getElementById('create_split_payment_wrapper');
        const createBonusCheckbox = document.getElementById('id_is_bonus_payment');
        const createSplitCheckbox = document.getElementById('id_is_split_payment');

        window.toggleCreatePaymentOptions = function() {
            const isViewCard = createCardTypeSelect.value === 'item_6';

            // ÂàÜÂâ≤Êâï„ÅÑ„ÅØVIEW„Ç´„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
            if (createSplitWrapper) {
                createSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createSplitCheckbox) {
                    createSplitCheckbox.checked = false;
                }
            }

            // „Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅØVIEW„Ç´„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
            if (createBonusWrapper) {
                createBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createBonusCheckbox) {
                    createBonusCheckbox.checked = false;
                }
            }
        }

        if (createCardTypeSelect) {
            createCardTypeSelect.addEventListener('change', function() {
                window.toggleCreatePaymentOptions();
            });
            window.toggleCreatePaymentOptions(); // ÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
        }

        // ÂàÜÂâ≤„Éª„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅÆÊéí‰ªñÂà∂Âæ°
        if (createSplitCheckbox && createBonusCheckbox) {
            createSplitCheckbox.addEventListener('change', function() {
                if (this.checked && createBonusCheckbox.checked) {
                    createBonusCheckbox.checked = false;
                }
            });
            createBonusCheckbox.addEventListener('change', function() {
                if (this.checked && createSplitCheckbox.checked) {
                    createSplitCheckbox.checked = false;
                }
            });
        }

        // ÂàÜÂâ≤Êâï„ÅÑ„Å®„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´Ôºâ
        const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
        const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
        const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');
        const editSplitCheckbox = document.getElementById('edit_is_split_payment');

        window.toggleEditPaymentOptions = function() {
            // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÅßÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç´„Éº„ÉâÁ®ÆÂà•„ÇíÂèñÂæóÔºà„É©„Ç∏„Ç™„Éú„Çø„É≥Ôºâ
            const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
            const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

            // ÂàÜÂâ≤Êâï„ÅÑ„ÅØVIEW„Ç´„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
            if (editSplitWrapper) {
                editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editSplitCheckbox) {
                    editSplitCheckbox.checked = false;
                }
            }

            // „Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅØVIEW„Ç´„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
            if (editBonusWrapper) {
                editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editBonusCheckbox) {
                    editBonusCheckbox.checked = false;
                }
            }
        }

        // ÂàÜÂâ≤„Éª„Éú„Éº„Éä„ÇπÊâï„ÅÑ„ÅÆÊéí‰ªñÂà∂Âæ°ÔºàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´Ôºâ
        if (editSplitCheckbox && editBonusCheckbox) {
            editSplitCheckbox.addEventListener('change', function() {
                if (this.checked && editBonusCheckbox.checked) {
                    editBonusCheckbox.checked = false;
                }
            });
            editBonusCheckbox.addEventListener('change', function() {
                if (this.checked && editSplitCheckbox.checked) {
                    editSplitCheckbox.checked = false;
                }
            });
        }

        // Á∑®ÈõÜ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí‰øÆÊ≠£
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Á∑®ÈõÜ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ - datasetÂÖ®‰Ωì:', this.dataset);
                const pk = this.dataset.pk;
                const yearMonth = this.dataset.yearMonth;
                const cardType = this.dataset.cardType;
                const description = this.dataset.description;
                const amount = this.dataset.amount;
                const dueDate = this.dataset.dueDate;
                const purchaseDate = this.dataset.purchaseDate;
                const isSplit = this.dataset.split === 'true';
                const isBonus = this.dataset.bonus === 'true';

                console.log('ÂèñÂæó„Åó„ÅücardType:', cardType);
                openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplit, isBonus);
            });
        });
        
        // „Éá„Éï„Ç©„É´„ÉàÁ∑®ÈõÜ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.querySelectorAll('.default-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('ÂÆöÊúüÁ∑®ÈõÜ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ - datasetÂÖ®‰Ωì:', this.dataset);
                const id = this.dataset.defaultId;
                const label = this.dataset.label;
                const amount = this.dataset.amount;
                const cardType = this.dataset.cardType;
                const yearMonth = this.dataset.yearMonth;
                const isSplit = this.dataset.split === 'true';
                const purchaseDate = this.dataset.purchaseDate;

                console.log('ÂèñÂæó„Åó„ÅücardType:', cardType, 'purchaseDate:', purchaseDate);
                openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplit, purchaseDate);
            });
        });

        // --- Êñ∞Ë¶èËøΩÂä†„Éï„Ç©„Éº„É†„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        const createForm = document.getElementById('createEstimateForm');
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(createForm), {
                closeModal: closeCreateModal
            });
        });

        // --- Ë¶ãÁ©ç„ÇäÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„Éï„Ç©„Éº„É†„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        const editForm = document.getElementById('editForm');
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);

            await window.sendAjaxRequest(editForm.action, formData, {
                closeModal: closeEditModal
                // target_url„ÅÆÂá¶ÁêÜ„ÅØsendAjaxRequestÂÜÖ„ÅßËá™ÂãïÁöÑ„Å´Ë°å„Çè„Çå„ÇãÔºàsessionStorage‰øùÂ≠ò‚Üí„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÔºâ
            });
        });

        // --- ÂÆöÊúü„Éá„Éï„Ç©„É´„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„Éï„Ç©„Éº„É†„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        const defaultEditForm = document.getElementById('defaultEditForm');
        defaultEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(defaultEditForm), {
                closeModal: closeDefaultEditModal
            });
        });

        // --- „Ç´„Éº„Éâ„Åî„Å®„ÅÆÂèçÊò†„Éú„Çø„É≥„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        document.querySelectorAll('.reflect-card-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!confirm('„Åì„ÅÆ„Ç´„Éº„Éâ„ÅÆÂêàË®àÈ°ç„ÇíÊúàÊ¨°Ë®àÁîª„Å´ÂèçÊò†„Åó„Åæ„Åô„ÅãÔºü')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form), {
                    toastDuration: 3000,  // 3ÁßíË°®Á§∫
                    reloadOnSuccess: true  // Ëá™ÂãïÁöÑ„Å´ÊúàÊ¨°Ë®àÁîª„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª
                });
            });
        });

        // --- ÂâäÈô§„Éú„Çø„É≥„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        document.querySelectorAll('form[action*="/credit-estimates/delete/"]').forEach(deleteForm => {
            deleteForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const isRecurring = deleteForm.dataset.recurring === 'true';
                let confirmed = false;
                let deleteType = 'single';

                if (isRecurring) {
                    confirmed = confirm('„Åì„ÅÆÈ†ÖÁõÆ„ÅØÂÆöÊúüÁöÑ„Å™Ë¶ãÁ©ç„ÇÇ„Çä„Åß„Åô„ÄÇ„Åì„ÅÆÊúà„ÅÆË¶ãÁ©ç„ÇÇ„Çä„ÅÆ„ÅøÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n„ÄåOK„Äç„Åß„Åì„ÅÆÊúà„ÅÆ„ÅøÂâäÈô§„ÄÅ„Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åß‰∏≠Ê≠¢„Åó„Åæ„Åô„ÄÇ');
                    if (confirmed) {
                        deleteType = 'single';
                    }
                } else {
                    confirmed = confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');
                }

                if (!confirmed) return;

                const formData = new FormData();
                formData.append('delete_type', deleteType);

                await window.sendAjaxRequest(deleteForm.action, formData);
            });
        });

        // --- ÂÆöÊúü„Éá„Éï„Ç©„É´„ÉàÈ†ÖÁõÆ„ÅÆÂâäÈô§„Éï„Ç©„Éº„É†„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ ---
        document.querySelectorAll('.delete-default-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!confirm('„Åì„ÅÆÊúà„ÅÆÂÆöÊúüÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form));
            });
        });

        // Âπ¥Êúà„Éï„Ç©„Éº„É†„ÅÆÂêåÊúü
        document.querySelectorAll('[data-year-month-form]').forEach(form => {
            const yearSelect = form.querySelector('[data-year-select]');
            const monthSelect = form.querySelector('[data-month-select]');
            const target = form.querySelector('[data-year-month]');

            const sync = () => {
                if (yearSelect && monthSelect && target) {
                    target.value = `${yearSelect.value}-${monthSelect.value}`;
                }
            };

            sync();
            yearSelect?.addEventListener('change', sync);
            monthSelect?.addEventListener('change', sync);
        });
    });
</script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Django„ÅÆmessages„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Éà„Éº„Çπ„Éà„ÅßË°®Á§∫
    {% for message in messages %}
        window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}
});
</script>
{% endblock %}
{% endblock %}
