{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-4 md:mb-6 flex justify-between items-center">
        <h2 class="text-2xl md:text-3xl font-bold">クレカ見積り</h2>
        <button onclick="openCreateModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
            新規追加
        </button>
    </div>

    <div class="mt-10">
        {% comment %} 登録済み見積もりを表示 {% endcomment %}

        <div class="space-y-8">
            {% include 'budget_app/_summary_section.html' with summary_data=future_summary title='未来' %}
        </div>

        {% if not future_summary %}
            <!-- データがない場合のメッセージ -->
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                <p class="text-gray-600 text-lg font-medium">まだクレカ見積りは登録されていません</p>
                <p class="text-gray-500 text-sm mt-2">右上の「新規追加」ボタンからクレカ見積りを追加できます</p>
            </div>
        {% else %}
        {% endif %}
    </div>
</div>

<!-- 新規作成モーダル -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">見積り新規追加</h3>
            <button type="button" onclick="closeCreateModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="createEstimateForm" method="post" class="p-4 pb-6 space-y-4" data-year-month-form>
            {% csrf_token %}
            <input type="hidden" name="action" value="create_estimate">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.card_type.label }}</label>
                <select name="card_type" id="create_card_type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    {% for card in card_choices %}
                    <option value="{{ card.key }}"{% if forloop.first %} selected{% endif %}>{{ card.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.description.label }}</label>
                {{ form.description }}
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.amount.label }}</label>
                {{ form.amount }}
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">{{ form.purchase_date.label }}</label>
                {{ form.purchase_date }}
            </div>

            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_split_payment_wrapper">
                    {{ form.is_split_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_split_payment.label }}</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_bonus_payment_wrapper">
                    {{ form.is_bonus_payment }}
                    <span class="ml-2 text-sm font-medium text-gray-700">{{ form.is_bonus_payment.label }}</span>
                </label>
            </div>

            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    追加
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 編集モーダル（モダンデザイン） -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">見積り編集</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="card_type" id="edit_card_type_hidden" disabled>

            <!-- カード種別（カード形式） -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">カード種別</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEWカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">楽天カード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPayカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
                <!-- 分割払いの場合の注意メッセージ -->
                <p id="edit_split_payment_notice" class="text-sm text-amber-600 mt-2 hidden">
                    <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    分割払いのため、カード種別は変更できません
                </p>
            </div>

            <!-- 内容 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">内容</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="例: 旅行、家電など">
            </div>

            <!-- 金額 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">金額（円）</label>
                <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <!-- 利用日 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">利用日</label>
                <input type="date" name="purchase_date" id="edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" required>
            </div>

            <!-- チェックボックス -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">分割2回払い</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ボーナス払い</span>
                </label>
            </div>

            <!-- ボタン -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<!-- デフォルト項目編集モーダル（モダンデザイン） -->
<div id="defaultEditModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">定期項目編集</h3>
            <button type="button" onclick="closeDefaultEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="defaultEditForm" method="post" action="{% url 'budget_app:credit_estimates' %}" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_default">
            <input type="hidden" name="id" id="default_edit_id">
            <input type="hidden" name="label" id="default_edit_hidden_label">
            <input type="hidden" name="year_month" id="default_edit_year_month">

            <!-- 項目名 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">項目名</label>
                <input type="text" id="default_edit_label" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-sm" readonly>
            </div>

            <!-- カード種別（カード形式） -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">カード種別</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEWカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">楽天カード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPayカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer default-card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden default-card-type-radio">
                        <div class="border-2 border-gray-300 rounded-xl p-3 transition hover:border-green-400 hover:bg-green-50 default-card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 default-radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-600 hidden default-radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 金額 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">金額（円）</label>
                <input type="number" name="amount" id="default_edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <!-- 利用日 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">利用日</label>
                <input type="date" name="purchase_date" id="default_edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm" required>
            </div>

            <!-- チェックボックス -->
            <div>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                    <input type="checkbox" name="is_split_payment" id="default_edit_is_split_payment" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">分割2回払い</span>
                </label>
            </div>

            <!-- ボタン -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeDefaultEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // 新規作成モーダル制御関数
    function openCreateModal() {
        const modal = document.getElementById('createModal');
        modal.classList.remove('hidden');

        // 分割・ボーナス払いの表示制御を更新
        if (typeof toggleCreatePaymentOptions === 'function') {
            toggleCreatePaymentOptions();
        }
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    // 編集モーダル制御関数
    function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        form.action = `/credit-estimates/${pk}/edit/`;

        // カード種別を設定（ラジオボタン形式）
        const cardTypeHidden = document.getElementById('edit_card_type_hidden');

        // 分割払いの場合はhiddenフィールドを有効化し、ラジオボタンを無効化
        if (isSplitPayment) {
            cardTypeHidden.disabled = false;
            cardTypeHidden.value = cardType;
        } else {
            cardTypeHidden.disabled = true;
            cardTypeHidden.value = '';
        }

        document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.card-type-label');
            const box = label.querySelector('.card-type-box');
            const indicator = label.querySelector('.radio-indicator');
            const dot = label.querySelector('.radio-dot');

            // 分割払いの場合はカード種別を変更不可にする
            if (isSplitPayment) {
                radio.disabled = true;
                label.classList.remove('cursor-pointer');
                label.classList.add('cursor-not-allowed', 'opacity-60');
            } else {
                radio.disabled = false;
                label.classList.add('cursor-pointer');
                label.classList.remove('cursor-not-allowed', 'opacity-60');
            }

            if (radio.checked) {
                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-blue-600', 'bg-blue-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-blue-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // 各フィールドを設定
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_amount').value = amount;

        // 利用日を設定（利用日がある場合はそれを使用、なければdueDate）
        if (purchaseDate) {
            document.getElementById('edit_purchase_date').value = purchaseDate;
        } else if (dueDate) {
            document.getElementById('edit_purchase_date').value = dueDate;
        }

        document.getElementById('edit_is_split_payment').checked = isSplitPayment;
        document.getElementById('edit_is_bonus_payment').checked = isBonusPayment;

        // 分割払いの場合の注意メッセージ表示を更新
        const splitNotice = document.getElementById('edit_split_payment_notice');
        if (splitNotice) {
            if (isSplitPayment) {
                splitNotice.classList.remove('hidden');
            } else {
                splitNotice.classList.add('hidden');
            }
        }

        // 分割払い・ボーナス払いチェックボックスの表示を更新
        if (typeof window.toggleEditPaymentOptions === 'function') {
            window.toggleEditPaymentOptions();
        }

        // 最後にモーダルを表示
        modal.classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate) {
        const modal = document.getElementById('defaultEditModal');

        // 金額を数値に変換（文字列として渡された場合）
        const numericAmount = typeof amount === 'string' ? parseInt(amount.replace(/,/g, ''), 10) : amount;

        console.log('openDefaultEditModal called with:', { id, label, amount, cardType, yearMonth, isSplitPayment, purchaseDate, numericAmount });

        // カード種別を設定（ラジオボタン形式）
        document.querySelectorAll('#defaultEditModal .default-card-type-radio').forEach(radio => {
            radio.checked = (radio.value === cardType);
            const label = radio.closest('.default-card-type-label');
            const box = label.querySelector('.default-card-type-box');
            const indicator = label.querySelector('.default-radio-indicator');
            const dot = label.querySelector('.default-radio-dot');

            if (radio.checked) {
                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            } else {
                box.classList.remove('border-green-600', 'bg-green-50');
                box.classList.add('border-gray-300');
                indicator.classList.remove('border-green-600');
                indicator.classList.add('border-gray-400');
                dot.classList.add('hidden');
            }
        });

        // フォームのフィールドに値を設定
        document.getElementById('default_edit_id').value = id;
        document.getElementById('default_edit_label').value = label;
        document.getElementById('default_edit_year_month').value = yearMonth;
        document.getElementById('default_edit_hidden_label').value = label; // hiddenフィールドにも値を設定
        document.getElementById('default_edit_amount').value = numericAmount;
        document.getElementById('default_edit_is_split_payment').checked = isSplitPayment || false;
        document.getElementById('default_edit_purchase_date').value = purchaseDate || '';

        // 最後にモーダルを表示
        modal.classList.remove('hidden');
    }

    function closeDefaultEditModal() {
        document.getElementById('defaultEditModal').classList.add('hidden');
    }

    // 背景クリックでモーダルを閉じる
    document.getElementById('createModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeCreateModal();
    });

    document.getElementById('editModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    document.getElementById('defaultEditModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeDefaultEditModal();
    });

    document.addEventListener('DOMContentLoaded', () => {
        // 通常項目のカード種別ラジオボタンのクリックイベント
        document.querySelectorAll('#editModal .card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.card-type-radio');
                const cardType = radio.value;

                // 全てのカード種別の選択状態をリセット
                document.querySelectorAll('#editModal .card-type-label').forEach(l => {
                    const r = l.querySelector('.card-type-radio');
                    const box = l.querySelector('.card-type-box');
                    const indicator = l.querySelector('.radio-indicator');
                    const dot = l.querySelector('.radio-dot');

                    r.checked = false;
                    box.classList.remove('border-blue-600', 'bg-blue-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-blue-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // クリックされたカード種別を選択状態に
                radio.checked = true;
                const box = this.querySelector('.card-type-box');
                const indicator = this.querySelector('.radio-indicator');
                const dot = this.querySelector('.radio-dot');

                box.classList.add('border-blue-600', 'bg-blue-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-blue-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');

                // 分割払い・ボーナス払いの表示制御を更新
                if (typeof window.toggleEditPaymentOptions === 'function') {
                    window.toggleEditPaymentOptions();
                }
            });
        });

        // 定期項目のカード種別ラジオボタンのクリックイベント
        document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(label => {
            label.addEventListener('click', function() {
                const radio = this.querySelector('.default-card-type-radio');

                // 全てのカード種別の選択状態をリセット
                document.querySelectorAll('#defaultEditModal .default-card-type-label').forEach(l => {
                    const r = l.querySelector('.default-card-type-radio');
                    const box = l.querySelector('.default-card-type-box');
                    const indicator = l.querySelector('.default-radio-indicator');
                    const dot = l.querySelector('.default-radio-dot');

                    r.checked = false;
                    box.classList.remove('border-green-600', 'bg-green-50');
                    box.classList.add('border-gray-300');
                    indicator.classList.remove('border-green-600');
                    indicator.classList.add('border-gray-400');
                    dot.classList.add('hidden');
                });

                // クリックされたカード種別を選択状態に
                radio.checked = true;
                const box = this.querySelector('.default-card-type-box');
                const indicator = this.querySelector('.default-radio-indicator');
                const dot = this.querySelector('.default-radio-dot');

                box.classList.add('border-green-600', 'bg-green-50');
                box.classList.remove('border-gray-300');
                indicator.classList.add('border-green-600');
                indicator.classList.remove('border-gray-400');
                dot.classList.remove('hidden');
            });
        });

        // CSRFトークンを取得
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // クレカ見積もりの折りたたみ機能
        document.querySelectorAll('[data-toggle-estimate]').forEach(function(header) {
            const ym = header.getAttribute('data-toggle-estimate');

            header.addEventListener('click', function() {
                const desktopContent = document.getElementById('estimate-content-' + ym);
                const mobileContent = document.getElementById('estimate-content-mobile-' + ym);
                const icon = document.getElementById('collapse-icon-' + ym);

                // デスクトップ表示は常にmd:blockで制御されているので何もしない
                // モバイル表示：個別項目リストのみをトグル（カード種別ヘッダーは常に表示）
                if (mobileContent) {
                    const cardDetailsMobile = mobileContent.querySelectorAll('.card-details-mobile');
                    cardDetailsMobile.forEach(details => {
                        details.classList.toggle('hidden');
                    });
                }

                if (icon) {
                    icon.classList.toggle('rotate-180');
                }
            });
        });

        // セクションを開く関数（クレカ見積もりページでは初期状態で全て開いているのでスクロールのみ）
        function expandEstimateSection(hash) {
            if (hash && hash.startsWith('#estimate-content-')) {
                // ハッシュから年月を抽出（例：#estimate-content-2025-12 → 2025-12）
                const yearMonth = hash.replace('#estimate-content-', '').replace('-mobile', '');

                // ヘッダー要素をスクロール先にする（常に表示されているため）
                const targetElement = document.querySelector(`[data-toggle-estimate="${yearMonth}"]`);

                if (targetElement) {
                    setTimeout(() => {
                        const header = document.querySelector('nav');
                        const headerHeight = header ? header.offsetHeight : 0;
                        const elementPosition = targetElement.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    }, 200);
                }
            }
        }

        // sessionStorageからアンカーを取得（common.jsでリロード前に保存される）
        const savedAnchor = sessionStorage.getItem('scrollToAnchor');
        if (savedAnchor) {
            // URLのハッシュを更新
            window.location.hash = savedAnchor;
            // sessionStorageをクリア（base.htmlでもクリアされるが、念のため）
            sessionStorage.removeItem('scrollToAnchor');
            // セクションを展開
            expandEstimateSection(savedAnchor);
        } else {
            // URLのハッシュ（アンカー）をチェックして、該当する月のセクションを自動的に開く
            expandEstimateSection(window.location.hash);
        }

        // ページ読み込み完了後もチェック（base.htmlのスクロール処理の後に実行）
        window.addEventListener('load', function() {
            // 少し遅延させて、base.htmlのスクロールが完了してから実行
            setTimeout(() => {
                const hash = window.location.hash;
                if (hash) {
                    expandEstimateSection(hash);
                }
            }, 400);
        });

        // ボーナス払いと分割払いチェックボックスの表示制御（新規追加フォーム）
        const createCardTypeSelect = document.getElementById('create_card_type');
        const createBonusWrapper = document.getElementById('create_bonus_payment_wrapper');
        const createSplitWrapper = document.getElementById('create_split_payment_wrapper');
        const createBonusCheckbox = document.getElementById('id_is_bonus_payment');
        const createSplitCheckbox = document.getElementById('id_is_split_payment');

        window.toggleCreatePaymentOptions = function() {
            const isViewCard = createCardTypeSelect.value === 'item_6';

            // 分割払いはVIEWカードの場合のみ表示
            if (createSplitWrapper) {
                createSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createSplitCheckbox) {
                    createSplitCheckbox.checked = false;
                }
            }

            // ボーナス払いはVIEWカードの場合のみ表示
            if (createBonusWrapper) {
                createBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && createBonusCheckbox) {
                    createBonusCheckbox.checked = false;
                }
            }
        }

        if (createCardTypeSelect) {
            createCardTypeSelect.addEventListener('change', function() {
                window.toggleCreatePaymentOptions();
            });
            window.toggleCreatePaymentOptions(); // 初期状態を設定
        }

        // 分割・ボーナス払いの排他制御
        if (createSplitCheckbox && createBonusCheckbox) {
            createSplitCheckbox.addEventListener('change', function() {
                if (this.checked && createBonusCheckbox.checked) {
                    createBonusCheckbox.checked = false;
                }
            });
            createBonusCheckbox.addEventListener('change', function() {
                if (this.checked && createSplitCheckbox.checked) {
                    createSplitCheckbox.checked = false;
                }
            });
        }

        // 分割払いとボーナス払いチェックボックスの表示制御（編集モーダル）
        const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
        const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
        const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');
        const editSplitCheckbox = document.getElementById('edit_is_split_payment');

        window.toggleEditPaymentOptions = function() {
            // 編集モーダルで選択されているカード種別を取得（ラジオボタン）
            const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
            const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

            // 分割払いはVIEWカードの場合のみ表示
            if (editSplitWrapper) {
                editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editSplitCheckbox) {
                    editSplitCheckbox.checked = false;
                }
            }

            // ボーナス払いはVIEWカードの場合のみ表示
            if (editBonusWrapper) {
                editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
                if (!isViewCard && editBonusCheckbox) {
                    editBonusCheckbox.checked = false;
                }
            }
        }

        // 分割・ボーナス払いの排他制御（編集モーダル）
        if (editSplitCheckbox && editBonusCheckbox) {
            editSplitCheckbox.addEventListener('change', function() {
                if (this.checked && editBonusCheckbox.checked) {
                    editBonusCheckbox.checked = false;
                }
            });
            editBonusCheckbox.addEventListener('change', function() {
                if (this.checked && editSplitCheckbox.checked) {
                    editSplitCheckbox.checked = false;
                }
            });
        }

        // 編集ボタンのイベントリスナーを修正
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('編集ボタンクリック - dataset全体:', this.dataset);
                const pk = this.dataset.pk;
                const yearMonth = this.dataset.yearMonth;
                const cardType = this.dataset.cardType;
                const description = this.dataset.description;
                const amount = this.dataset.amount;
                const dueDate = this.dataset.dueDate;
                const purchaseDate = this.dataset.purchaseDate;
                const isSplit = this.dataset.split === 'true';
                const isBonus = this.dataset.bonus === 'true';

                console.log('取得したcardType:', cardType);
                openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplit, isBonus);
            });
        });
        
        // デフォルト編集ボタンのイベントリスナー
        document.querySelectorAll('.default-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('定期編集ボタンクリック - dataset全体:', this.dataset);
                const id = this.dataset.defaultId;
                const label = this.dataset.label;
                const amount = this.dataset.amount;
                const cardType = this.dataset.cardType;
                const yearMonth = this.dataset.yearMonth;
                const isSplit = this.dataset.split === 'true';
                const purchaseDate = this.dataset.purchaseDate;

                console.log('取得したcardType:', cardType, 'purchaseDate:', purchaseDate);
                openDefaultEditModal(id, label, amount, cardType, yearMonth, isSplit, purchaseDate);
            });
        });

        // --- 新規追加フォームの非同期処理 ---
        const createForm = document.getElementById('createEstimateForm');
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(createForm), {
                closeModal: closeCreateModal
            });
        });

        // --- 見積り編集モーダルフォームの非同期処理 ---
        const editForm = document.getElementById('editForm');
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);

            await window.sendAjaxRequest(editForm.action, formData, {
                closeModal: closeEditModal
                // target_urlの処理はsendAjaxRequest内で自動的に行われる（sessionStorage保存→リダイレクト）
            });
        });

        // --- 定期デフォルト編集モーダルフォームの非同期処理 ---
        const defaultEditForm = document.getElementById('defaultEditForm');
        defaultEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(defaultEditForm), {
                closeModal: closeDefaultEditModal
            });
        });

        // --- カードごとの反映ボタンの非同期処理 ---
        document.querySelectorAll('.reflect-card-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!confirm('このカードの合計額を月次計画に反映しますか？')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form), {
                    toastDuration: 3000,  // 3秒表示
                    reloadOnSuccess: true  // 自動的に月次計画ページへ遷移
                });
            });
        });

        // --- 削除ボタンの非同期処理 ---
        document.querySelectorAll('form[action*="/credit-estimates/delete/"]').forEach(deleteForm => {
            deleteForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const isRecurring = deleteForm.dataset.recurring === 'true';
                let confirmed = false;
                let deleteType = 'single';

                if (isRecurring) {
                    confirmed = confirm('この項目は定期的な見積もりです。この月の見積もりのみ削除しますか？\n\n「OK」でこの月のみ削除、「キャンセル」で中止します。');
                    if (confirmed) {
                        deleteType = 'single';
                    }
                } else {
                    confirmed = confirm('本当に削除しますか？');
                }

                if (!confirmed) return;

                const formData = new FormData();
                formData.append('delete_type', deleteType);

                await window.sendAjaxRequest(deleteForm.action, formData);
            });
        });

        // --- 定期デフォルト項目の削除フォームの非同期処理 ---
        document.querySelectorAll('.delete-default-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!confirm('この月の定期項目を削除しますか？')) return;

                await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form));
            });
        });

        // 年月フォームの同期
        document.querySelectorAll('[data-year-month-form]').forEach(form => {
            const yearSelect = form.querySelector('[data-year-select]');
            const monthSelect = form.querySelector('[data-month-select]');
            const target = form.querySelector('[data-year-month]');

            const sync = () => {
                if (yearSelect && monthSelect && target) {
                    target.value = `${yearSelect.value}-${monthSelect.value}`;
                }
            };

            sync();
            yearSelect?.addEventListener('change', sync);
            monthSelect?.addEventListener('change', sync);
        });
    });
</script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Djangoのmessagesフレームワークからのメッセージをトーストで表示
    {% for message in messages %}
        window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}
});
</script>
{% endblock %}
{% endblock %}
