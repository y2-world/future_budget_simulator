{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
        <h2 class="text-2xl md:text-3xl font-bold">çµ¦ä¸ä¸€è¦§</h2>
        <button onclick="openSalaryModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            éå»ã®çµ¦ä¸æ–°è¦ä½œæˆ
        </button>
    </div>

    <!-- å¹´é–“é›†è¨ˆã¨æ˜ç´° -->
    {% if annual_summaries %}
    <div class="space-y-3">
        {% for annual_summary in annual_summaries %}
        {% if annual_summary.count > 0 %}

        <!-- å¹´ã”ã¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-lg shadow-md p-4">
            <button type="button" onclick="toggleDetails('details-{{ annual_summary.year }}')" class="w-full flex items-center justify-between mb-2 hover:bg-gray-50 -mx-4 px-4 py-2 rounded-t-lg transition">
                <h3 class="text-lg font-bold text-gray-800">{{ annual_summary.year }}å¹´ï¼ˆ{{ annual_summary.count }}ãƒ¶æœˆåˆ†ï¼‰</h3>
                <svg id="details-{{ annual_summary.year }}-icon" class="w-5 h-5 transform transition-transform rotate-180 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>

            <!-- å¹´é–“é›†è¨ˆï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg mb-2">

                    <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="bg-blue-100">
                                    <th class="px-4 py-2 text-left font-semibold">çµ¦ä¸ç·æ”¯çµ¦é¡</th>
                                    <th class="px-4 py-2 text-left font-semibold">è³ä¸ç·æ”¯çµ¦é¡</th>
                                    <th class="px-4 py-2 text-left font-semibold">åˆè¨ˆç·æ”¯çµ¦é¡</th>
                                    <th class="px-4 py-2 text-left font-semibold">ç·æ”¯çµ¦é¡-äº¤é€šè²»</th>
                                    <th class="px-4 py-2 text-left font-semibold">å·®å¼•æ”¯çµ¦é¡åˆè¨ˆ</th>
                                    <th class="px-4 py-2 text-left font-semibold">äº¤é€šè²»</th>
                                    <th class="px-4 py-2 text-left font-semibold">æ§é™¤åˆè¨ˆ</th>
                                    <th class="px-4 py-2 text-left font-semibold">å¹³å‡æ§é™¤ç‡</th>
                                </tr>
                            </thead>
                        <tbody>
                            <tr class="bg-white">
                                <td class="px-4 py-3 font-bold text-green-700">{{ annual_summary.total_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-emerald-700">{{ annual_summary.total_bonus_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-green-800">{{ annual_summary.total_all_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-blue-700">{{ annual_summary.gross_minus_transport|yen }}</td>
                                <td class="px-4 py-3 font-bold text-purple-700">{{ annual_summary.total_all_net|yen }}</td>
                                <td class="px-4 py-3 font-bold text-teal-700">{{ annual_summary.total_transportation|yen }}</td>
                                <td class="px-4 py-3 font-bold text-red-700">{{ annual_summary.total_all_deductions|yen }}</td>
                                <td class="px-4 py-3 font-bold text-orange-700">{{ annual_summary.avg_deduction_rate }}%</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º -->
                    <div class="md:hidden grid grid-cols-2 gap-2">
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">çµ¦ä¸ç·æ”¯çµ¦é¡</div>
                        <div class="text-base font-bold text-green-700">{{ annual_summary.total_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">è³ä¸ç·æ”¯çµ¦é¡</div>
                        <div class="text-base font-bold text-emerald-700">{{ annual_summary.total_bonus_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg col-span-2">
                        <div class="text-xs text-gray-600 mb-1">åˆè¨ˆç·æ”¯çµ¦é¡</div>
                        <div class="text-lg font-bold text-green-800">{{ annual_summary.total_all_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">ç·æ”¯çµ¦é¡-äº¤é€šè²»</div>
                        <div class="text-base font-bold text-blue-700">{{ annual_summary.gross_minus_transport|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">å·®å¼•æ”¯çµ¦é¡åˆè¨ˆ</div>
                        <div class="text-base font-bold text-purple-700">{{ annual_summary.total_all_net|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">äº¤é€šè²»</div>
                        <div class="text-base font-bold text-teal-700">{{ annual_summary.total_transportation|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">æ§é™¤åˆè¨ˆ</div>
                        <div class="text-base font-bold text-red-700">{{ annual_summary.total_all_deductions|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg col-span-2">
                        <div class="text-xs text-gray-600 mb-1">å¹³å‡æ§é™¤ç‡</div>
                        <div class="text-lg font-bold text-orange-700">{{ annual_summary.avg_deduction_rate }}%</div>
                    </div>
                    </div>
                </div>

                <!-- æœˆåˆ¥æ˜ç´°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                <div id="details-{{ annual_summary.year }}" class="mt-2">
                    {% with year_plans=salary_plans|filter_by_year:annual_summary.year %}
                    {% if year_plans %}
                    <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤ºï¼šãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="min-w-full text-sm border">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600">
                                    <th class="px-4 py-3 text-left font-semibold">å¹´æœˆ</th>
                                    <th class="px-4 py-3 text-right font-semibold">ç·æ”¯çµ¦é¡</th>
                                    <th class="px-4 py-3 text-right font-semibold">ç·æ”¯çµ¦é¡-äº¤é€šè²»</th>
                                    <th class="px-4 py-3 text-right font-semibold">å·®å¼•æ”¯çµ¦é¡</th>
                                    <th class="px-4 py-3 text-right font-semibold">äº¤é€šè²»</th>
                                    <th class="px-4 py-3 text-right font-semibold">æ§é™¤åˆè¨ˆ</th>
                                    <th class="px-4 py-3 text-right font-semibold">æ§é™¤ç‡</th>
                                    <th class="px-4 py-3 text-center font-semibold">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in year_plans %}
                                {% if plan.bonus and plan.bonus > 0 %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">è³ä¸ ({{ plan.year_month|format_year_month }})</td>
                                    <td class="px-4 py-3 text-right text-emerald-700 font-semibold">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {{ plan.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-blue-700">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {{ plan.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-violet-700 font-semibold">{{ plan.bonus|yen }}</td>
                                    <td class="px-4 py-3 text-right text-teal-700">-</td>
                                    <td class="px-4 py-3 text-right text-rose-700">
                                        {% if plan.bonus_deductions and plan.bonus_deductions > 0 %}
                                            {{ plan.bonus_deductions|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-orange-700">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {% widthratio plan.bonus_deductions plan.bonus_gross_salary 100 as bonus_deduction_pct %}
                                            {{ bonus_deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="openEditBonusModal({{ plan.pk }}, '{{ plan.year_month }}', {{ plan.bonus_gross_salary|default:0 }}, {{ plan.bonus_deductions|default:0 }})" class="text-blue-600 hover:text-blue-800 text-xs mr-2">ç·¨é›†</button>
                                        <button onclick="deletePlan({{ plan.pk }})" class="text-red-600 hover:text-red-800 text-xs">å‰Šé™¤</button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% if plan.gross_salary and plan.gross_salary > 0 %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">{{ plan.year_month|format_year_month }}</td>
                                    <td class="px-4 py-3 text-right text-green-700 font-semibold">{{ plan.gross_salary|yen }}</td>
                                    <td class="px-4 py-3 text-right text-blue-700">{{ plan.gross_salary|subtract:plan.transportation|yen }}</td>
                                    <td class="px-4 py-3 text-right text-purple-700 font-semibold">{{ plan.salary|yen }}</td>
                                    <td class="px-4 py-3 text-right text-teal-700">{{ plan.transportation|yen }}</td>
                                    <td class="px-4 py-3 text-right text-red-700">{{ plan.deductions|yen }}</td>
                                    <td class="px-4 py-3 text-right text-orange-700">
                                        {% if plan.gross_salary and plan.transportation %}
                                            {% widthratio plan.deductions plan.gross_salary|subtract:plan.transportation 100 as deduction_pct %}
                                            {{ deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="openEditSalaryModal({{ plan.pk }}, '{{ plan.year_month }}', {{ plan.gross_salary|default:0 }}, {{ plan.deductions|default:0 }}, {{ plan.transportation|default:0 }})" class="text-blue-600 hover:text-blue-800 text-xs mr-2">ç·¨é›†</button>
                                        <button onclick="deletePlan({{ plan.pk }})" class="text-red-600 hover:text-red-800 text-xs">å‰Šé™¤</button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºï¼šã‚«ãƒ¼ãƒ‰å½¢å¼ -->
                    <div class="md:hidden space-y-2">
                        {% for plan in year_plans %}
                        {% if plan.bonus and plan.bonus > 0 %}
                        <div class="border rounded-lg p-4 bg-white shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-lg text-gray-800">è³ä¸ ({{ plan.year_month|format_year_month }})</div>
                                <div class="flex gap-2">
                                    <button onclick="openEditBonusModal({{ plan.pk }}, '{{ plan.year_month }}', {{ plan.bonus_gross_salary|default:0 }}, {{ plan.bonus_deductions|default:0 }})" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨é›†</button>
                                    <button onclick="deletePlan({{ plan.pk }})" class="text-red-600 hover:text-red-800 text-sm">å‰Šé™¤</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">ç·æ”¯çµ¦é¡</div>
                                    <div class="font-semibold text-emerald-700">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {{ plan.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">ç·æ”¯çµ¦é¡-äº¤é€šè²»</div>
                                    <div class="font-semibold text-blue-700">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {{ plan.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">å·®å¼•æ”¯çµ¦é¡</div>
                                    <div class="font-semibold text-violet-700">{{ plan.bonus|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">äº¤é€šè²»</div>
                                    <div class="font-semibold text-teal-700">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">æ§é™¤åˆè¨ˆ</div>
                                    <div class="font-semibold text-rose-700">
                                        {% if plan.bonus_deductions and plan.bonus_deductions > 0 %}
                                            {{ plan.bonus_deductions|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">æ§é™¤ç‡</div>
                                    <div class="font-semibold text-orange-700">
                                        {% if plan.bonus_gross_salary and plan.bonus_gross_salary > 0 %}
                                            {% widthratio plan.bonus_deductions plan.bonus_gross_salary 100 as bonus_deduction_pct %}
                                            {{ bonus_deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if plan.gross_salary and plan.gross_salary > 0 %}
                        <div class="border rounded-lg p-4 bg-white shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-lg text-gray-800">{{ plan.year_month|format_year_month }}</div>
                                <div class="flex gap-2">
                                    <button onclick="openEditSalaryModal({{ plan.pk }}, '{{ plan.year_month }}', {{ plan.gross_salary|default:0 }}, {{ plan.deductions|default:0 }}, {{ plan.transportation|default:0 }})" class="text-blue-600 hover:text-blue-800 text-sm">ç·¨é›†</button>
                                    <button onclick="deletePlan({{ plan.pk }})" class="text-red-600 hover:text-red-800 text-sm">å‰Šé™¤</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">ç·æ”¯çµ¦é¡</div>
                                    <div class="font-semibold text-green-700">{{ plan.gross_salary|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">ç·æ”¯çµ¦é¡-äº¤é€šè²»</div>
                                    <div class="font-semibold text-blue-700">{{ plan.gross_salary|subtract:plan.transportation|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">å·®å¼•æ”¯çµ¦é¡</div>
                                    <div class="font-semibold text-purple-700">{{ plan.salary|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">äº¤é€šè²»</div>
                                    <div class="font-semibold text-teal-700">{{ plan.transportation|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">æ§é™¤åˆè¨ˆ</div>
                                    <div class="font-semibold text-red-700">{{ plan.deductions|yen }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-600 mb-1">æ§é™¤ç‡</div>
                                    <div class="font-semibold text-orange-700">
                                        {% if plan.gross_salary and plan.transportation %}
                                            {% widthratio plan.deductions plan.gross_salary|subtract:plan.transportation 100 as deduction_pct %}
                                            {{ deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-600">çµ¦ä¸æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    {% endif %}
                    {% endwith %}
                </div>
        </div>

        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-600">çµ¦ä¸æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœˆæ¬¡è¨ˆç”»ã§çµ¦ä¸æ˜ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    {% endif %}
</div>

<script>
    // æœˆåˆ¥æ˜ç´°ã®æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹
    function toggleDetails(detailsId) {
        const details = document.getElementById(detailsId);
        const icon = document.getElementById(detailsId + '-icon');

        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            details.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    // å‰Šé™¤æ©Ÿèƒ½
    function deletePlan(planId) {
        if (confirm('ã“ã®çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            fetch(`/plans/${planId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    window.showToast('çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    window.showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Djangoãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒˆãƒ¼ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤º
        {% if messages %}
            {% for message in messages %}
                window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
            {% endfor %}
        {% endif %}
    });
</script>

<!-- çµ¦ä¸ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="salaryModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 max-h-[95vh] overflow-y-auto" onclick="event.stopPropagation()">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-2xl px-4 py-3 flex justify-between items-center sticky top-0 z-10">
            <h3 class="text-lg font-bold text-white">éå»ã®çµ¦ä¸ä½œæˆ</h3>
            <button type="button" onclick="closeSalaryModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="salaryForm" method="post" action="{% url 'budget_app:plan_create' %}" class="p-4 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="past_mode" value="true">

            <!-- å¹´æœˆ -->
            <div id="yearMonthSelectsContainer" class="grid grid-cols-2 gap-3" style="display: none;">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">å¹´</label>
                    <select id="salaryYearSelect" name="year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">æœˆ</label>
                    <select id="salaryMonthSelect" name="month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
            </div>
            <input type="hidden" name="year_month" id="salaryYearMonth">

            <div id="salaryFormFields">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeSalaryModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium transition shadow-md text-sm">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
function openSalaryModal() {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    modalTitle.textContent = 'éå»ã®çµ¦ä¸ä½œæˆ';

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    salaryForm.action = '{% url "budget_app:plan_create" %}';

    // past_modeã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
    let pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (!pastModeInput) {
        pastModeInput = document.createElement('input');
        pastModeInput.type = 'hidden';
        pastModeInput.name = 'past_mode';
        pastModeInput.value = 'true';
        salaryForm.insertBefore(pastModeInput, salaryForm.firstChild);
    }

    // å¹´æœˆé¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'grid';
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    formFields.innerHTML = '';

    initializeSalaryForm();
    modal.classList.remove('hidden');
}

function closeSalaryModal(event) {
    if (event && event.target !== event.currentTarget && event !== undefined) return;
    const modal = document.getElementById('salaryModal');
    modal.classList.add('hidden');
}

function initializeSalaryForm() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');

    const registeredMonths = {{ registered_year_months|safe|default:"[]" }};
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆéå»3å¹´åˆ†ã€æœªç™»éŒ²ã®æœˆãŒã‚ã‚‹å¹´ã®ã¿ï¼‰
    yearSelect.innerHTML = '';
    for (let year = currentYear; year >= currentYear - 3; year--) {
        // ã“ã®å¹´ã«æœªç™»éŒ²ã®éå»ã®æœˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        let hasUnregisteredPastMonth = false;
        for (let month = 1; month <= 12; month++) {
            const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
            // éå»ã®æœˆï¼ˆä»Šæœˆã‚ˆã‚Šå‰ï¼‰ã‹ã¤æœªç™»éŒ²ã®æœˆãŒã‚ã‚‹ã‹
            if (year < currentYear || (year === currentYear && month < currentMonth)) {
                if (!registeredMonths.includes(yearMonth)) {
                    hasUnregisteredPastMonth = true;
                    break;
                }
            }
        }

        // æœªç™»éŒ²ã®éå»ã®æœˆãŒã‚ã‚‹å¹´ã®ã¿è¿½åŠ 
        if (hasUnregisteredPastMonth) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + 'å¹´';
            yearSelect.appendChild(option);
        }
    }

    // é¸æŠè‚¢ãŒãªã„å ´åˆã®å‡¦ç†
    if (yearSelect.options.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'é¸æŠå¯èƒ½ãªæœˆãŒã‚ã‚Šã¾ã›ã‚“';
        yearSelect.appendChild(option);
        monthSelect.innerHTML = '';
        return;
    }

    // æœˆã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
    updateSalaryMonthOptions();

    // å¹´ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æœˆã®é¸æŠè‚¢ã‚’æ›´æ–°
    yearSelect.addEventListener('change', updateSalaryMonthOptions);
    monthSelect.addEventListener('change', updateSalaryYearMonth);

    // åˆæœŸå€¤ã‚’è¨­å®š
    updateSalaryYearMonth();

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
    generateSalaryFormFields();
}

function generateSalaryFormFields() {
    const formFields = document.getElementById('salaryFormFields');
    const defaultItems = {{ default_items_json|safe|default:"[]" }};

    formFields.innerHTML = '';

    // åå…¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµ¦ä¸æ˜ç´°ã®ã¿ï¼‰
    const incomeSection = document.createElement('div');
    incomeSection.className = 'bg-green-50 p-4 rounded-lg';
    incomeSection.innerHTML = '<h4 class="font-semibold text-sm text-green-800 mb-3">ğŸ’° çµ¦ä¸æ˜ç´°</h4>';

    const incomeGrid = document.createElement('div');
    incomeGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

    // çµ¦ä¸æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const salaryFields = [
        {name: 'gross_salary', label: 'ç·æ”¯çµ¦é¡', defaultValue: 0},
        {name: 'deductions', label: 'æ§é™¤é¡', defaultValue: 0},
        {name: 'transportation', label: 'äº¤é€šè²»', defaultValue: 0},
    ];

    salaryFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-semibold text-gray-700 mb-1">${field.label}ï¼ˆå††ï¼‰</label>
            <input type="number" name="${field.name}" value="${field.defaultValue}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
        `;
        incomeGrid.appendChild(div);
    });

    incomeSection.appendChild(incomeGrid);
    formFields.appendChild(incomeSection);
}

function updateSalaryMonthOptions() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');
    const selectedYear = parseInt(yearSelect.value);
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    const registeredMonths = {{ registered_year_months|safe|default:"[]" }};

    monthSelect.innerHTML = '';

    for (let month = 1; month <= 12; month++) {
        const yearMonth = `${selectedYear}-${String(month).padStart(2, '0')}`;

        // éå»ã®æœˆï¼ˆä»Šæœˆã‚ˆã‚Šå‰ï¼‰ã‹ã¤æœªç™»éŒ²ã®æœˆã®ã¿è¡¨ç¤º
        if (selectedYear < currentYear || (selectedYear === currentYear && month < currentMonth)) {
            if (!registeredMonths.includes(yearMonth)) {
                const option = document.createElement('option');
                option.value = String(month).padStart(2, '0');
                option.textContent = month + 'æœˆ';
                monthSelect.appendChild(option);
            }
        }
    }

    updateSalaryYearMonth();
}

function updateSalaryYearMonth() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');
    const yearMonthInput = document.getElementById('salaryYearMonth');

    if (yearSelect && monthSelect && yearMonthInput) {
        const year = yearSelect.value;
        const month = monthSelect.value;
        yearMonthInput.value = `${year}-${month}`;
    }
}

// çµ¦ä¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openEditSalaryModal(planId, yearMonth, grossSalary, deductions, transportation) {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    modalTitle.textContent = 'çµ¦ä¸ç·¨é›†';

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†URLã«å¤‰æ›´
    salaryForm.action = `/plans/${planId}/edit/`;

    // past_modeã‚’å‰Šé™¤
    const pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (pastModeInput) {
        pastModeInput.remove();
    }

    // å¹´æœˆé¸æŠã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'none';
    }

    // å¹´æœˆã‚’åˆ†è§£
    const [year, month] = yearMonth.split('-');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
    formFields.innerHTML = '';

    // å¹´æœˆã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡
    const yearMonthHidden = document.createElement('div');
    yearMonthHidden.innerHTML = `
        <input type="hidden" name="year" value="${year}">
        <input type="hidden" name="month" value="${month}">
        <input type="hidden" name="year_month" value="${yearMonth}">
    `;
    formFields.appendChild(yearMonthHidden);

    // çµ¦ä¸æ˜ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const incomeSection = document.createElement('div');
    incomeSection.className = 'bg-green-50 p-4 rounded-lg';
    incomeSection.innerHTML = '<h4 class="font-semibold text-sm text-green-800 mb-3">ğŸ’° çµ¦ä¸æ˜ç´°</h4>';

    const incomeGrid = document.createElement('div');
    incomeGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

    // çµ¦ä¸æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const salaryFields = [
        {name: 'gross_salary', label: 'ç·æ”¯çµ¦é¡', value: grossSalary},
        {name: 'deductions', label: 'æ§é™¤é¡', value: deductions},
        {name: 'transportation', label: 'äº¤é€šè²»', value: transportation},
    ];

    salaryFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-semibold text-gray-700 mb-1">${field.label}ï¼ˆå††ï¼‰</label>
            <input type="number" name="${field.name}" value="${field.value}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
        `;
        incomeGrid.appendChild(div);
    });

    incomeSection.appendChild(incomeGrid);
    formFields.appendChild(incomeSection);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    modal.classList.remove('hidden');
}

// ãƒœãƒ¼ãƒŠã‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openEditBonusModal(planId, yearMonth, bonusGrossSalary, bonusDeductions) {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    modalTitle.textContent = 'ãƒœãƒ¼ãƒŠã‚¹ç·¨é›†';

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†URLã«å¤‰æ›´
    salaryForm.action = `/plans/${planId}/edit/`;

    // past_modeã‚’å‰Šé™¤
    const pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (pastModeInput) {
        pastModeInput.remove();
    }

    // å¹´æœˆé¸æŠã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'none';
    }

    // å¹´æœˆã‚’åˆ†è§£
    const [year, month] = yearMonth.split('-');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
    formFields.innerHTML = '';

    // å¹´æœˆã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é€ä¿¡
    const yearMonthHidden = document.createElement('div');
    yearMonthHidden.innerHTML = `
        <input type="hidden" name="year" value="${year}">
        <input type="hidden" name="month" value="${month}">
        <input type="hidden" name="year_month" value="${yearMonth}">
    `;
    formFields.appendChild(yearMonthHidden);

    // ãƒœãƒ¼ãƒŠã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const bonusSection = document.createElement('div');
    bonusSection.className = 'bg-emerald-50 p-4 rounded-lg';
    bonusSection.innerHTML = '<h4 class="font-semibold text-sm text-emerald-800 mb-3">ğŸ ãƒœãƒ¼ãƒŠã‚¹æ˜ç´°</h4>';

    const bonusGrid = document.createElement('div');
    bonusGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

    const bonusFields = [
        {name: 'bonus_gross_salary', label: 'ãƒœãƒ¼ãƒŠã‚¹ç·æ”¯çµ¦é¡', value: bonusGrossSalary},
        {name: 'bonus_deductions', label: 'ãƒœãƒ¼ãƒŠã‚¹æ§é™¤é¡', value: bonusDeductions}
    ];

    bonusFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-semibold text-gray-700 mb-1">${field.label}ï¼ˆå††ï¼‰</label>
            <input type="number" name="${field.name}" value="${field.value}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
        `;
        bonusGrid.appendChild(div);
    });

    bonusSection.appendChild(bonusGrid);
    formFields.appendChild(bonusSection);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    modal.classList.remove('hidden');
}
</script>
{% endblock %}
