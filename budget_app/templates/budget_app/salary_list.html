{% extends 'budget_app/base.html' %}
{% load humanize budget_filters %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 md:p-8 max-w-7xl mx-auto">
    <div class="mb-4 md:mb-6 flex items-center justify-between">
        <h2 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
            給与一覧
        </h2>
        <button onclick="openSalaryModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            過去の給与登録
        </button>
    </div>

    <!-- 年間集計と明細 -->
    {% if annual_summaries %}
    <div class="space-y-3">
        {% for annual_summary in annual_summaries %}
        {% if annual_summary.count > 0 %}

        <!-- 年ごとのセクション -->
        <div class="bg-white rounded-lg shadow-md p-4">
            <button type="button" onclick="toggleDetails('details-{{ annual_summary.year }}')" class="w-full flex items-center justify-between mb-2 hover:bg-gray-50 -mx-4 px-4 py-2 rounded-t-lg transition">
                <h3 class="text-lg font-bold text-gray-800">{{ annual_summary.year|stringformat:'d' }}年（{{ annual_summary.count }}ヶ月分）</h3>
                <svg id="details-{{ annual_summary.year }}-icon" class="w-5 h-5 transform transition-transform rotate-180 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>

            <!-- 年間集計（常に表示） -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-lg mb-2">

                    <!-- デスクトップ表示 -->
                    <div class="hidden xl:block overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="bg-blue-100">
                                    <th class="px-4 py-2 text-left font-semibold">給与総支給額</th>
                                    <th class="px-4 py-2 text-left font-semibold">賞与総支給額</th>
                                    <th class="px-4 py-2 text-left font-semibold">合計総支給額</th>
                                    <th class="px-4 py-2 text-left font-semibold">総支給額-交通費</th>
                                    <th class="px-4 py-2 text-left font-semibold">差引支給額合計</th>
                                    <th class="px-4 py-2 text-left font-semibold">交通費</th>
                                    <th class="px-4 py-2 text-left font-semibold">控除合計</th>
                                    <th class="px-4 py-2 text-left font-semibold">平均控除率</th>
                                </tr>
                            </thead>
                        <tbody>
                            <tr class="bg-white">
                                <td class="px-4 py-3 font-bold text-green-700">{{ annual_summary.total_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-emerald-700">{{ annual_summary.total_bonus_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-green-800">{{ annual_summary.total_all_gross|yen }}</td>
                                <td class="px-4 py-3 font-bold text-blue-700">{{ annual_summary.gross_minus_transport|yen }}</td>
                                <td class="px-4 py-3 font-bold text-purple-700">{{ annual_summary.total_all_net|yen }}</td>
                                <td class="px-4 py-3 font-bold text-teal-700">{{ annual_summary.total_transportation|yen }}</td>
                                <td class="px-4 py-3 font-bold text-red-700">{{ annual_summary.total_all_deductions|yen }}</td>
                                <td class="px-4 py-3 font-bold text-orange-700">{{ annual_summary.avg_deduction_rate }}%</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- モバイル表示 -->
                    <div class="xl:hidden grid grid-cols-2 gap-2">
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">給与総支給額</div>
                        <div class="text-base font-bold text-green-700">{{ annual_summary.total_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">賞与総支給額</div>
                        <div class="text-base font-bold text-emerald-700">{{ annual_summary.total_bonus_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg col-span-2">
                        <div class="text-xs text-gray-600 mb-1">合計総支給額</div>
                        <div class="text-lg font-bold text-green-800">{{ annual_summary.total_all_gross|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">総支給額-交通費</div>
                        <div class="text-base font-bold text-blue-700">{{ annual_summary.gross_minus_transport|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">差引支給額合計</div>
                        <div class="text-base font-bold text-purple-700">{{ annual_summary.total_all_net|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">交通費</div>
                        <div class="text-base font-bold text-teal-700">{{ annual_summary.total_transportation|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        <div class="text-xs text-gray-600 mb-1">控除合計</div>
                        <div class="text-base font-bold text-red-700">{{ annual_summary.total_all_deductions|yen }}</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg col-span-2">
                        <div class="text-xs text-gray-600 mb-1">平均控除率</div>
                        <div class="text-lg font-bold text-orange-700">{{ annual_summary.avg_deduction_rate }}%</div>
                    </div>
                    </div>
                </div>

                <!-- 月別明細（折りたたみ可能） -->
                <div id="details-{{ annual_summary.year }}" class="mt-2">
                    {% with year_salaries=salaries|filter_by_year:annual_summary.year %}
                    {% if year_salaries %}
                    <!-- デスクトップ表示：テーブル -->
                    <div class="hidden xl:block overflow-x-auto">
                        <table class="min-w-full text-sm border">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600">
                                    <th class="px-4 py-3 text-left font-semibold">年月</th>
                                    <th class="px-4 py-3 text-right font-semibold">総支給額</th>
                                    <th class="px-4 py-3 text-right font-semibold">総支給額-交通費</th>
                                    <th class="px-4 py-3 text-right font-semibold">差引支給額</th>
                                    <th class="px-4 py-3 text-right font-semibold">交通費</th>
                                    <th class="px-4 py-3 text-right font-semibold">控除合計</th>
                                    <th class="px-4 py-3 text-right font-semibold">控除率</th>
                                    <th class="px-4 py-3 text-center font-semibold">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for salary in year_salaries %}
                                {% if salary.has_bonus %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">賞与 ({{ salary.year_month|format_year_month }})</td>
                                    <td class="px-4 py-3 text-right text-emerald-700 font-semibold">
                                        {% if salary.bonus_gross_salary and salary.bonus_gross_salary > 0 %}
                                            {{ salary.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-blue-700">
                                        {% if salary.bonus_gross_salary and salary.bonus_gross_salary > 0 %}
                                            {{ salary.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-violet-700 font-semibold">{{ salary.get_net_bonus|yen }}</td>
                                    <td class="px-4 py-3 text-right text-teal-700">-</td>
                                    <td class="px-4 py-3 text-right text-rose-700">
                                        {% if salary.bonus_deductions and salary.bonus_deductions > 0 %}
                                            {{ salary.bonus_deductions|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-orange-700">
                                        {% if salary.bonus_gross_salary and salary.bonus_gross_salary > 0 %}
                                            {% widthratio salary.bonus_deductions salary.bonus_gross_salary 100 as bonus_deduction_pct %}
                                            {{ bonus_deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="openEditBonusModal({{ salary.pk }}, '{{ salary.year_month }}', {{ salary.bonus_gross_salary|default:0|stringformat:'d' }}, {{ salary.bonus_deductions|default:0|stringformat:'d' }})" class="text-blue-600 hover:text-blue-800 mr-2">
                                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="deleteSalary({{ salary.pk }})" class="text-red-600 hover:text-red-800">
                                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% if salary.gross_salary and salary.gross_salary > 0 %}
                                <tr id="salary-{{ salary.year_month }}" class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium">{{ salary.year_month|format_year_month }}</td>
                                    <td class="px-4 py-3 text-right text-green-700 font-semibold">{{ salary.gross_salary|yen }}</td>
                                    <td class="px-4 py-3 text-right text-blue-700">{{ salary.gross_salary|subtract:salary.transportation|yen }}</td>
                                    <td class="px-4 py-3 text-right text-purple-700 font-semibold">{{ salary.get_net_salary|yen }}</td>
                                    <td class="px-4 py-3 text-right text-teal-700">{{ salary.transportation|yen }}</td>
                                    <td class="px-4 py-3 text-right text-red-700">{{ salary.deductions|yen }}</td>
                                    <td class="px-4 py-3 text-right text-orange-700">
                                        {% if salary.gross_salary and salary.transportation %}
                                            {% widthratio salary.deductions salary.gross_salary|subtract:salary.transportation 100 as deduction_pct %}
                                            {{ deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="openEditSalaryModal({{ salary.pk }}, '{{ salary.year_month }}', {{ salary.gross_salary|default:0|stringformat:'d' }}, {{ salary.deductions|default:0|stringformat:'d' }}, {{ salary.transportation|default:0|stringformat:'d' }}, {{ salary.has_bonus|yesno:'true,false' }}, {{ salary.bonus_gross_salary|default:0|stringformat:'d' }}, {{ salary.bonus_deductions|default:0|stringformat:'d' }})" class="text-blue-600 hover:text-blue-800 mr-2">
                                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="deleteSalary({{ salary.pk }})" class="text-red-600 hover:text-red-800">
                                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- モバイル表示：カード形式 -->
                    <div class="xl:hidden space-y-2">
                        {% for salary in year_salaries %}
                        {% if salary.has_bonus %}
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg shadow-md overflow-hidden">
                            <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-3 py-2 flex justify-between items-center">
                                <div class="font-bold text-sm">賞与 ({{ salary.year_month|format_year_month }})</div>
                                <div class="flex gap-1">
                                    <button onclick="openEditBonusModal({{ salary.pk }}, '{{ salary.year_month }}', {{ salary.bonus_gross_salary|default:0|stringformat:'d' }}, {{ salary.bonus_deductions|default:0|stringformat:'d' }})" class="text-white hover:text-emerald-100 w-8 h-8 flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="deleteSalary({{ salary.pk }})" class="text-white hover:text-red-200 w-8 h-8 flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">総支給額</div>
                                    <div class="font-bold text-emerald-700 text-sm">
                                        {% if salary.bonus_gross_salary and salary.bonus_gross_salary > 0 %}
                                            {{ salary.bonus_gross_salary|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">差引支給額</div>
                                    <div class="font-bold text-violet-700 text-sm">{{ salary.get_net_bonus|yen }}</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">控除額</div>
                                    <div class="font-bold text-rose-700 text-sm">
                                        {% if salary.bonus_deductions and salary.bonus_deductions > 0 %}
                                            {{ salary.bonus_deductions|yen }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">控除率</div>
                                    <div class="font-bold text-orange-700 text-sm">
                                        {% if salary.bonus_gross_salary and salary.bonus_gross_salary > 0 %}
                                            {% widthratio salary.bonus_deductions salary.bonus_gross_salary 100 as bonus_deduction_pct %}
                                            {{ bonus_deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if salary.gross_salary and salary.gross_salary > 0 %}
                        <div id="salary-{{ salary.year_month }}" class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-md overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-3 py-2 flex justify-between items-center">
                                <div class="font-bold text-sm">{{ salary.year_month|format_year_month }}</div>
                                <div class="flex gap-2">
                                    <button onclick="openEditSalaryModal({{ salary.pk }}, '{{ salary.year_month }}', {{ salary.gross_salary|default:0|stringformat:'d' }}, {{ salary.deductions|default:0|stringformat:'d' }}, {{ salary.transportation|default:0|stringformat:'d' }}, {{ salary.has_bonus|yesno:'true,false' }}, {{ salary.bonus_gross_salary|default:0|stringformat:'d' }}, {{ salary.bonus_deductions|default:0|stringformat:'d' }})" class="text-white hover:text-blue-100">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="deleteSalary({{ salary.pk }})" class="text-white hover:text-red-200">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">総支給額</div>
                                    <div class="font-bold text-green-700 text-sm">{{ salary.gross_salary|yen }}</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">差引支給額</div>
                                    <div class="font-bold text-purple-700 text-sm">{{ salary.get_net_salary|yen }}</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">控除額</div>
                                    <div class="font-bold text-red-700 text-sm">{{ salary.deductions|yen }}</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-500 text-xs mb-0.5">控除率</div>
                                    <div class="font-bold text-orange-700 text-sm">
                                        {% if salary.gross_salary and salary.transportation %}
                                            {% widthratio salary.deductions salary.gross_salary|subtract:salary.transportation 100 as deduction_pct %}
                                            {{ deduction_pct|floatformat:2 }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-600">給与明細データがありません。</p>
                    {% endif %}
                    {% endwith %}
                </div>
        </div>

        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-600">給与明細データがありません。月次計画で給与明細を入力してください。</p>
    {% endif %}
</div>

<script>
    // 月別明細の折りたたみ/展開
    function toggleDetails(detailsId) {
        const details = document.getElementById(detailsId);
        const icon = document.getElementById(detailsId + '-icon');

        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            details.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    // 削除機能
    function deleteSalary(salaryId) {
        if (confirm('この給与データを削除してもよろしいですか？')) {
            fetch(`/salaries/${salaryId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    window.showToast('給与データを削除しました', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    window.showToast('削除に失敗しました', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.showToast('削除に失敗しました', 'error');
            });
        }
    }

    // CSRFトークンを取得
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Djangoメッセージをトーストとして表示
        {% if messages %}
            {% for message in messages %}
                window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
            {% endfor %}
        {% endif %}
    });
</script>

<!-- 給与登録モーダル -->
<div id="salaryModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-lg sm:rounded-2xl transform transition-all my-2 sm:my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden" onclick="event.stopPropagation()">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-lg sm:rounded-t-2xl px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center sticky top-0 z-10">
            <h3 class="text-base sm:text-lg font-bold text-white">過去の給与登録</h3>
            <button type="button" onclick="closeSalaryModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="salaryForm" method="post" action="{% url 'budget_app:salary_create' %}" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
            {% csrf_token %}
            <input type="hidden" name="past_mode" value="true">

            <!-- 年月 -->
            <div id="yearMonthSelectsContainer" class="grid grid-cols-2 gap-2 sm:gap-3" style="display: none;">
                <div>
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">年</label>
                    <select id="salaryYearSelect" name="year" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                        <!-- JavaScriptで動的に生成 -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">月</label>
                    <select id="salaryMonthSelect" name="month" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                        <!-- JavaScriptで動的に生成 -->
                    </select>
                </div>
            </div>
            <input type="hidden" name="year_month" id="salaryYearMonth">

            <div id="salaryFormFields">
                <!-- JavaScriptで動的に生成 -->
            </div>

            <!-- ボタン -->
            <div class="flex gap-2 pt-2 sm:pt-3">
                <button type="button" onclick="closeSalaryModal()" class="flex-1 px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-3 sm:px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// モーダル関連の関数
function openSalaryModal() {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // タイトルをリセット
    modalTitle.textContent = '過去の給与登録';

    // フォームアクションをリセット
    salaryForm.action = '{% url "budget_app:salary_create" %}';

    // past_modeを追加（存在しない場合）
    let pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (!pastModeInput) {
        pastModeInput = document.createElement('input');
        pastModeInput.type = 'hidden';
        pastModeInput.name = 'past_mode';
        pastModeInput.value = 'true';
        salaryForm.insertBefore(pastModeInput, salaryForm.firstChild);
    }

    // 年月選択フィールドを表示
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'grid';
    }

    // フォームフィールドをクリア
    formFields.innerHTML = '';

    initializeSalaryForm();
    modal.classList.remove('hidden');
}

function closeSalaryModal(event) {
    if (event && event.target !== event.currentTarget && event !== undefined) return;
    const modal = document.getElementById('salaryModal');
    modal.classList.add('hidden');
}

function initializeSalaryForm() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');

    const registeredMonths = {{ registered_year_months|safe|default:"[]" }};
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    // 年の選択肢を生成（過去3年分、未登録の月がある年のみ）
    yearSelect.innerHTML = '';
    for (let year = currentYear; year >= currentYear - 3; year--) {
        // この年に未登録の過去の月があるかチェック
        let hasUnregisteredPastMonth = false;
        for (let month = 1; month <= 12; month++) {
            const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
            // 過去の月（今月を含む）かつ未登録の月があるか
            if (year < currentYear || (year === currentYear && month <= currentMonth)) {
                if (!registeredMonths.includes(yearMonth)) {
                    hasUnregisteredPastMonth = true;
                    break;
                }
            }
        }

        // 未登録の過去の月がある年のみ追加
        if (hasUnregisteredPastMonth) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + '年';
            yearSelect.appendChild(option);
        }
    }

    // 選択肢がない場合の処理
    if (yearSelect.options.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '選択可能な月がありません';
        yearSelect.appendChild(option);
        monthSelect.innerHTML = '';
        return;
    }

    // 月の選択肢を生成
    updateSalaryMonthOptions();

    // 年が変更されたら月の選択肢を更新
    yearSelect.addEventListener('change', updateSalaryMonthOptions);
    monthSelect.addEventListener('change', updateSalaryYearMonth);

    // 初期値を設定
    updateSalaryYearMonth();

    // フォームフィールドを生成
    generateSalaryFormFields();
}

function generateSalaryFormFields() {
    const formFields = document.getElementById('salaryFormFields');
    const defaultItems = {{ default_items_json|safe|default:"[]" }};

    formFields.innerHTML = '';

    // 収入セクション（給与明細のみ）
    const incomeSection = document.createElement('div');
    incomeSection.className = 'bg-green-50 p-4 rounded-lg';
    incomeSection.innerHTML = '<h4 class="font-semibold text-sm text-green-800 mb-3 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>給与明細</h4>';

    const incomeGrid = document.createElement('div');
    incomeGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

    // 給与明細フィールド
    const salaryFields = [
        {name: 'gross_salary', label: '総支給額', defaultValue: 0},
        {name: 'deductions', label: '控除額', defaultValue: 0},
        {name: 'transportation', label: '交通費', defaultValue: 0},
    ];

    salaryFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-semibold text-gray-700 mb-1">${field.label}（円）</label>
            <input type="number" name="${field.name}" value="${field.defaultValue}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
        `;
        incomeGrid.appendChild(div);
    });

    incomeSection.appendChild(incomeGrid);
    formFields.appendChild(incomeSection);

    // ボーナスあり チェックボックス
    const bonusCheckboxDiv = document.createElement('div');
    bonusCheckboxDiv.className = 'mt-4';
    bonusCheckboxDiv.innerHTML = `
        <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="hasBonusCheckbox" name="has_bonus" value="true" class="w-4 h-4 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-500">
            <span class="ml-2 text-sm font-semibold text-gray-700">ボーナスあり</span>
        </label>
    `;
    formFields.appendChild(bonusCheckboxDiv);

    // ボーナス明細セクション（初期状態は非表示）
    const bonusSection = document.createElement('div');
    bonusSection.id = 'bonusSection';
    bonusSection.className = 'bg-emerald-50 p-4 rounded-lg mt-4 hidden';
    bonusSection.innerHTML = '<h4 class="font-semibold text-sm text-emerald-800 mb-3 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>ボーナス明細</h4>';

    const bonusGrid = document.createElement('div');
    bonusGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

    const bonusFields = [
        {name: 'bonus_gross_salary', label: 'ボーナス総支給額', defaultValue: 0},
        {name: 'bonus_deductions', label: 'ボーナス控除額', defaultValue: 0},
    ];

    bonusFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-sm font-semibold text-gray-700 mb-1">${field.label}（円）</label>
            <input type="number" name="${field.name}" value="${field.defaultValue}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
        `;
        bonusGrid.appendChild(div);
    });

    bonusSection.appendChild(bonusGrid);
    formFields.appendChild(bonusSection);

    // チェックボックスの変更イベント
    const hasBonusCheckbox = document.getElementById('hasBonusCheckbox');
    hasBonusCheckbox.addEventListener('change', function() {
        if (this.checked) {
            bonusSection.classList.remove('hidden');
        } else {
            bonusSection.classList.add('hidden');
        }
    });
}

function updateSalaryMonthOptions() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');
    const selectedYear = parseInt(yearSelect.value);
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    const registeredMonths = {{ registered_year_months|safe|default:"[]" }};

    monthSelect.innerHTML = '';

    for (let month = 1; month <= 12; month++) {
        const yearMonth = `${selectedYear}-${String(month).padStart(2, '0')}`;

        // 過去の月（今月を含む）かつ未登録の月のみ表示
        if (selectedYear < currentYear || (selectedYear === currentYear && month <= currentMonth)) {
            if (!registeredMonths.includes(yearMonth)) {
                const option = document.createElement('option');
                option.value = String(month).padStart(2, '0');
                option.textContent = month + '月';
                monthSelect.appendChild(option);
            }
        }
    }

    updateSalaryYearMonth();
}

function updateSalaryYearMonth() {
    const yearSelect = document.getElementById('salaryYearSelect');
    const monthSelect = document.getElementById('salaryMonthSelect');
    const yearMonthInput = document.getElementById('salaryYearMonth');

    if (yearSelect && monthSelect && yearMonthInput) {
        const year = yearSelect.value;
        const month = monthSelect.value;
        yearMonthInput.value = `${year}-${month}`;
    }
}

// 給与編集モーダルを開く
function openEditSalaryModal(planId, yearMonth, grossSalary, deductions, transportation, hasBonus, bonusGrossSalary, bonusDeductions) {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // タイトルを変更
    modalTitle.textContent = '給与編集';

    // フォームアクションを編集URLに変更
    salaryForm.action = `/salaries/${planId}/edit/`;

    // past_modeを削除
    const pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (pastModeInput) {
        pastModeInput.remove();
    }

    // 年月選択コンテナを非表示
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'none';
    }

    // 年月を分解
    const [year, month] = yearMonth.split('-');

    // フォームフィールドを生成
    formFields.innerHTML = '';

    // 年月表示エリア
    const yearMonthDisplay = document.createElement('div');
    yearMonthDisplay.className = 'mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200';
    yearMonthDisplay.innerHTML = `
        <div class="text-sm text-gray-600 mb-1">対象年月</div>
        <div class="text-xl font-bold text-gray-800">${year}年${parseInt(month)}月</div>
        <input type="hidden" name="year" value="${year}">
        <input type="hidden" name="month" value="${month}">
        <input type="hidden" name="year_month" value="${yearMonth}">
    `;
    formFields.appendChild(yearMonthDisplay);

    // 給与明細セクション
    const incomeSection = document.createElement('div');
    incomeSection.className = 'bg-green-50 p-3 sm:p-4 rounded-lg';
    incomeSection.innerHTML = '<h4 class="font-semibold text-sm text-green-800 mb-2 sm:mb-3 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>給与明細</h4>';

    const incomeGrid = document.createElement('div');
    incomeGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3';

    // 給与明細フィールド
    const salaryFields = [
        {name: 'gross_salary', label: '総支給額', value: grossSalary},
        {name: 'deductions', label: '控除額', value: deductions},
        {name: 'transportation', label: '交通費', value: transportation},
    ];

    salaryFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${field.label}（円）</label>
            <input type="number" name="${field.name}" value="${field.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
        `;
        incomeGrid.appendChild(div);
    });

    incomeSection.appendChild(incomeGrid);
    formFields.appendChild(incomeSection);

    // ボーナス未登録の場合のみ、ボーナスチェックボックスとセクションを表示
    if (!hasBonus) {
        // ボーナスありチェックボックス
        const bonusCheckboxDiv = document.createElement('div');
        bonusCheckboxDiv.className = 'mt-4';
        bonusCheckboxDiv.innerHTML = `
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="hasBonusCheckbox" name="has_bonus" value="true">
                <span class="ml-2">ボーナスあり</span>
            </label>
        `;
        formFields.appendChild(bonusCheckboxDiv);

        // ボーナス明細セクション
        const bonusSection = document.createElement('div');
        bonusSection.id = 'bonusSection';
        bonusSection.className = 'bg-emerald-50 p-3 sm:p-4 rounded-lg mt-3 sm:mt-4 hidden';
        bonusSection.innerHTML = '<h4 class="font-semibold text-sm text-emerald-800 mb-2 sm:mb-3 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>ボーナス明細</h4>';

        const bonusGrid = document.createElement('div');
        bonusGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3';

        // ボーナス明細フィールド
        const bonusFields = [
            {name: 'bonus_gross_salary', label: 'ボーナス総支給額', value: 0},
            {name: 'bonus_deductions', label: 'ボーナス控除額', value: 0},
        ];

        bonusFields.forEach(field => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${field.label}（円）</label>
                <input type="number" name="${field.name}" value="${field.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
            `;
            bonusGrid.appendChild(div);
        });

        bonusSection.appendChild(bonusGrid);
        formFields.appendChild(bonusSection);

        // チェックボックスの変更イベントを設定
        const hasBonusCheckbox = document.getElementById('hasBonusCheckbox');
        hasBonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                bonusSection.classList.remove('hidden');
            } else {
                bonusSection.classList.add('hidden');
            }
        });
    }

    // モーダルを表示
    modal.classList.remove('hidden');
}

// ボーナス編集モーダルを開く
function openEditBonusModal(planId, yearMonth, bonusGrossSalary, bonusDeductions) {
    const modal = document.getElementById('salaryModal');
    const modalTitle = modal.querySelector('h3');
    const salaryForm = document.getElementById('salaryForm');
    const formFields = document.getElementById('salaryFormFields');

    // タイトルを変更
    modalTitle.textContent = 'ボーナス編集';

    // フォームアクションを編集URLに変更
    salaryForm.action = `/salaries/${planId}/edit-bonus/`;

    // past_modeを削除
    const pastModeInput = salaryForm.querySelector('input[name="past_mode"]');
    if (pastModeInput) {
        pastModeInput.remove();
    }

    // 年月選択コンテナを非表示
    const yearMonthSelectsContainer = document.getElementById('yearMonthSelectsContainer');
    if (yearMonthSelectsContainer) {
        yearMonthSelectsContainer.style.display = 'none';
    }

    // 年月を分解
    const [year, month] = yearMonth.split('-');

    // フォームフィールドを生成
    formFields.innerHTML = '';

    // 年月表示エリア（ボーナス用）
    const yearMonthDisplay = document.createElement('div');
    yearMonthDisplay.className = 'mb-4 p-3 bg-emerald-50 rounded-lg border border-emerald-200';
    yearMonthDisplay.innerHTML = `
        <div class="text-sm text-emerald-600 mb-1">対象年月</div>
        <div class="text-xl font-bold text-emerald-800">${year}年${parseInt(month)}月 賞与</div>
        <input type="hidden" name="year" value="${year}">
        <input type="hidden" name="month" value="${month}">
        <input type="hidden" name="year_month" value="${yearMonth}">
    `;
    formFields.appendChild(yearMonthDisplay);

    // ボーナスセクション
    const bonusSection = document.createElement('div');
    bonusSection.className = 'bg-emerald-50 p-3 sm:p-4 rounded-lg';
    bonusSection.innerHTML = '<h4 class="font-semibold text-sm text-emerald-800 mb-2 sm:mb-3 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>ボーナス明細</h4>';

    const bonusGrid = document.createElement('div');
    bonusGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3';

    const bonusFields = [
        {name: 'bonus_gross_salary', label: 'ボーナス総支給額', value: bonusGrossSalary},
        {name: 'bonus_deductions', label: 'ボーナス控除額', value: bonusDeductions}
    ];

    bonusFields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${field.label}（円）</label>
            <input type="number" name="${field.name}" value="${field.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm">
        `;
        bonusGrid.appendChild(div);
    });

    bonusSection.appendChild(bonusGrid);
    formFields.appendChild(bonusSection);

    // モーダルを表示
    modal.classList.remove('hidden');
}

// フォーム送信処理（Ajax）
document.addEventListener('DOMContentLoaded', function() {
    const salaryForm = document.getElementById('salaryForm');

    salaryForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(salaryForm);
        const url = salaryForm.action;

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                closeSalaryModal();
                // target_urlがあればリダイレクト
                if (data.target_url) {
                    window.location.href = data.target_url;
                } else {
                    window.location.reload();
                }
            } else {
                alert(data.message || '登録に失敗しました');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('通信エラーが発生しました');
        }
    });

    // URLハッシュがあればスクロール
    if (window.location.hash) {
        setTimeout(() => {
            const targetId = window.location.hash.substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // ハイライト効果
                targetElement.style.transition = 'background-color 0.5s';
                const originalBg = targetElement.style.backgroundColor;
                targetElement.style.backgroundColor = '#fef3c7';
                setTimeout(() => {
                    targetElement.style.backgroundColor = originalBg;
                }, 1500);
            }
        }, 300);
    }
});
</script>
{% endblock %}
