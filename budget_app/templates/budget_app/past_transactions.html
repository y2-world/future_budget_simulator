{% extends 'budget_app/base.html' %}
{% load budget_filters %}

{% block title %}過去の明細{% endblock %}

{% block content %}
<!-- トースト通知 -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border-l-4 rounded-lg shadow-lg p-4 max-w-md">
        <div class="flex items-center">
            <div id="toast-icon" class="flex-shrink-0 mr-3"></div>
            <div id="toast-message" class="text-sm font-medium"></div>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
    <div class="mb-4 md:mb-6 flex justify-between items-center">
        <h1 class="text-2xl md:text-3xl font-bold">過去の明細</h1>
        <button onclick="openCreateModal()" class="bg-blue-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm md:text-base flex items-center gap-2">
            <span>新規追加</span>
        </button>
    </div>

    {% if not sorted_years %}
        <!-- データがない場合のメッセージ -->
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-600 text-lg font-medium">まだ過去の明細はありません</p>
            <p class="text-gray-500 text-sm mt-2">月次計画を作成すると、過去の月が自動的にここに表示されます</p>
        </div>
    {% else %}
        {% for year in sorted_years %}
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 pb-2 border-b-2 border-gray-300">
                    {{ year }}年
                </h2>

                <!-- デスクトップ表示 -->
                <div class="hidden xl:flex xl:gap-6 xl:items-start">
                    <!-- 月次計画 -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-blue-100 px-4 py-2 font-semibold text-blue-800">月次計画</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">収入</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">支出</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">純収支</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in yearly_data|get_item:year|get_item:'months' %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                            <span class="cursor-pointer" onclick="toggleDetails('desktop-plan-{{ year }}-{{ forloop.counter }}')">
                                                {{ item.year_month|format_year_month }}
                                                <span class="arrow-icon text-xs text-gray-400 ml-1">▼</span>
                                            </span>
                                            <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="ml-2 text-blue-600 hover:text-blue-800">
                                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                            {{ item.income|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                            {{ item.expenses|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %} font-medium">
                                            {{ item.net_income|yen }}
                                        </td>
                                    </tr>
                                    <tr id="desktop-plan-{{ year }}-{{ forloop.counter }}" class="hidden xl:table-row bg-gray-50">
                                        <td colspan="4" class="px-4 py-4" id="plan-content-{{ item.year_month }}">
                                            <div class="text-xs space-y-2">
                                                <div class="font-semibold text-blue-700 mb-2">明細一覧</div>
                                                {% for trans in item.transactions %}
                                                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-gray-500">
                                                                {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                            </span>
                                                            <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                        </div>
                                                        <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium">{{ trans.amount|yen }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-purple-100 px-4 py-2 font-semibold text-purple-800">クレカ請求</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">合計金額</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('desktop-credit-{{ year }}-{{ forloop.counter }}')">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                                {{ month_data.year_month|format_year_month }}
                                                <span class="text-xs text-gray-400 ml-1">▼</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                {{ month_data.total_amount|yen }}
                                            </td>
                                        </tr>
                                        <tr id="desktop-credit-{{ year }}-{{ forloop.counter }}" class="hidden xl:table-row bg-gray-50">
                                            <td colspan="2" class="px-4 py-4" id="estimate-content-{{ month_data.year_month }}">
                                                <div class="text-xs space-y-3">
                                                    {% for card in month_data.cards %}
                                                        <div>
                                                            <div class="flex justify-between items-center mb-1">
                                                                <div class="font-semibold text-purple-700">{{ card.card_name }}</div>
                                                                <div class="flex items-center gap-2">
                                                                    <span class="text-red-600 font-medium text-sm">{{ card.total_amount|yen }}</span>
                                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline reflect-card-form">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="reflect_card">
                                                                        <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                                        <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                                        <button type="submit" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">反映</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div class="space-y-1">
                                                                {% for est in card.estimates %}
                                                                    <div class="{% if est.estimate.is_default %}bg-gray-100{% else %}bg-white{% endif %} p-2 rounded border border-gray-200">
                                                                        <div class="flex justify-between items-center">
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-gray-500">
                                                                                    {% if est.estimate.purchase_date %}
                                                                                        {{ est.estimate.purchase_date|date:"Y/n/j" }}
                                                                                    {% elif est.estimate.due_date %}
                                                                                        {{ est.estimate.due_date|date:"Y/n/j" }}
                                                                                    {% else %}
                                                                                        {{ est.estimate.year_month }}
                                                                                    {% endif %}
                                                                                </span>
                                                                                <span class="font-medium text-gray-700">{{ est.memo|default:"（明細名なし）" }}</span>
                                                                                {% if est.estimate.is_split_payment %}
                                                                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">分割払い</span>
                                                                                    {% if est.estimate.split_payment_part == 1 %}
                                                                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">1回目</span>
                                                                                    {% elif est.estimate.split_payment_part == 2 %}
                                                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2回目</span>
                                                                                    {% endif %}
                                                                                {% endif %}
                                                                            </div>
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-red-600 font-medium">{{ est.amount|yen }}</span>
                                                                                {% if est.estimate.pk %}
                                                                                <div class="flex gap-1">
                                                                                    <button type="button" class="edit-estimate-btn text-blue-600 hover:text-blue-800 cursor-pointer"
                                                                                        data-pk="{{ est.estimate.pk }}"
                                                                                        data-year-month="{{ est.estimate.year_month }}"
                                                                                        data-card-type="{{ est.estimate.card_type }}"
                                                                                        data-description="{{ est.estimate.description }}"
                                                                                        data-amount="{{ est.estimate.amount|stringformat:'d' }}"
                                                                                        data-due-date="{{ est.estimate.due_date|date:'Y-m-d' }}"
                                                                                        data-purchase-date="{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}"
                                                                                        data-is-split-payment="{{ est.estimate.is_split_payment|lower }}"
                                                                                        data-is-bonus-payment="{{ est.estimate.is_bonus_payment|lower }}"
                                                                                        data-is-default="{{ est.estimate.is_default|lower }}"
                                                                                        data-default-id="{{ est.estimate.default_id|default:'' }}">
                                                                                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                                        </svg>
                                                                                    </button>
                                                                                    {% if est.estimate.is_default %}
                                                                                    <button type="button" disabled class="text-gray-400 cursor-not-allowed" title="定期項目は削除できません">
                                                                                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                    </svg>
                                                                                </button>
                                                                                    {% else %}
                                                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" class="inline delete-estimate-form">
                                                                                        {% csrf_token %}
                                                                                        <button type="submit" class="text-red-600 hover:text-red-800">
                                                                                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                        </svg>
                                                                                    </button>
                                                                                    </form>
                                                                                    {% endif %}
                                                                                </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                            {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        {% else %}
                            <div class="px-4 py-8 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- モバイル表示 -->
                <div class="xl:hidden space-y-3">
                    <!-- 月次計画 -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-blue-800 bg-blue-100 px-3 py-2 rounded">月次計画</h3>
                        {% for item in yearly_data|get_item:year|get_item:'months' %}
                            <div class="bg-white rounded-lg shadow p-4" id="plan-content-mobile-{{ item.year_month }}">
                                <div class="font-semibold text-gray-800 mb-3 pb-2 border-b flex justify-between items-center">
                                    <span class="cursor-pointer" onclick="toggleDetails('mobile-plan-{{ year }}-{{ forloop.counter }}')">
                                        {{ item.year_month|format_year_month }}
                                        <span class="text-xs text-gray-400 ml-1">▼</span>
                                    </span>
                                    <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-3 gap-1 text-xs">
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">収入</div>
                                            <div class="font-bold text-green-600 text-sm truncate">{{ item.income|yen }}</div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">支出</div>
                                            <div class="font-bold text-red-600 text-sm truncate">{{ item.expenses|yen }}</div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">純収支</div>
                                            <div class="font-bold text-sm truncate {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %}">{{ item.net_income|yen }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="mobile-plan-{{ year }}-{{ forloop.counter }}" class="hidden xl:hidden space-y-3 p-3 bg-gray-50">
                                    {% for trans in item.transactions %}
                                        <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4 {% if trans.type == 'income' %}border-green-500{% else %}border-blue-500{% endif %}">
                                            <div class="p-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h3 class="text-lg font-bold text-gray-900">{{ trans.name }}</h3>
                                                    <span class="text-xl font-bold {% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">{{ trans.amount|yen }}</span>
                                                </div>
                                                <div class="text-sm text-gray-600">
                                                    {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}

                        <!-- モバイル合計 -->
                        <div class="bg-gradient-to-r from-blue-100 to-cyan-100 rounded-xl p-4 border-2 border-blue-300 shadow-md">
                            <div class="flex items-center gap-2 mb-3">
                                <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span class="font-bold text-blue-900">{{ year }}年 合計</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">収入合計</span>
                                    <span class="text-sm font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">支出合計</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-blue-200">
                                    <span class="text-sm font-semibold text-gray-700">純収支</span>
                                    <span class="text-lg font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-purple-800 bg-purple-100 px-3 py-2 rounded">クレカ請求</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                    <div class="bg-purple-50 px-3 py-2.5 cursor-pointer flex justify-between items-center" onclick="toggleDetails('mobile-credit-{{ month_data.year_month }}')">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <span class="font-bold text-gray-800">{{ month_data.year_month|format_year_month }}</span>
                                            <svg class="w-3 h-3 text-gray-400 transition-transform" id="arrow-mobile-credit-{{ month_data.year_month }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <span class="font-bold text-red-600">{{ month_data.total_amount|yen }}</span>
                                    </div>
                                    <div id="mobile-credit-{{ month_data.year_month }}" class="hidden xl:hidden space-y-4 p-3 bg-gray-50">
                                        {% for card in month_data.cards %}
                                            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                                <div class="bg-blue-500 px-4 py-3 flex justify-between items-center">
                                                    <span class="font-bold text-white">{{ card.card_name }}</span>
                                                    <span class="font-bold text-white text-lg">{{ card.total_amount|yen }}</span>
                                                </div>
                                                <div class="p-3 bg-blue-50">
                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="reflect-card-form">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="reflect_card">
                                                        <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                        <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                        <button type="submit" class="w-full bg-white text-blue-600 border-2 border-blue-500 px-4 py-2.5 rounded-lg hover:bg-blue-50 transition font-bold">
                                                            月次計画に反映
                                                        </button>
                                                    </form>
                                                </div>
                                                <div class="p-3 space-y-3">
                                            {% for est in card.estimates %}
                                                <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4 {% if est.estimate.is_default %}border-green-500{% else %}border-blue-500{% endif %}">
                                            <div class="p-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h3 class="text-lg font-bold text-gray-900">{{ est.memo|default:"（明細名なし）" }}</h3>
                                                    <span class="text-xl font-bold text-red-600">{{ est.amount|yen }}</span>
                                                </div>

                                                <div class="text-sm text-gray-600 mb-1">{{ card.card_name }}</div>
                                                <div class="text-sm text-gray-600 mb-3">
                                                    {% if est.estimate.purchase_date %}
                                                        {{ est.estimate.purchase_date|date:"Y年n月j日" }}に利用
                                                    {% elif est.estimate.due_date %}
                                                        {{ est.estimate.due_date|date:"n月j日" }}に請求
                                                    {% else %}
                                                        {{ month_data.year_month|format_year_month }}
                                                    {% endif %}
                                                </div>

                                                {% if est.estimate.is_split_payment %}
                                                <div class="mb-3 flex gap-2">
                                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">分割払い</span>
                                                    {% if est.estimate.split_payment_part == 1 %}
                                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">1回目</span>
                                                    {% elif est.estimate.split_payment_part == 2 %}
                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2回目</span>
                                                    {% endif %}
                                                </div>
                                                {% endif %}

                                                <div class="flex gap-2">
                                                    {% if est.estimate.pk %}
                                                    <button type="button" class="edit-estimate-btn flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2"
                                                        data-pk="{{ est.estimate.pk }}"
                                                        data-year-month="{{ est.estimate.year_month }}"
                                                        data-card-type="{{ est.estimate.card_type }}"
                                                        data-description="{{ est.estimate.description }}"
                                                        data-amount="{{ est.estimate.amount|stringformat:'d' }}"
                                                        data-due-date="{{ est.estimate.due_date|date:'Y-m-d' }}"
                                                        data-purchase-date="{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}"
                                                        data-is-split-payment="{{ est.estimate.is_split_payment|lower }}"
                                                        data-is-bonus-payment="{{ est.estimate.is_bonus_payment|lower }}"
                                                        data-is-default="{{ est.estimate.is_default|lower }}"
                                                        data-default-id="{{ est.estimate.default_id|default:'' }}">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        編集
                                                    </button>
                                                    {% if est.estimate.is_default %}
                                                    <button type="button" disabled class="flex-1 bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed flex items-center justify-center gap-2" title="定期項目は削除できません">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        削除
                                                    </button>
                                                    {% else %}
                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" class="flex-1 delete-estimate-form">
                                                        {% csrf_token %}
                                                        <button type="submit" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                            </svg>
                                                            削除
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                                </div>
                                            {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- モバイル合計 -->
                            <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4 border-2 border-purple-300 shadow-md">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="font-bold text-purple-900">{{ year }}年 合計</span>
                                    </div>
                                    <span class="text-lg font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                    </span>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-white rounded-lg shadow p-4 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- クレカ見積もり新規作成モーダル -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto" onclick="event.stopPropagation()">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">見積り新規追加</h3>
            <button type="button" onclick="closeCreateModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="createEstimateForm" method="post" action="{% url 'budget_app:credit_estimates' %}" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_estimate">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">カード種別</label>
                <select name="card_type" id="create_card_type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    <option value="item_6" selected>VIEWカード</option>
                    <option value="item_8">楽天カード</option>
                    <option value="item_9">PayPayカード</option>
                    <option value="item_10">VERMILLION</option>
                    <option value="item_12">Olive</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">内容</label>
                <input type="text" name="description" id="create_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="例: 旅行、家電など">
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">金額（円）</label>
                <input type="number" name="amount" id="create_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">利用日</label>
                <input type="date" name="purchase_date" id="create_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
            </div>

            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="create_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">分割2回払い</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="create_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ボーナス払い</span>
                </label>
            </div>

            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    追加
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 月次計画編集モーダル -->
<div id="planModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closePlanModal()">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-lg sm:rounded-2xl transform transition-all my-2 sm:my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-lg sm:rounded-t-2xl px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center sticky top-0 z-10">
            <h3 id="planModalTitle" class="text-base sm:text-lg font-bold text-white">月次計画の編集</h3>
            <button type="button" onclick="closePlanModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="planForm" method="post" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="plan_year_month">

            <!-- 収入セクション -->
            <div class="bg-green-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-green-800 mb-2 sm:mb-3">収入</h4>
                <div id="incomeFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <!-- 支出セクション -->
            <div class="bg-red-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-red-800 mb-2 sm:mb-3">支出</h4>
                <div id="expenseFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <div class="flex gap-2 pt-2 sm:pt-3 sticky bottom-0 bg-white pb-1">
                <button type="button" onclick="closePlanModal()" class="flex-1 px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-3 sm:px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<!-- クレカ見積もり編集モーダル -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">見積り編集</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="edit_year_month_hidden">

            <!-- カード種別 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">カード種別</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEWカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">楽天カード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPayカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 内容 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">内容</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="例: 旅行、家電など">
            </div>

            <!-- 金額 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">金額（円）</label>
                <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <!-- 利用日 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">利用日</label>
                <input type="date" name="purchase_date" id="edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
            </div>

            <!-- チェックボックス -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">分割2回払い</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ボーナス払い</span>
                </label>
            </div>

            <!-- ボタン -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// 分割払いとボーナス払いを排他的にする
document.addEventListener('DOMContentLoaded', function() {
    // 編集ボタンのイベントリスナーを設定
    document.querySelectorAll('.edit-estimate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const pk = this.dataset.pk;
            const yearMonth = this.dataset.yearMonth;
            const cardType = this.dataset.cardType;
            const description = this.dataset.description;
            const amount = parseInt(this.dataset.amount);
            const dueDate = this.dataset.dueDate;
            const purchaseDate = this.dataset.purchaseDate;
            const isSplitPayment = this.dataset.isSplitPayment === 'true';
            const isBonusPayment = this.dataset.isBonusPayment === 'true';
            const isDefault = this.dataset.isDefault === 'true';
            const defaultId = this.dataset.defaultId ? parseInt(this.dataset.defaultId) : null;

            openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault, defaultId);
        });
    });

    const splitCheckbox = document.getElementById('edit_is_split_payment');
    const bonusCheckbox = document.getElementById('edit_is_bonus_payment');

    if (splitCheckbox && bonusCheckbox) {
        splitCheckbox.addEventListener('change', function() {
            if (this.checked) {
                bonusCheckbox.checked = false;
            }
        });

        bonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                splitCheckbox.checked = false;
            }
        });
    }
});

function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault = false, defaultId = null) {
    console.log('openEditModal called with:', { pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault, defaultId });
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');

    if (!modal) {
        console.error('editModal not found');
        return;
    }
    if (!form) {
        console.error('editForm not found');
        return;
    }

    console.log('Modal and form found', { modal, form });

    // フォーム内のすべてのinputをログ出力
    const allInputs = form.querySelectorAll('input');
    console.log('All inputs in form:', Array.from(allInputs).map(i => ({ id: i.id, name: i.name, type: i.type })));

    // 定期項目の場合は過去の明細のエンドポイントを使用
    if (isDefault) {
        form.setAttribute('action', "{% url 'budget_app:past_transactions' %}");
        // form_action hiddenフィールドを追加または更新
        let formActionInput = form.querySelector('input[name="form_action"]');
        if (!formActionInput) {
            formActionInput = document.createElement('input');
            formActionInput.type = 'hidden';
            formActionInput.name = 'form_action';
            form.appendChild(formActionInput);
        }
        formActionInput.value = 'edit_default_amount';

        // default_id hiddenフィールドを追加または更新
        let defaultIdInput = form.querySelector('input[name="default_id"]');
        if (!defaultIdInput) {
            defaultIdInput = document.createElement('input');
            defaultIdInput.type = 'hidden';
            defaultIdInput.name = 'default_id';
            form.appendChild(defaultIdInput);
        }
        defaultIdInput.value = defaultId;

        // year_month hiddenフィールドを追加または更新
        let yearMonthInput = form.querySelector('input[name="year_month"]');
        if (!yearMonthInput) {
            yearMonthInput = document.createElement('input');
            yearMonthInput.type = 'hidden';
            yearMonthInput.name = 'year_month';
            form.appendChild(yearMonthInput);
        }
        yearMonthInput.value = yearMonth;
    } else {
        form.setAttribute('action', `/credit-estimates/${pk}/edit/`);
        // 定期項目用のhiddenフィールドを削除
        const formActionInput = form.querySelector('input[name="form_action"]');
        if (formActionInput) formActionInput.remove();
        const defaultIdInput = form.querySelector('input[name="default_id"]');
        if (defaultIdInput) defaultIdInput.remove();
    }

    // 年月をhiddenフィールドに設定（常に必要）
    const yearMonthHidden = form.querySelector('input[name="year_month"]');
    if (!yearMonthHidden) {
        console.error('year_month input not found');
        return;
    }
    yearMonthHidden.value = yearMonth;

    // カード種別を設定
    document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
        radio.checked = (radio.value === cardType);
        const label = radio.closest('.card-type-label');
        const box = label.querySelector('.card-type-box');
        const indicator = label.querySelector('.radio-indicator');
        const dot = label.querySelector('.radio-dot');

        if (radio.checked) {
            box.classList.add('border-blue-600', 'bg-blue-50');
            box.classList.remove('border-gray-300');
            indicator.classList.add('border-blue-600');
            indicator.classList.remove('border-gray-400');
            dot.classList.remove('hidden');
        } else {
            box.classList.remove('border-blue-600', 'bg-blue-50');
            box.classList.add('border-gray-300');
            indicator.classList.remove('border-blue-600');
            indicator.classList.add('border-gray-400');
            dot.classList.add('hidden');
        }
    });

    // 金額を数値に変換（カンマ除去）
    const numericAmount = typeof amount === 'string' ? parseInt(amount.replace(/,/g, ''), 10) : amount;

    // その他のフィールドを設定
    const editDescription = form.querySelector('input[name="description"]');
    const editAmount = form.querySelector('input[name="amount"]');
    const editPurchaseDate = form.querySelector('input[name="purchase_date"]');
    const editIsSplitPayment = form.querySelector('input[name="is_split_payment"]');
    const editIsBonusPayment = form.querySelector('input[name="is_bonus_payment"]');

    if (!editDescription || !editAmount || !editPurchaseDate || !editIsSplitPayment || !editIsBonusPayment) {
        console.error('One or more edit form fields not found', {
            editDescription: !!editDescription,
            editAmount: !!editAmount,
            editPurchaseDate: !!editPurchaseDate,
            editIsSplitPayment: !!editIsSplitPayment,
            editIsBonusPayment: !!editIsBonusPayment
        });
        return;
    }

    editDescription.value = description || '';
    editAmount.value = numericAmount || '';
    editPurchaseDate.value = purchaseDate || dueDate || '';
    editIsSplitPayment.checked = isSplitPayment;
    editIsBonusPayment.checked = isBonusPayment;

    // 定期項目の場合は項目名と支払種別を無効化
    editDescription.disabled = isDefault;
    editIsSplitPayment.disabled = isDefault;
    editIsBonusPayment.disabled = isDefault;
    editPurchaseDate.disabled = isDefault;

    // カード種別に応じて分割払い・ボーナス払いの表示を更新
    togglePaymentOptions();

    modal.classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

function toggleDetails(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');
        // 矢印アイコンを探して向きを変更
        const arrow = document.querySelector(`[onclick*="toggleDetails('${id}')"] .arrow-icon`);
        if (arrow) {
            if (element.classList.contains('hidden')) {
                arrow.textContent = '▼';
            } else {
                arrow.textContent = '▲';
            }
        }
    }
}

// 月次計画モーダルを開く
async function openPlanModal(planId, displayYearMonth, yearMonth) {
    const modal = document.getElementById('planModal');
    const form = document.getElementById('planForm');
    const title = document.getElementById('planModalTitle');

    form.action = `/plans/${planId}/edit/`;
    title.textContent = `${displayYearMonth} の編集`;
    document.getElementById('plan_year_month').value = yearMonth;

    // プランデータを取得
    try {
        const response = await fetch(`/plans/${planId}/data/`);
        const data = await response.json();

        // 収入フィールドを生成
        const incomeFields = document.getElementById('incomeFields');
        incomeFields.innerHTML = '';

        if (data.income_items && data.income_items.length > 0) {
            data.income_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}（円）</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                `;
                incomeFields.appendChild(div);
            });
        }

        // 支出フィールドを生成
        const expenseFields = document.getElementById('expenseFields');
        expenseFields.innerHTML = '';

        if (data.expense_items && data.expense_items.length > 0) {
            data.expense_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}（円）</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition text-sm">
                `;
                expenseFields.appendChild(div);
            });
        }

        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading plan data:', error);
        showToast('データの読み込みに失敗しました', 'error');
    }
}

function closePlanModal() {
    document.getElementById('planModal').classList.add('hidden');
}

// 分割払い・ボーナス払いの表示制御
function togglePaymentOptions() {
    const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
    const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
    const editSplitCheckbox = document.getElementById('edit_is_split_payment');
    const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');

    // 選択されているカード種別を取得
    const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
    const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

    // 分割払いはVIEWカードの場合のみ表示
    if (editSplitWrapper) {
        editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editSplitCheckbox) {
            editSplitCheckbox.checked = false;
        }
    }

    // ボーナス払いはVIEWカードの場合のみ表示
    if (editBonusWrapper) {
        editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editBonusCheckbox) {
            editBonusCheckbox.checked = false;
        }
    }
}

// カード種別のラジオボタン選択時のスタイル更新
document.querySelectorAll('#editModal .card-type-label').forEach(label => {
    label.addEventListener('click', function() {
        const radio = this.querySelector('.card-type-radio');
        radio.checked = true;

        // 全てのカード種別ボタンをリセット
        document.querySelectorAll('#editModal .card-type-label').forEach(otherLabel => {
            const otherBox = otherLabel.querySelector('.card-type-box');
            const otherIndicator = otherLabel.querySelector('.radio-indicator');
            const otherDot = otherLabel.querySelector('.radio-dot');

            otherBox.classList.remove('border-blue-600', 'bg-blue-50');
            otherBox.classList.add('border-gray-300');
            otherIndicator.classList.remove('border-blue-600');
            otherIndicator.classList.add('border-gray-400');
            otherDot.classList.add('hidden');
        });

        // 選択されたボタンをアクティブ化
        const box = this.querySelector('.card-type-box');
        const indicator = this.querySelector('.radio-indicator');
        const dot = this.querySelector('.radio-dot');

        box.classList.add('border-blue-600', 'bg-blue-50');
        box.classList.remove('border-gray-300');
        indicator.classList.add('border-blue-600');
        indicator.classList.remove('border-gray-400');
        dot.classList.remove('hidden');

        // カード種別変更時に分割払い・ボーナス払いの表示を更新
        togglePaymentOptions();
    });
});

// トースト通知を表示
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');
    const toastContainer = toast.querySelector('div');

    // アイコンとスタイルを設定
    if (type === 'success') {
        icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    } else if (type === 'error') {
        icon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    }

    messageEl.textContent = message;
    toast.classList.remove('hidden');

    // 3秒後に非表示
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// 編集フォームの送信処理（AJAX）
const editForm = document.getElementById('editForm');
editForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(editForm);

    // デバッグ: FormDataの内容を確認
    console.log('Form action:', editForm.action);
    for (let [key, value] of formData.entries()) {
        console.log(key + ':', value);
    }

    await window.sendAjaxRequest(editForm.action, formData, {
        closeModal: closeEditModal,
        reloadOnSuccess: true,  // 編集成功後にページをリロード
        onSuccess: (data) => {
            // target_urlがある場合はリダイレクト（セクション展開のため）
            if (data.target_url) {
                window.location.href = data.target_url;
            }
        }
    });
});

// 月次計画モーダルフォームの送信処理（AJAX）
const planForm = document.getElementById('planForm');
if (planForm) {
    planForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            return response.json().then(data => ({
                ok: response.ok,
                status: response.status,
                data: data
            }));
        })
        .then(result => {
            if (result.ok && result.data.status === 'success') {
                showToast(result.data.message);
                closePlanModal();
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                let errorMsg = '更新に失敗しました。';
                if (result.data.errors) {
                    const errorList = [];
                    for (const [field, errors] of Object.entries(result.data.errors)) {
                        errorList.push(...errors);
                    }
                    if (errorList.length > 0) {
                        errorMsg = errorList.join(', ');
                    }
                }
                showToast(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('エラーが発生しました。', 'error');
        });
    });
}

// --- 反映ボタンの非同期処理 ---
document.querySelectorAll('.reflect-card-form').forEach(reflectForm => {
    reflectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!confirm('このカードの合計額を月次計画に反映しますか？')) return;

        await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(reflectForm), {
            toastDuration: 3000,  // 3秒表示
            reloadOnSuccess: true  // 自動的に月次計画ページへ遷移
        });
    });
});

// 削除フォームの非同期処理
document.querySelectorAll('.delete-estimate-form').forEach(deleteForm => {
    deleteForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!confirm('本当に削除しますか？')) return;

        const formData = new FormData();
        formData.append('delete_type', 'single');

        await window.sendAjaxRequest(deleteForm.action, formData, {
            reloadOnSuccess: true  // 削除成功後にページをリロードして該当月を展開
        });
    });
});

// セクションを開く関数（クレカ見積もりと月次計画の両方に対応）
function expandEstimateSection(hash) {
    if (!hash) return;

    let yearMonth, scrollTarget = null, isEstimateSection = false, isPlanSection = false;

    // クレカ見積もりセクションの場合
    if (hash.startsWith('#estimate-content-')) {
        isEstimateSection = true;
        yearMonth = hash.replace('#estimate-content-', '').replace('-mobile', '');
    }
    // 月次計画セクションの場合
    else if (hash.startsWith('#plan-content-')) {
        isPlanSection = true;
        yearMonth = hash.replace('#plan-content-', '').replace('-mobile', '');
    }

    if (yearMonth) {
        // クレカ見積もりセクションの展開
        if (isEstimateSection) {
            // デスクトップ版の詳細セクションを展開
            document.querySelectorAll('[id^="desktop-credit-"]').forEach(element => {
                const tdWithAnchor = element.querySelector(`#estimate-content-${yearMonth}`);
                if (tdWithAnchor && element.classList.contains('hidden')) {
                    element.classList.remove('hidden');
                }
            });

            // モバイル版の詳細セクションを展開
            const mobileDetails = document.getElementById(`mobile-credit-${yearMonth}`);
            if (mobileDetails && mobileDetails.classList.contains('hidden')) {
                mobileDetails.classList.remove('hidden');
            }

            // スクロール先: モバイルヘッダー（常に表示）または詳細コンテンツ
            scrollTarget = document.querySelector(`[onclick*="toggleDetails('mobile-credit-${yearMonth}')"]`);
            if (!scrollTarget) {
                scrollTarget = document.getElementById(`estimate-content-${yearMonth}`);
            }
        }
        // 月次計画セクションの展開
        else if (isPlanSection) {
            // デスクトップ版の詳細セクションを展開
            document.querySelectorAll('[id^="desktop-plan-"]').forEach(element => {
                const tdWithAnchor = element.querySelector(`#plan-content-${yearMonth}`);
                if (tdWithAnchor && element.classList.contains('hidden')) {
                    element.classList.remove('hidden');
                }
            });

            // モバイル版の詳細セクションを展開
            const mobileParent = document.getElementById(`plan-content-mobile-${yearMonth}`);
            if (mobileParent) {
                const mobileDetails = mobileParent.querySelector('[id^="mobile-plan-"]');
                if (mobileDetails && mobileDetails.classList.contains('hidden')) {
                    mobileDetails.classList.remove('hidden');
                }
            }

            // スクロール先: モバイル親要素（常に表示）または詳細コンテンツ
            scrollTarget = document.getElementById(`plan-content-mobile-${yearMonth}`);
            if (!scrollTarget) {
                scrollTarget = document.getElementById(`plan-content-${yearMonth}`);
            }
        }

        // 要素にスクロール（ヘッダー分のオフセットを考慮）
        if (scrollTarget) {
            setTimeout(() => {
                const header = document.querySelector('nav');
                const headerHeight = header ? header.offsetHeight : 0;
                const elementPosition = scrollTarget.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }, 200);
        }
    }
}

// Djangoのmessagesフレームワークからのメッセージをトーストで表示
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}

    // 新規作成フォームの送信処理
    const createForm = document.getElementById('createEstimateForm');
    if (createForm) {
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(createForm), {
                closeModal: closeCreateModal,
                onSuccess: (data) => {
                    // 成功したらクレカ見積もりページに移動（target_urlがあればそのアンカーに移動）
                    console.log('Create estimate success, data:', data);
                    if (data.target_url) {
                        console.log('target_url:', data.target_url);
                        // target_urlからアンカー部分を抽出
                        const urlParts = data.target_url.split('#');
                        console.log('urlParts:', urlParts);
                        if (urlParts.length > 1) {
                            // アンカーをsessionStorageに保存
                            const anchor = '#' + urlParts[1];
                            console.log('Saving anchor to sessionStorage:', anchor);
                            sessionStorage.setItem('scrollToAnchor', anchor);
                            // アンカーなしのURLに遷移（sessionStorageから読み取って処理される）
                            console.log('Navigating to:', urlParts[0]);
                            window.location.href = urlParts[0];
                        } else {
                            console.log('No anchor found, navigating to target_url directly');
                            window.location.href = data.target_url;
                        }
                    } else {
                        console.log('No target_url, navigating to credit estimates page');
                        window.location.href = "{% url 'budget_app:credit_estimates' %}";
                    }
                }
            });
        });
    }

    // 新規作成モーダルのカード種別変更時の処理
    const createCardType = document.getElementById('create_card_type');
    if (createCardType) {
        createCardType.addEventListener('change', toggleCreatePaymentOptions);
    }

    // 新規作成モーダルの分割・ボーナス払いを排他的にする
    const createSplitCheckbox = document.getElementById('create_is_split_payment');
    const createBonusCheckbox = document.getElementById('create_is_bonus_payment');

    if (createSplitCheckbox && createBonusCheckbox) {
        createSplitCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createBonusCheckbox.checked = false;
            }
        });

        createBonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createSplitCheckbox.checked = false;
            }
        });
    }

    // sessionStorageからアンカーを取得（common.jsでリロード前に保存される）
    const savedAnchor = sessionStorage.getItem('scrollToAnchor');
    if (savedAnchor) {
        // URLのハッシュを更新
        window.location.hash = savedAnchor;
        // sessionStorageをクリア（base.htmlでもクリアされるが、念のため）
        sessionStorage.removeItem('scrollToAnchor');
        // セクションを展開
        expandEstimateSection(savedAnchor);
    } else {
        // URLのハッシュ（アンカー）をチェックして、該当する月のセクションを自動的に開く
        expandEstimateSection(window.location.hash);
    }
});

// ページ読み込み完了後もチェック（base.htmlのスクロール処理の後に実行）
window.addEventListener('load', function() {
    // 少し遅延させて、base.htmlのスクロールが完了してから実行
    setTimeout(() => {
        // URLのハッシュまたはsessionStorageから取得したアンカーで展開
        const hash = window.location.hash;
        if (hash) {
            expandEstimateSection(hash);
        }
    }, 400);
});

// 新規作成モーダルを開く
function openCreateModal() {
    const modal = document.getElementById('createModal');
    modal.classList.remove('hidden');

    // フォームをリセット
    document.getElementById('createEstimateForm').reset();

    // 利用日のデフォルトを本日に設定
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    document.getElementById('create_purchase_date').value = todayStr;

    // 分割・ボーナス払いの表示制御を更新
    toggleCreatePaymentOptions();
}

function closeCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
}

// 新規作成時の分割払い・ボーナス払いの表示制御
function toggleCreatePaymentOptions() {
    const createSplitWrapper = document.getElementById('create_split_payment_wrapper');
    const createBonusWrapper = document.getElementById('create_bonus_payment_wrapper');
    const createSplitCheckbox = document.getElementById('create_is_split_payment');
    const createBonusCheckbox = document.getElementById('create_is_bonus_payment');

    // 選択されているカード種別を取得
    const cardTypeSelect = document.getElementById('create_card_type');
    const isViewCard = cardTypeSelect && cardTypeSelect.value === 'item_6';

    // 分割払いはVIEWカードの場合のみ表示
    if (createSplitWrapper) {
        createSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && createSplitCheckbox) {
            createSplitCheckbox.checked = false;
        }
    }

    // ボーナス払いはVIEWカードの場合のみ表示
    if (createBonusWrapper) {
        createBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && createBonusCheckbox) {
            createBonusCheckbox.checked = false;
        }
    }
}

// 定期項目の金額を編集する関数
function editDefaultAmount(defaultId, yearMonth, cardType, currentAmount) {
    const newAmount = prompt('新しい金額を入力してください:', currentAmount);
    if (newAmount === null) return; // キャンセルされた

    const amount = parseInt(newAmount);
    if (isNaN(amount) || amount < 0) {
        alert('正しい金額を入力してください');
        return;
    }

    // サーバーに送信
    fetch('{% url "budget_app:past_transactions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'edit_default_amount',
            'default_id': defaultId,
            'year_month': yearMonth,
            'card_type': cardType,
            'amount': amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ページをリロード
            location.reload();
        } else {
            alert('エラー: ' + data.message);
        }
    })
    .catch(error => {
        alert('エラーが発生しました');
        console.error(error);
    });
}
</script>
{% endblock %}
