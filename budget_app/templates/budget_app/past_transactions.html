{% extends 'budget_app/base.html' %}
{% load budget_filters %}

{% block title %}過去の明細{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">過去の明細</h1>
        <p class="text-gray-600">過去の収入・支出の履歴を年ごとに表示しています</p>
    </div>

    {% if not sorted_years %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
            <p class="text-yellow-800">過去の明細データがありません</p>
        </div>
    {% else %}
        {% for year in sorted_years %}
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 pb-2 border-b-2 border-gray-300">
                    {{ year }}年
                </h2>

                <!-- デスクトップ表示 -->
                <div class="hidden md:flex md:gap-6 md:items-start">
                    <!-- 月次計画 -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-blue-100 px-4 py-2 font-semibold text-blue-800">月次計画</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">収入</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">支出</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in yearly_data|get_item:year|get_item:'months' %}
                                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('desktop-plan-{{ year }}-{{ forloop.counter }}')">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                            {{ item.year_month|format_year_month }}
                                            <span class="text-xs text-gray-400 ml-1">▼</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                            {{ item.income|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                            {{ item.expenses|yen }}
                                        </td>
                                    </tr>
                                    <tr id="desktop-plan-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                        <td colspan="3" class="px-4 py-4">
                                            <div class="text-xs space-y-2">
                                                <div class="font-semibold text-blue-700 mb-2">明細一覧</div>
                                                {% for trans in item.transactions %}
                                                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-gray-500">
                                                                {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                            </span>
                                                            <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                        </div>
                                                        <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium">{{ trans.amount|yen }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-purple-100 px-4 py-2 font-semibold text-purple-800">クレカ見積り</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">合計金額</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('desktop-credit-{{ year }}-{{ forloop.counter }}')">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                                {{ month_data.year_month|format_year_month }}
                                                <span class="text-xs text-gray-400 ml-1">▼</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                {{ month_data.total_amount|yen }}
                                            </td>
                                        </tr>
                                        <tr id="desktop-credit-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                            <td colspan="2" class="px-4 py-4">
                                                <div class="text-xs space-y-3">
                                                    {% for card in month_data.cards %}
                                                        <div>
                                                            <div class="font-semibold text-purple-700 mb-1">{{ card.card_name }}</div>
                                                            <div class="space-y-1">
                                                                {% for est in card.estimates %}
                                                                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                                                                        <div class="flex items-center gap-2">
                                                                            <span class="text-gray-500">
                                                                                {{ month_data.year_month|slice:":4" }}/{{ month_data.year_month|slice:"5:7" }}{% if est.estimate.due_date %}/{{ est.estimate.due_date|date:"j" }}{% endif %}
                                                                            </span>
                                                                            <span class="font-medium text-gray-700">{{ est.memo|default:"（明細名なし）" }}</span>
                                                                            {% if est.estimate.is_split_payment %}
                                                                                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">分割</span>
                                                                            {% endif %}
                                                                            {% if est.estimate.is_bonus_payment %}
                                                                                <span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded">ボーナス</span>
                                                                            {% endif %}
                                                                        </div>
                                                                        <span class="text-red-600 font-medium">{{ est.amount|yen }}</span>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                            {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        {% else %}
                            <div class="px-4 py-8 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- モバイル表示 -->
                <div class="md:hidden space-y-6">
                    <!-- 月次計画 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-blue-800 bg-blue-100 px-3 py-2 rounded">月次計画</h3>
                        {% for item in yearly_data|get_item:year|get_item:'months' %}
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="font-semibold text-gray-800 mb-3 pb-2 border-b cursor-pointer" onclick="toggleDetails('mobile-plan-{{ year }}-{{ forloop.counter }}')">
                                    {{ item.year_month|format_year_month }}
                                    <span class="text-xs text-gray-400 ml-1">▼</span>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">収入</span>
                                        <span class="text-sm font-medium text-green-600">{{ item.income|yen }}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">支出</span>
                                        <span class="text-sm font-medium text-red-600">{{ item.expenses|yen }}</span>
                                    </div>
                                </div>
                                <div id="mobile-plan-{{ year }}-{{ forloop.counter }}" class="hidden mt-3 pt-3 border-t border-gray-200">
                                    <div class="space-y-2">
                                        <div class="font-semibold text-blue-700 text-xs mb-2">明細一覧</div>
                                        {% for trans in item.transactions %}
                                            <div class="bg-gray-50 p-2 rounded text-xs flex justify-between items-center">
                                                <div class="flex items-center gap-1 flex-wrap">
                                                    <span class="text-gray-500">
                                                        {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                    </span>
                                                    <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                </div>
                                                <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium whitespace-nowrap">{{ trans.amount|yen }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                        <!-- モバイル合計 -->
                        <div class="bg-gray-100 rounded-lg shadow p-4 border-2 border-gray-300">
                            <div class="font-bold text-gray-900 mb-3">{{ year }}年 合計</div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">収入合計</span>
                                    <span class="text-sm font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">支出合計</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-purple-800 bg-purple-100 px-3 py-2 rounded">クレカ見積り</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                <div class="bg-white rounded-lg shadow p-4">
                                    <div class="font-semibold text-gray-800 mb-3 pb-2 border-b cursor-pointer" onclick="toggleDetails('mobile-credit-{{ year }}-{{ forloop.counter }}')">
                                        {{ month_data.year_month|format_year_month }}
                                        <span class="text-xs text-gray-400 ml-1">▼</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">合計金額</span>
                                        <span class="text-sm font-medium text-red-600">{{ month_data.total_amount|yen }}</span>
                                    </div>
                                    <div id="mobile-credit-{{ year }}-{{ forloop.counter }}" class="hidden mt-3 pt-3 border-t border-gray-200">
                                        <div class="space-y-3">
                                            {% for card in month_data.cards %}
                                                <div>
                                                    <div class="font-semibold text-purple-700 text-xs mb-1">{{ card.card_name }}</div>
                                                    <div class="space-y-1">
                                                        {% for est in card.estimates %}
                                                            <div class="bg-gray-50 p-2 rounded text-xs flex justify-between items-center">
                                                                <div class="flex items-center gap-1 flex-wrap">
                                                                    <span class="text-gray-500">
                                                                        {{ month_data.year_month|slice:":4" }}/{{ month_data.year_month|slice:"5:7" }}{% if est.estimate.due_date %}/{{ est.estimate.due_date|date:"j" }}{% endif %}
                                                                    </span>
                                                                    <span class="font-medium text-gray-700">{{ est.memo|default:"（明細名なし）" }}</span>
                                                                    {% if est.estimate.is_split_payment %}
                                                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">分割</span>
                                                                    {% endif %}
                                                                    {% if est.estimate.is_bonus_payment %}
                                                                        <span class="px-1.5 py-0.5 bg-orange-100 text-orange-700 text-xs rounded">ボーナス</span>
                                                                    {% endif %}
                                                                </div>
                                                                <span class="text-red-600 font-medium whitespace-nowrap">{{ est.amount|yen }}</span>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- モバイル合計 -->
                            <div class="bg-gray-100 rounded-lg shadow p-4 border-2 border-gray-300">
                                <div class="font-bold text-gray-900 mb-3">{{ year }}年 クレカ合計</div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">合計金額</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                    </span>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-white rounded-lg shadow p-4 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>

<script>
function toggleDetails(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');
    }
}
</script>
{% endblock %}
