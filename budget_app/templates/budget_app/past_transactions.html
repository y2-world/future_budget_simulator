{% extends 'budget_app/base.html' %}
{% load budget_filters %}

{% block title %}éå»ã®æ˜ç´°{% endblock %}

{% block content %}
<!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border-l-4 rounded-lg shadow-lg p-4 max-w-md">
        <div class="flex items-center">
            <div id="toast-icon" class="flex-shrink-0 mr-3"></div>
            <div id="toast-message" class="text-sm font-medium"></div>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
    <div class="mb-4 md:mb-6 flex justify-between items-center">
        <h1 class="text-2xl md:text-3xl font-bold">éå»ã®æ˜ç´°</h1>
        <button onclick="openCreateModal()" class="bg-blue-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm md:text-base flex items-center gap-2">
            <span>æ–°è¦è¿½åŠ </span>
        </button>
    </div>

    {% if not sorted_years %}
        <!-- ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-600 text-lg font-medium">ã¾ã éå»ã®æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            <p class="text-gray-500 text-sm mt-2">æœˆæ¬¡è¨ˆç”»ã‚’ä½œæˆã™ã‚‹ã¨ã€éå»ã®æœˆãŒè‡ªå‹•çš„ã«ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
    {% else %}
        {% for year in sorted_years %}
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 pb-2 border-b-2 border-gray-300">
                    {{ year }}å¹´
                </h2>

                <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º -->
                <div class="hidden xl:flex xl:gap-6 xl:items-start">
                    <!-- æœˆæ¬¡è¨ˆç”» -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-blue-100 px-4 py-2 font-semibold text-blue-800">æœˆæ¬¡è¨ˆç”»</h3>
                        {% if yearly_data|get_item:year|get_item:'months' %}
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¹´æœˆ</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">åå…¥</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¯å‡º</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ç´”åæ”¯</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in yearly_data|get_item:year|get_item:'months' %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                            <span class="cursor-pointer" onclick="toggleDetails('desktop-plan-{{ year }}-{{ forloop.counter }}')">
                                                {{ item.year_month|format_year_month }}
                                                <span class="arrow-icon text-xs text-gray-400 ml-1">â–¼</span>
                                            </span>
                                            <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="ml-2 text-blue-600 hover:text-blue-800">
                                                <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                            {{ item.income|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                            {{ item.expenses|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %} font-medium">
                                            {{ item.net_income|yen }}
                                        </td>
                                    </tr>
                                    <tr id="desktop-plan-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                        <td colspan="4" class="px-4 py-4" id="plan-content-{{ item.year_month }}">
                                            <div class="text-xs space-y-2">
                                                <div class="font-semibold text-blue-700 mb-2">æ˜ç´°ä¸€è¦§</div>
                                                {% for trans in item.transactions %}
                                                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-gray-500">
                                                                {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                            </span>
                                                            <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                        </div>
                                                        <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium">{{ trans.amount|yen }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">åˆè¨ˆ</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                        {% else %}
                        <div class="p-8 text-center text-gray-500">
                            <p class="text-sm">ã¾ã æœˆæ¬¡è¨ˆç”»ã¯åæ˜ ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Š -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-purple-100 px-4 py-2 font-semibold text-purple-800">ã‚¯ãƒ¬ã‚«è«‹æ±‚</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¹´æœˆ</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">åˆè¨ˆé‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('desktop-credit-{{ year }}-{{ forloop.counter }}')">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                                {{ month_data.year_month|format_year_month }}
                                                <span class="arrow-icon text-xs text-gray-400 ml-1">â–¼</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                {{ month_data.total_amount|yen }}
                                            </td>
                                        </tr>
                                        <tr id="desktop-credit-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                            <td colspan="2" class="px-4 py-4" id="estimate-content-{{ month_data.year_month }}">
                                                <div class="text-xs space-y-3">
                                                    {% for card in month_data.cards %}
                                                        <div>
                                                            <div class="flex justify-between items-center mb-1">
                                                                <div class="font-semibold text-purple-700">{{ card.card_name }}</div>
                                                                <div class="flex items-center gap-2">
                                                                    <span class="text-red-600 font-medium text-sm">{{ card.total_amount|yen }}</span>
                                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline reflect-card-form">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="reflect_card">
                                                                        <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                                        <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                                        <input type="hidden" name="total_amount" value="{{ card.total_amount|stringformat:'d' }}">
                                                                        <input type="hidden" name="manual_total" value="{{ card.manual_amount|stringformat:'d' }}">
                                                                        <input type="hidden" name="default_total" value="{{ card.default_amount|stringformat:'d' }}">
                                                                        <button type="submit" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">åæ˜ </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div class="space-y-1">
                                                                {% for est in card.estimates %}
                                                                    <div class="{% if est.estimate.is_default %}bg-gray-100{% else %}bg-white{% endif %} p-2 rounded border border-gray-200">
                                                                        <div class="flex justify-between items-center">
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-gray-500">
                                                                                    {% if est.estimate.purchase_date %}
                                                                                        {{ est.estimate.purchase_date|date:"Y/n/j" }}
                                                                                    {% elif est.estimate.due_date %}
                                                                                        {{ est.estimate.due_date|date:"Y/n/j" }}
                                                                                    {% else %}
                                                                                        {{ est.estimate.year_month }}
                                                                                    {% endif %}
                                                                                </span>
                                                                                <span class="font-medium text-gray-700">{{ est.memo|default:"ï¼ˆæ˜ç´°åãªã—ï¼‰" }}</span>
                                                                                {% if est.estimate.is_split_payment %}
                                                                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">åˆ†å‰²æ‰•ã„</span>
                                                                                    {% if est.estimate.split_payment_part == 1 %}
                                                                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">1å›ç›®</span>
                                                                                    {% elif est.estimate.split_payment_part == 2 %}
                                                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2å›ç›®</span>
                                                                                    {% endif %}
                                                                                {% endif %}
                                                                            </div>
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-red-600 font-medium">
                                                                                    {% if est.estimate.is_usd and est.estimate.usd_amount %}
                                                                                        <span class="text-gray-900">${{ est.estimate.usd_amount }}</span>
                                                                                        <span class="text-xs text-gray-500">({{ est.amount|yen }})</span>
                                                                                    {% else %}
                                                                                        {{ est.amount|yen }}
                                                                                    {% endif %}
                                                                                </span>
                                                                                {% if est.estimate.pk %}
                                                                                <div class="flex gap-1">
                                                                                    <button type="button" class="edit-estimate-btn text-blue-600 hover:text-blue-800 cursor-pointer w-6 h-6 flex items-center justify-center"
                                                                                        data-pk="{{ est.estimate.pk }}"
                                                                                        data-year-month="{{ est.estimate.year_month }}"
                                                                                        data-card-type="{{ est.estimate.card_type }}"
                                                                                        data-description="{{ est.estimate.description }}"
                                                                                        data-amount="{{ est.estimate.amount|stringformat:'d' }}"
                                                                                        data-due-date="{{ est.estimate.due_date|date:'Y-m-d' }}"
                                                                                        data-purchase-date="{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}"
                                                                                        data-is-split-payment="{{ est.estimate.is_split_payment|lower }}"
                                                                                        data-is-bonus-payment="{{ est.estimate.is_bonus_payment|lower }}"
                                                                                        data-is-default="{{ est.estimate.is_default|lower }}"
                                                                                        data-default-id="{{ est.estimate.default_id|default:'' }}">
                                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                                        </svg>
                                                                                    </button>
                                                                                    {% if est.estimate.is_default %}
                                                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline delete-default-form">
                                                                                        {% csrf_token %}
                                                                                        <input type="hidden" name="action" value="delete_default_for_month">
                                                                                        <input type="hidden" name="default_id" value="{{ est.estimate.default_id }}">
                                                                                        <input type="hidden" name="year_month" value="{{ est.estimate.year_month }}">
                                                                                        <button type="submit" class="text-red-600 hover:text-red-800 w-6 h-6 flex items-center justify-center">
                                                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                            </svg>
                                                                                        </button>
                                                                                    </form>
                                                                                    {% else %}
                                                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" class="inline delete-estimate-form">
                                                                                        {% csrf_token %}
                                                                                        <button type="submit" class="text-red-600 hover:text-red-800 w-6 h-6 flex items-center justify-center">
                                                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                            </svg>
                                                                                        </button>
                                                                                    </form>
                                                                                    {% endif %}
                                                                                </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">åˆè¨ˆ</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                            {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        {% else %}
                            <div class="px-4 py-8 text-center text-gray-500 text-sm">
                                ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º -->
                <div class="xl:hidden space-y-3">
                    <!-- æœˆæ¬¡è¨ˆç”» -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-blue-800 bg-blue-100 px-3 py-2 rounded">æœˆæ¬¡è¨ˆç”»</h3>
                        {% for item in yearly_data|get_item:year|get_item:'months' %}
                            <div class="bg-white rounded-lg shadow p-4" id="plan-content-mobile-{{ item.year_month }}">
                                <div class="font-semibold text-gray-800 mb-3 pb-2 border-b flex justify-between items-center">
                                    <span class="cursor-pointer" onclick="toggleDetails('mobile-plan-{{ year }}-{{ forloop.counter }}')">
                                        {{ item.year_month|format_year_month }}
                                        <span class="arrow-icon text-xs text-gray-400 ml-1">â–¼</span>
                                    </span>
                                    <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-3 gap-1 text-xs">
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">åå…¥</div>
                                            <div class="font-bold text-green-600 text-sm truncate">{{ item.income|yen }}</div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">æ”¯å‡º</div>
                                            <div class="font-bold text-red-600 text-sm truncate">{{ item.expenses|yen }}</div>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="text-gray-600 mb-0.5 text-[10px]">ç´”åæ”¯</div>
                                            <div class="font-bold text-sm truncate {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %}">{{ item.net_income|yen }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="mobile-plan-{{ year }}-{{ forloop.counter }}" class="hidden space-y-3 p-3 bg-gray-50">
                                    {% for trans in item.transactions %}
                                        <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4 {% if trans.type == 'income' %}border-green-500{% else %}border-blue-500{% endif %}">
                                            <div class="p-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <h3 class="text-lg font-bold text-gray-900">{{ trans.name }}</h3>
                                                    <span class="text-xl font-bold {% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">{{ trans.amount|yen }}</span>
                                                </div>
                                                <div class="text-sm text-gray-600">
                                                    {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}

                        <!-- ãƒ¢ãƒã‚¤ãƒ«åˆè¨ˆ -->
                        <div class="bg-gradient-to-r from-blue-100 to-cyan-100 rounded-xl p-4 border-2 border-blue-300 shadow-md">
                            <div class="flex items-center gap-2 mb-3">
                                <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span class="font-bold text-blue-900">{{ year }}å¹´ åˆè¨ˆ</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">åå…¥åˆè¨ˆ</span>
                                    <span class="text-sm font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">æ”¯å‡ºåˆè¨ˆ</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-blue-200">
                                    <span class="text-sm font-semibold text-gray-700">ç´”åæ”¯</span>
                                    <span class="text-lg font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Š -->
                    <div class="space-y-3">
                        <h3 class="font-semibold text-purple-800 bg-purple-100 px-3 py-2 rounded">ã‚¯ãƒ¬ã‚«è«‹æ±‚</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                    <div class="bg-purple-50 px-3 py-2.5 cursor-pointer flex justify-between items-center" onclick="toggleDetails('mobile-credit-{{ month_data.year_month }}')">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            <span class="font-bold text-gray-800">{{ month_data.year_month|format_year_month }}</span>
                                            <svg class="w-3 h-3 text-gray-400 transition-transform" id="arrow-mobile-credit-{{ month_data.year_month }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <span class="font-bold text-red-600">{{ month_data.total_amount|yen }}</span>
                                    </div>
                                    <div id="mobile-credit-{{ month_data.year_month }}" class="hidden space-y-4 p-3 bg-gray-50">
                                        {% for card in month_data.cards %}
                                            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                                <div class="bg-blue-500 px-4 py-3 flex justify-between items-center">
                                                    <span class="font-bold text-white">{{ card.card_name }}</span>
                                                    <span class="font-bold text-white text-lg">{{ card.total_amount|yen }}</span>
                                                </div>
                                                <div class="p-3 bg-blue-50">
                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="reflect-card-form">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="reflect_card">
                                                        <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                        <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                        <input type="hidden" name="total_amount" value="{{ card.total_amount|stringformat:'d' }}">
                                                        <input type="hidden" name="manual_total" value="{{ card.manual_amount|stringformat:'d' }}">
                                                        <input type="hidden" name="default_total" value="{{ card.default_amount|stringformat:'d' }}">
                                                        <button type="submit" class="w-full bg-white text-blue-600 border-2 border-blue-500 px-4 py-2.5 rounded-lg hover:bg-blue-50 transition font-bold">
                                                            æœˆæ¬¡è¨ˆç”»ã«åæ˜ 
                                                        </button>
                                                    </form>
                                                </div>
                                                <div class="p-3 space-y-3">
                                            {% for est in card.estimates %}
                                                <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4 {% if est.estimate.is_default %}border-green-500{% else %}border-blue-500{% endif %}">
                                            <div class="p-4">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900">{{ est.memo|default:"ï¼ˆæ˜ç´°åãªã—ï¼‰" }}</h3>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            {% if est.estimate.purchase_date %}
                                                                ğŸ“… {{ est.estimate.purchase_date|date:"Y/m/d" }}
                                                            {% elif est.estimate.due_date %}
                                                                ğŸ“… {{ est.estimate.due_date|date:"Y/m/d" }}
                                                            {% else %}
                                                                ğŸ“… {{ month_data.year_month|slice:":4" }}/{{ month_data.year_month|slice:"5:7" }}/01
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <span class="text-xl font-bold text-red-600">
                                                        {% if est.estimate.is_usd and est.estimate.usd_amount %}
                                                            <span class="text-gray-900">${{ est.estimate.usd_amount }}</span>
                                                            <span class="text-sm text-gray-500">({{ est.amount|yen }})</span>
                                                        {% else %}
                                                            {{ est.amount|yen }}
                                                        {% endif %}
                                                    </span>
                                                </div>

                                                {% if est.estimate.is_split_payment %}
                                                <div class="mb-3 flex gap-2">
                                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">åˆ†å‰²æ‰•ã„</span>
                                                    {% if est.estimate.split_payment_part == 1 %}
                                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">1å›ç›®</span>
                                                    {% elif est.estimate.split_payment_part == 2 %}
                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2å›ç›®</span>
                                                    {% endif %}
                                                </div>
                                                {% endif %}

                                                <div class="flex gap-2">
                                                    {% if est.estimate.pk %}
                                                    <button type="button" class="edit-estimate-btn flex-1 bg-blue-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2 font-medium"
                                                        data-pk="{{ est.estimate.pk }}"
                                                        data-year-month="{{ est.estimate.year_month }}"
                                                        data-card-type="{{ est.estimate.card_type }}"
                                                        data-description="{{ est.estimate.description }}"
                                                        data-amount="{{ est.estimate.amount|stringformat:'d' }}"
                                                        data-due-date="{{ est.estimate.due_date|date:'Y-m-d' }}"
                                                        data-purchase-date="{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}"
                                                        data-is-split-payment="{{ est.estimate.is_split_payment|lower }}"
                                                        data-is-bonus-payment="{{ est.estimate.is_bonus_payment|lower }}"
                                                        data-is-default="{{ est.estimate.is_default|lower }}"
                                                        data-default-id="{{ est.estimate.default_id|default:'' }}">
                                                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        ç·¨é›†
                                                    </button>
                                                    {% if est.estimate.is_default %}
                                                    <button type="submit" form="delete-default-form-{{ est.estimate.default_id }}-{{ est.estimate.year_month }}" class="flex-1 bg-red-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2 font-medium">
                                                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        å‰Šé™¤
                                                    </button>
                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" id="delete-default-form-{{ est.estimate.default_id }}-{{ est.estimate.year_month }}" class="delete-default-form" style="display:none;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="delete_default_for_month">
                                                        <input type="hidden" name="default_id" value="{{ est.estimate.default_id }}">
                                                        <input type="hidden" name="year_month" value="{{ est.estimate.year_month }}">
                                                    </form>
                                                    {% else %}
                                                    <button type="submit" form="delete-estimate-form-{{ est.estimate.pk }}" class="flex-1 bg-red-500 text-white text-sm px-3 py-2.5 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2 font-medium">
                                                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        å‰Šé™¤
                                                    </button>
                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" id="delete-estimate-form-{{ est.estimate.pk }}" class="delete-estimate-form" style="display:none;">
                                                        {% csrf_token %}
                                                    </form>
                                                    {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                                </div>
                                            {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- ãƒ¢ãƒã‚¤ãƒ«åˆè¨ˆ -->
                            <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4 border-2 border-purple-300 shadow-md">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="font-bold text-purple-900">{{ year }}å¹´ åˆè¨ˆ</span>
                                    </div>
                                    <span class="text-lg font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                    </span>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-white rounded-lg shadow p-4 text-center text-gray-500 text-sm">
                                ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto" onclick="event.stopPropagation()">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">è¦‹ç©ã‚Šæ–°è¦è¿½åŠ </h3>
            <button type="button" onclick="closeCreateModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="createEstimateForm" method="post" action="{% url 'budget_app:credit_estimates' %}" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_estimate">

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</label>
                <select name="card_type" id="create_card_type" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    {% for card in card_choices %}
                    <option value="{{ card.key }}"{% if forloop.first %} selected{% endif %}>{{ card.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">å†…å®¹</label>
                <input type="text" name="description" id="create_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="ä¾‹: æ—…è¡Œã€å®¶é›»ãªã©">
            </div>

            <!-- é‡‘é¡å…¥åŠ› -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <label class="block text-sm font-semibold text-gray-700" id="create_past_amount_label">é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <label class="flex items-center cursor-pointer text-xs text-gray-600 hover:text-blue-600 transition">
                        <input type="checkbox" name="is_usd" id="create_past_is_usd" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 mr-1" onchange="togglePastCurrencyInput('create')">
                        <span>ğŸ’µ ãƒ‰ãƒ«</span>
                    </label>
                </div>
                <!-- å††å…¥åŠ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰ -->
                <div id="create_past_jpy_input">
                    <input type="number" name="amount" id="create_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
                </div>
                <!-- ãƒ‰ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
                <div id="create_past_usd_input" class="hidden">
                    <input type="number" name="usd_amount" id="create_amount_usd" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="19.99">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">åˆ©ç”¨æ—¥</label>
                <input type="date" name="purchase_date" id="create_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
            </div>

            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="create_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">åˆ†å‰²2å›æ‰•ã„</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="create_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="create_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„</span>
                </label>
            </div>

            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    è¿½åŠ 
                </button>
            </div>
        </form>
    </div>
</div>

<!-- æœˆæ¬¡è¨ˆç”»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="planModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closePlanModal()">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-lg sm:rounded-2xl transform transition-all my-2 sm:my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-lg sm:rounded-t-2xl px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center sticky top-0 z-10">
            <h3 id="planModalTitle" class="text-base sm:text-lg font-bold text-white">æœˆæ¬¡è¨ˆç”»ã®ç·¨é›†</h3>
            <button type="button" onclick="closePlanModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="planForm" method="post" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="plan_year_month">

            <!-- åå…¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="bg-green-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-green-800 mb-2 sm:mb-3">åå…¥</h4>
                <div id="incomeFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <!-- æ”¯å‡ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="bg-red-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-red-800 mb-2 sm:mb-3">æ”¯å‡º</h4>
                <div id="expenseFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <div class="flex gap-2 pt-2 sm:pt-3 sticky bottom-0 bg-white pb-1">
                <button type="button" onclick="closePlanModal()" class="flex-1 px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-3 sm:px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium transition shadow-md text-sm">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">è¦‹ç©ã‚Šç·¨é›†</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ãƒœãƒ‡ã‚£ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="edit_year_month_hidden">

            <!-- ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEWã‚«ãƒ¼ãƒ‰</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">æ¥½å¤©ã‚«ãƒ¼ãƒ‰</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPayã‚«ãƒ¼ãƒ‰</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- å†…å®¹ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">å†…å®¹</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="ä¾‹: æ—…è¡Œã€å®¶é›»ãªã©">
            </div>

            <!-- é‡‘é¡ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">é‡‘é¡ï¼ˆå††ï¼‰</label>
                <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <!-- åˆ©ç”¨æ—¥ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">åˆ©ç”¨æ—¥</label>
                <input type="date" name="purchase_date" id="edit_purchase_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
            </div>

            <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">åˆ†å‰²2å›æ‰•ã„</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„</span>
                </label>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// åˆ†å‰²æ‰•ã„ã¨ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã‚’æ’ä»–çš„ã«ã™ã‚‹
document.addEventListener('DOMContentLoaded', function() {
    // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.querySelectorAll('.edit-estimate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const pk = this.dataset.pk;
            const yearMonth = this.dataset.yearMonth;
            const cardType = this.dataset.cardType;
            const description = this.dataset.description;
            const amount = parseInt(this.dataset.amount);
            const dueDate = this.dataset.dueDate;
            const purchaseDate = this.dataset.purchaseDate;
            const isSplitPayment = this.dataset.isSplitPayment === 'true';
            const isBonusPayment = this.dataset.isBonusPayment === 'true';
            const isDefault = this.dataset.isDefault === 'true';
            const defaultId = this.dataset.defaultId ? parseInt(this.dataset.defaultId) : null;

            openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault, defaultId);
        });
    });

    const splitCheckbox = document.getElementById('edit_is_split_payment');
    const bonusCheckbox = document.getElementById('edit_is_bonus_payment');

    if (splitCheckbox && bonusCheckbox) {
        splitCheckbox.addEventListener('change', function() {
            if (this.checked) {
                bonusCheckbox.checked = false;
            }
        });

        bonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                splitCheckbox.checked = false;
            }
        });
    }
});

function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault = false, defaultId = null) {
    console.log('openEditModal called with:', { pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment, isDefault, defaultId });
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');

    if (!modal) {
        console.error('editModal not found');
        return;
    }
    if (!form) {
        console.error('editForm not found');
        return;
    }

    console.log('Modal and form found', { modal, form });

    // ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ã™ã¹ã¦ã®inputã‚’ãƒ­ã‚°å‡ºåŠ›
    const allInputs = form.querySelectorAll('input');
    console.log('All inputs in form:', Array.from(allInputs).map(i => ({ id: i.id, name: i.name, type: i.type })));

    // å®šæœŸé …ç›®ã®å ´åˆã¯éå»ã®æ˜ç´°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
    if (isDefault) {
        form.setAttribute('action', "{% url 'budget_app:past_transactions' %}");
        // form_action hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
        let formActionInput = form.querySelector('input[name="form_action"]');
        if (!formActionInput) {
            formActionInput = document.createElement('input');
            formActionInput.type = 'hidden';
            formActionInput.name = 'form_action';
            form.appendChild(formActionInput);
        }
        formActionInput.value = 'edit_default_amount';

        // default_id hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
        let defaultIdInput = form.querySelector('input[name="default_id"]');
        if (!defaultIdInput) {
            defaultIdInput = document.createElement('input');
            defaultIdInput.type = 'hidden';
            defaultIdInput.name = 'default_id';
            form.appendChild(defaultIdInput);
        }
        defaultIdInput.value = defaultId;

        // year_month hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
        let yearMonthInput = form.querySelector('input[name="year_month"]');
        if (!yearMonthInput) {
            yearMonthInput = document.createElement('input');
            yearMonthInput.type = 'hidden';
            yearMonthInput.name = 'year_month';
            form.appendChild(yearMonthInput);
        }
        yearMonthInput.value = yearMonth;
    } else {
        form.setAttribute('action', `/credit-estimates/${pk}/edit/`);
        // å®šæœŸé …ç›®ç”¨ã®hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        const formActionInput = form.querySelector('input[name="form_action"]');
        if (formActionInput) formActionInput.remove();
        const defaultIdInput = form.querySelector('input[name="default_id"]');
        if (defaultIdInput) defaultIdInput.remove();
    }

    // å¹´æœˆã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šï¼ˆå¸¸ã«å¿…è¦ï¼‰
    const yearMonthHidden = form.querySelector('input[name="year_month"]');
    if (!yearMonthHidden) {
        console.error('year_month input not found');
        return;
    }
    yearMonthHidden.value = yearMonth;

    // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’è¨­å®š
    document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
        radio.checked = (radio.value === cardType);
        const label = radio.closest('.card-type-label');
        const box = label.querySelector('.card-type-box');
        const indicator = label.querySelector('.radio-indicator');
        const dot = label.querySelector('.radio-dot');

        if (radio.checked) {
            box.classList.add('border-blue-600', 'bg-blue-50');
            box.classList.remove('border-gray-300');
            indicator.classList.add('border-blue-600');
            indicator.classList.remove('border-gray-400');
            dot.classList.remove('hidden');
        } else {
            box.classList.remove('border-blue-600', 'bg-blue-50');
            box.classList.add('border-gray-300');
            indicator.classList.remove('border-blue-600');
            indicator.classList.add('border-gray-400');
            dot.classList.add('hidden');
        }
    });

    // é‡‘é¡ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆã‚«ãƒ³ãƒé™¤å»ï¼‰
    const numericAmount = typeof amount === 'string' ? parseInt(amount.replace(/,/g, ''), 10) : amount;

    // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
    const editDescription = form.querySelector('input[name="description"]');
    const editAmount = form.querySelector('input[name="amount"]');
    const editPurchaseDate = form.querySelector('input[name="purchase_date"]');
    const editIsSplitPayment = form.querySelector('input[name="is_split_payment"]');
    const editIsBonusPayment = form.querySelector('input[name="is_bonus_payment"]');

    if (!editDescription || !editAmount || !editPurchaseDate || !editIsSplitPayment || !editIsBonusPayment) {
        console.error('One or more edit form fields not found', {
            editDescription: !!editDescription,
            editAmount: !!editAmount,
            editPurchaseDate: !!editPurchaseDate,
            editIsSplitPayment: !!editIsSplitPayment,
            editIsBonusPayment: !!editIsBonusPayment
        });
        return;
    }

    editDescription.value = description || '';
    editAmount.value = numericAmount || '';
    editPurchaseDate.value = purchaseDate || dueDate || '';
    editIsSplitPayment.checked = isSplitPayment;
    editIsBonusPayment.checked = isBonusPayment;

    // å®šæœŸé …ç›®ã®å ´åˆã¯é …ç›®åã¨æ”¯æ‰•ç¨®åˆ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆåˆ©ç”¨æ—¥ã¯ç·¨é›†å¯èƒ½ã«ã™ã‚‹ï¼‰
    editDescription.disabled = isDefault;
    editIsSplitPayment.disabled = isDefault;
    editIsBonusPayment.disabled = isDefault;

    // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã«å¿œã˜ã¦åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºã‚’æ›´æ–°
    togglePaymentOptions();

    modal.classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

function toggleDetails(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');

        // ãƒ†ã‚­ã‚¹ãƒˆçŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¢ã—ã¦å‘ãã‚’å¤‰æ›´
        const arrow = document.querySelector(`[onclick*="toggleDetails('${id}')"] .arrow-icon`);
        if (arrow) {
            if (element.classList.contains('hidden')) {
                arrow.textContent = 'â–¼';
            } else {
                arrow.textContent = 'â–²';
            }
        }

        // SVGçŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¢ã—ã¦å‘ãã‚’å¤‰æ›´
        const svgArrow = document.getElementById('arrow-' + id);
        if (svgArrow) {
            if (element.classList.contains('hidden')) {
                svgArrow.classList.remove('rotate-180');
            } else {
                svgArrow.classList.add('rotate-180');
            }
        }
    }
}

// æœˆæ¬¡è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
async function openPlanModal(planId, displayYearMonth, yearMonth) {
    const modal = document.getElementById('planModal');
    const form = document.getElementById('planForm');
    const title = document.getElementById('planModalTitle');

    form.action = `/plans/${planId}/edit/`;
    title.textContent = `${displayYearMonth} ã®ç·¨é›†`;
    document.getElementById('plan_year_month').value = yearMonth;

    // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    try {
        const response = await fetch(`/plans/${planId}/data/`);
        const data = await response.json();

        // åå…¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
        const incomeFields = document.getElementById('incomeFields');
        incomeFields.innerHTML = '';

        if (data.income_items && data.income_items.length > 0) {
            data.income_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}ï¼ˆå††ï¼‰</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                `;
                incomeFields.appendChild(div);
            });
        }

        // æ”¯å‡ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
        const expenseFields = document.getElementById('expenseFields');
        expenseFields.innerHTML = '';

        if (data.expense_items && data.expense_items.length > 0) {
            data.expense_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}ï¼ˆå††ï¼‰</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition text-sm">
                `;
                expenseFields.appendChild(div);
            });
        }

        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading plan data:', error);
        showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function closePlanModal() {
    document.getElementById('planModal').classList.add('hidden');
}

// åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºåˆ¶å¾¡
function togglePaymentOptions() {
    const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
    const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
    const editSplitCheckbox = document.getElementById('edit_is_split_payment');
    const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');

    // é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’å–å¾—
    const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
    const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

    // åˆ†å‰²æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
    if (editSplitWrapper) {
        editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editSplitCheckbox) {
            editSplitCheckbox.checked = false;
        }
    }

    // ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
    if (editBonusWrapper) {
        editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editBonusCheckbox) {
            editBonusCheckbox.checked = false;
        }
    }
}

// ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¸æŠæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
document.querySelectorAll('#editModal .card-type-label').forEach(label => {
    label.addEventListener('click', function() {
        const radio = this.querySelector('.card-type-radio');
        radio.checked = true;

        // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('#editModal .card-type-label').forEach(otherLabel => {
            const otherBox = otherLabel.querySelector('.card-type-box');
            const otherIndicator = otherLabel.querySelector('.radio-indicator');
            const otherDot = otherLabel.querySelector('.radio-dot');

            otherBox.classList.remove('border-blue-600', 'bg-blue-50');
            otherBox.classList.add('border-gray-300');
            otherIndicator.classList.remove('border-blue-600');
            otherIndicator.classList.add('border-gray-400');
            otherDot.classList.add('hidden');
        });

        // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
        const box = this.querySelector('.card-type-box');
        const indicator = this.querySelector('.radio-indicator');
        const dot = this.querySelector('.radio-dot');

        box.classList.add('border-blue-600', 'bg-blue-50');
        box.classList.remove('border-gray-300');
        indicator.classList.add('border-blue-600');
        indicator.classList.remove('border-gray-400');
        dot.classList.remove('hidden');

        // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥å¤‰æ›´æ™‚ã«åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºã‚’æ›´æ–°
        togglePaymentOptions();
    });
});

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');
    const toastContainer = toast.querySelector('div');

    // ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
    if (type === 'success') {
        icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    } else if (type === 'error') {
        icon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    }

    messageEl.textContent = message;
    toast.classList.remove('hidden');

    // 3ç§’å¾Œã«éè¡¨ç¤º
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†ï¼ˆAJAXï¼‰
const editForm = document.getElementById('editForm');
editForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(editForm);

    // ãƒ‡ãƒãƒƒã‚°: FormDataã®å†…å®¹ã‚’ç¢ºèª
    console.log('Form action:', editForm.action);
    for (let [key, value] of formData.entries()) {
        console.log(key + ':', value);
    }

    await window.sendAjaxRequest(editForm.action, formData, {
        closeModal: closeEditModal,
        reloadOnSuccess: true,  // ç·¨é›†æˆåŠŸå¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        onSuccess: (data) => {
            // target_urlãŒã‚ã‚‹å ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å±•é–‹ã®ãŸã‚ï¼‰
            if (data.target_url) {
                window.location.href = data.target_url;
            }
        }
    });
});

// æœˆæ¬¡è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†ï¼ˆAJAXï¼‰
const planForm = document.getElementById('planForm');
if (planForm) {
    planForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        await window.sendAjaxRequest(this.action, formData, {
            closeModal: closePlanModal
        });
    });
}

// --- åæ˜ ãƒœã‚¿ãƒ³ã®éåŒæœŸå‡¦ç† ---
document.querySelectorAll('.reflect-card-form').forEach(reflectForm => {
    reflectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã®åˆè¨ˆé¡ã‚’æœˆæ¬¡è¨ˆç”»ã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ')) return;

        await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(reflectForm), {
            toastDuration: 3000,  // 3ç§’è¡¨ç¤º
            reloadOnSuccess: true  // è‡ªå‹•çš„ã«æœˆæ¬¡è¨ˆç”»ãƒšãƒ¼ã‚¸ã¸é·ç§»
        });
    });
});

// å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç†
document.querySelectorAll('.delete-estimate-form').forEach(deleteForm => {
    deleteForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        const formData = new FormData();
        formData.append('delete_type', 'single');

        await window.sendAjaxRequest(deleteForm.action, formData, {
            reloadOnSuccess: true  // å‰Šé™¤æˆåŠŸå¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è©²å½“æœˆã‚’å±•é–‹
        });
    });
});

// --- å®šæœŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã®å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ ã®éåŒæœŸå‡¦ç† ---
document.querySelectorAll('.delete-default-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!confirm('ã“ã®æœˆã®å®šæœŸé …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(form), {
            reloadOnSuccess: true  // å‰Šé™¤æˆåŠŸå¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        });
    });
});

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ãé–¢æ•°ï¼ˆã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šã¨æœˆæ¬¡è¨ˆç”»ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
function expandEstimateSection(hash) {
    if (!hash) return;

    let yearMonth, scrollTarget = null, isEstimateSection = false, isPlanSection = false;

    // ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
    if (hash.startsWith('#estimate-content-')) {
        isEstimateSection = true;
        yearMonth = hash.replace('#estimate-content-', '').replace('-mobile', '');
    }
    // æœˆæ¬¡è¨ˆç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
    else if (hash.startsWith('#plan-content-')) {
        isPlanSection = true;
        yearMonth = hash.replace('#plan-content-', '').replace('-mobile', '');
    }

    if (yearMonth) {
        // ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å±•é–‹
        if (isEstimateSection) {
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
            document.querySelectorAll('[id^="desktop-credit-"]').forEach(element => {
                const tdWithAnchor = element.querySelector(`#estimate-content-${yearMonth}`);
                if (tdWithAnchor && element.classList.contains('hidden')) {
                    element.classList.remove('hidden');
                }
            });

            // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
            const mobileDetails = document.getElementById(`mobile-credit-${yearMonth}`);
            if (mobileDetails && mobileDetails.classList.contains('hidden')) {
                mobileDetails.classList.remove('hidden');
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å…ˆ: ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ã¾ãŸã¯è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            scrollTarget = document.querySelector(`[onclick*="toggleDetails('mobile-credit-${yearMonth}')"]`);
            if (!scrollTarget) {
                scrollTarget = document.getElementById(`estimate-content-${yearMonth}`);
            }
        }
        // æœˆæ¬¡è¨ˆç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å±•é–‹
        else if (isPlanSection) {
            // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
            document.querySelectorAll('[id^="desktop-plan-"]').forEach(element => {
                const tdWithAnchor = element.querySelector(`#plan-content-${yearMonth}`);
                if (tdWithAnchor && element.classList.contains('hidden')) {
                    element.classList.remove('hidden');
                }
            });

            // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
            const mobileParent = document.getElementById(`plan-content-mobile-${yearMonth}`);
            if (mobileParent) {
                const mobileDetails = mobileParent.querySelector('[id^="mobile-plan-"]');
                if (mobileDetails && mobileDetails.classList.contains('hidden')) {
                    mobileDetails.classList.remove('hidden');
                }
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å…ˆ: ãƒ¢ãƒã‚¤ãƒ«è¦ªè¦ç´ ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ã¾ãŸã¯è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            scrollTarget = document.getElementById(`plan-content-mobile-${yearMonth}`);
            if (!scrollTarget) {
                scrollTarget = document.getElementById(`plan-content-${yearMonth}`);
            }
        }

        // è¦ç´ ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ï¼‰
        if (scrollTarget) {
            setTimeout(() => {
                const header = document.querySelector('nav');
                const headerHeight = header ? header.offsetHeight : 0;
                const elementPosition = scrollTarget.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight - 20;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }, 200);
        }
    }
}

// Djangoã®messagesãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒˆãƒ¼ã‚¹ãƒˆã§è¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        window.showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}

    // æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
    const createForm = document.getElementById('createEstimateForm');
    if (createForm) {
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await window.sendAjaxRequest("{% url 'budget_app:credit_estimates' %}", new FormData(createForm), {
                closeModal: closeCreateModal,
                onSuccess: (data) => {
                    // æˆåŠŸã—ãŸã‚‰ã‚¯ãƒ¬ã‚«è¦‹ç©ã‚‚ã‚Šãƒšãƒ¼ã‚¸ã«ç§»å‹•ï¼ˆtarget_urlãŒã‚ã‚Œã°ãã®ã‚¢ãƒ³ã‚«ãƒ¼ã«ç§»å‹•ï¼‰
                    console.log('Create estimate success, data:', data);
                    if (data.target_url) {
                        console.log('target_url:', data.target_url);
                        // target_urlã‹ã‚‰ã‚¢ãƒ³ã‚«ãƒ¼éƒ¨åˆ†ã‚’æŠ½å‡º
                        const urlParts = data.target_url.split('#');
                        console.log('urlParts:', urlParts);
                        if (urlParts.length > 1) {
                            // ã‚¢ãƒ³ã‚«ãƒ¼ã‚’sessionStorageã«ä¿å­˜
                            const anchor = '#' + urlParts[1];
                            console.log('Saving anchor to sessionStorage:', anchor);
                            sessionStorage.setItem('scrollToAnchor', anchor);
                            // ã‚¢ãƒ³ã‚«ãƒ¼ãªã—ã®URLã«é·ç§»ï¼ˆsessionStorageã‹ã‚‰èª­ã¿å–ã£ã¦å‡¦ç†ã•ã‚Œã‚‹ï¼‰
                            console.log('Navigating to:', urlParts[0]);
                            window.location.href = urlParts[0];
                        } else {
                            console.log('No anchor found, navigating to target_url directly');
                            window.location.href = data.target_url;
                        }
                    } else {
                        console.log('No target_url, navigating to credit estimates page');
                        window.location.href = "{% url 'budget_app:credit_estimates' %}";
                    }
                }
            });
        });
    }

    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥å¤‰æ›´æ™‚ã®å‡¦ç†
    const createCardType = document.getElementById('create_card_type');
    if (createCardType) {
        createCardType.addEventListener('change', toggleCreatePaymentOptions);
    }

    // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ†å‰²ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã‚’æ’ä»–çš„ã«ã™ã‚‹
    const createSplitCheckbox = document.getElementById('create_is_split_payment');
    const createBonusCheckbox = document.getElementById('create_is_bonus_payment');

    if (createSplitCheckbox && createBonusCheckbox) {
        createSplitCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createBonusCheckbox.checked = false;
            }
        });

        createBonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                createSplitCheckbox.checked = false;
            }
        });
    }

    // sessionStorageã‹ã‚‰ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å–å¾—ï¼ˆcommon.jsã§ãƒªãƒ­ãƒ¼ãƒ‰å‰ã«ä¿å­˜ã•ã‚Œã‚‹ï¼‰
    const savedAnchor = sessionStorage.getItem('scrollToAnchor');
    if (savedAnchor) {
        // URLã®ãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
        window.location.hash = savedAnchor;
        // sessionStorageã‚’ã‚¯ãƒªã‚¢ï¼ˆbase.htmlã§ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚ï¼‰
        sessionStorage.removeItem('scrollToAnchor');
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å±•é–‹
        expandEstimateSection(savedAnchor);
    } else {
        // URLã®ãƒãƒƒã‚·ãƒ¥ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€è©²å½“ã™ã‚‹æœˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•çš„ã«é–‹ã
        expandEstimateSection(window.location.hash);
    }
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆbase.htmlã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã®å¾Œã«å®Ÿè¡Œï¼‰
window.addEventListener('load', function() {
    // å°‘ã—é…å»¶ã•ã›ã¦ã€base.htmlã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
    setTimeout(() => {
        // URLã®ãƒãƒƒã‚·ãƒ¥ã¾ãŸã¯sessionStorageã‹ã‚‰å–å¾—ã—ãŸã‚¢ãƒ³ã‚«ãƒ¼ã§å±•é–‹
        const hash = window.location.hash;
        if (hash) {
            expandEstimateSection(hash);
        }
    }, 400);
});

// é€šè²¨å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
function togglePastCurrencyInput(mode) {
    // mode: 'create'
    const isUsdCheckbox = document.getElementById(`${mode}_past_is_usd`);
    const jpyInput = document.getElementById(`${mode}_past_jpy_input`);
    const usdInput = document.getElementById(`${mode}_past_usd_input`);
    const label = document.getElementById(`${mode}_past_amount_label`);

    if (isUsdCheckbox && jpyInput && usdInput) {
        if (isUsdCheckbox.checked) {
            jpyInput.classList.add('hidden');
            usdInput.classList.remove('hidden');
            if (label) label.textContent = 'é‡‘é¡ï¼ˆãƒ‰ãƒ«ï¼‰';
        } else {
            jpyInput.classList.remove('hidden');
            usdInput.classList.add('hidden');
            if (label) label.textContent = 'é‡‘é¡ï¼ˆå††ï¼‰';
        }
    }
}

// æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openCreateModal() {
    const modal = document.getElementById('createModal');
    modal.classList.remove('hidden');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('createEstimateForm').reset();

    // åˆ©ç”¨æ—¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æœ¬æ—¥ã«è¨­å®š
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    document.getElementById('create_purchase_date').value = todayStr;

    // åˆ†å‰²ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
    toggleCreatePaymentOptions();
}

function closeCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
}

// æ–°è¦ä½œæˆæ™‚ã®åˆ†å‰²æ‰•ã„ãƒ»ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã®è¡¨ç¤ºåˆ¶å¾¡
function toggleCreatePaymentOptions() {
    const createSplitWrapper = document.getElementById('create_split_payment_wrapper');
    const createBonusWrapper = document.getElementById('create_bonus_payment_wrapper');
    const createSplitCheckbox = document.getElementById('create_is_split_payment');
    const createBonusCheckbox = document.getElementById('create_is_bonus_payment');

    // é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’å–å¾—
    const cardTypeSelect = document.getElementById('create_card_type');
    const isViewCard = cardTypeSelect && cardTypeSelect.value === 'item_6';

    // åˆ†å‰²æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
    if (createSplitWrapper) {
        createSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && createSplitCheckbox) {
            createSplitCheckbox.checked = false;
        }
    }

    // ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¯VIEWã‚«ãƒ¼ãƒ‰ã®å ´åˆã®ã¿è¡¨ç¤º
    if (createBonusWrapper) {
        createBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && createBonusCheckbox) {
            createBonusCheckbox.checked = false;
        }
    }
}

// å®šæœŸé …ç›®ã®é‡‘é¡ã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
function editDefaultAmount(defaultId, yearMonth, cardType, currentAmount) {
    const newAmount = prompt('æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentAmount);
    if (newAmount === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ

    const amount = parseInt(newAmount);
    if (isNaN(amount) || amount < 0) {
        alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch('{% url "budget_app:past_transactions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'edit_default_amount',
            'default_id': defaultId,
            'year_month': yearMonth,
            'card_type': cardType,
            'amount': amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
        }
    })
    .catch(error => {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        console.error(error);
    });
}
</script>
{% endblock %}
