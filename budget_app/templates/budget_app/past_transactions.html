{% extends 'budget_app/base.html' %}
{% load budget_filters %}

{% block title %}過去の明細{% endblock %}

{% block content %}
<!-- トースト通知 -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border-l-4 rounded-lg shadow-lg p-4 max-w-md">
        <div class="flex items-center">
            <div id="toast-icon" class="flex-shrink-0 mr-3"></div>
            <div id="toast-message" class="text-sm font-medium"></div>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <h1 class="text-2xl md:text-3xl font-bold">過去の明細</h1>
    </div>

    {% if not sorted_years %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
            <p class="text-yellow-800">過去の明細データがありません</p>
        </div>
    {% else %}
        {% for year in sorted_years %}
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 pb-2 border-b-2 border-gray-300">
                    {{ year }}年
                </h2>

                <!-- デスクトップ表示 -->
                <div class="hidden md:flex md:gap-6 md:items-start">
                    <!-- 月次計画 -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-blue-100 px-4 py-2 font-semibold text-blue-800">月次計画</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">収入</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">支出</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">純収支</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in yearly_data|get_item:year|get_item:'months' %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                            <span class="cursor-pointer" onclick="toggleDetails('desktop-plan-{{ year }}-{{ forloop.counter }}')">
                                                {{ item.year_month|format_year_month }}
                                                <span class="text-xs text-gray-400 ml-1">▼</span>
                                            </span>
                                            <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="ml-2 text-xs text-blue-600 hover:text-blue-800">編集</button>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                            {{ item.income|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                            {{ item.expenses|yen }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %} font-medium">
                                            {{ item.net_income|yen }}
                                        </td>
                                    </tr>
                                    <tr id="desktop-plan-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                        <td colspan="4" class="px-4 py-4">
                                            <div class="text-xs space-y-2">
                                                <div class="font-semibold text-blue-700 mb-2">明細一覧</div>
                                                {% for trans in item.transactions %}
                                                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-gray-500">
                                                                {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                            </span>
                                                            <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                        </div>
                                                        <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium">{{ trans.amount|yen }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="flex-1 bg-white rounded-lg shadow overflow-hidden self-start">
                        <h3 class="bg-purple-100 px-4 py-2 font-semibold text-purple-800">クレカ請求</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年月</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">合計金額</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('desktop-credit-{{ year }}-{{ forloop.counter }}')">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                                {{ month_data.year_month|format_year_month }}
                                                <span class="text-xs text-gray-400 ml-1">▼</span>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                {{ month_data.total_amount|yen }}
                                            </td>
                                        </tr>
                                        <tr id="desktop-credit-{{ year }}-{{ forloop.counter }}" class="hidden bg-gray-50">
                                            <td colspan="2" class="px-4 py-4">
                                                <div class="text-xs space-y-3">
                                                    {% for card in month_data.cards %}
                                                        <div>
                                                            <div class="flex justify-between items-center mb-1">
                                                                <div class="font-semibold text-purple-700">{{ card.card_name }}</div>
                                                                <div class="flex items-center gap-2">
                                                                    <span class="text-red-600 font-medium text-sm">{{ card.total_amount|yen }}</span>
                                                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline">
                                                                        {% csrf_token %}
                                                                        <input type="hidden" name="action" value="reflect_card">
                                                                        <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                                        <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                                        <button type="submit" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">反映</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <div class="space-y-1">
                                                                {% for est in card.estimates %}
                                                                    <div class="bg-white p-2 rounded border border-gray-200">
                                                                        <div class="flex justify-between items-center">
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-gray-500">
                                                                                    {% if est.estimate.is_bonus_payment and est.estimate.purchase_date %}
                                                                                        {{ est.estimate.purchase_date|date:"Y/n/j" }}
                                                                                    {% elif est.estimate.due_date %}
                                                                                        {{ est.estimate.due_date|date:"Y/n/j" }}
                                                                                    {% else %}
                                                                                        {{ est.estimate.year_month }}
                                                                                    {% endif %}
                                                                                </span>
                                                                                <span class="font-medium text-gray-700">{{ est.memo|default:"（明細名なし）" }}</span>
                                                                                {% if est.estimate.is_split_payment %}
                                                                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">分割払い</span>
                                                                                    {% if est.estimate.split_payment_part == 1 %}
                                                                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded">1回目</span>
                                                                                    {% elif est.estimate.split_payment_part == 2 %}
                                                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2回目</span>
                                                                                    {% endif %}
                                                                                {% endif %}
                                                                            </div>
                                                                            <div class="flex items-center gap-2">
                                                                                <span class="text-red-600 font-medium">{{ est.amount|yen }}</span>
                                                                                <div class="flex gap-1">
                                                                                    <button type="button" onclick="openEditModal({{ est.estimate.pk }}, '{{ est.estimate.year_month }}', '{{ est.estimate.card_type }}', '{{ est.estimate.description|escapejs }}', {{ est.estimate.amount }}, '{{ est.estimate.due_date|date:'Y-m-d' }}', '{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}', {{ est.estimate.is_split_payment|lower }}, {{ est.estimate.is_bonus_payment|lower }})" class="text-blue-600 hover:text-blue-800 text-xs cursor-pointer">編集</button>
                                                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" class="inline" onsubmit="return confirm('本当に削除しますか？');">
                                                                                        {% csrf_token %}
                                                                                        <button type="submit" class="text-red-600 hover:text-red-800 text-xs">削除</button>
                                                                                    </form>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">合計</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-red-700">
                                            {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        {% else %}
                            <div class="px-4 py-8 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- モバイル表示 -->
                <div class="md:hidden space-y-6">
                    <!-- 月次計画 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-blue-800 bg-blue-100 px-3 py-2 rounded">月次計画</h3>
                        {% for item in yearly_data|get_item:year|get_item:'months' %}
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="font-semibold text-gray-800 mb-3 pb-2 border-b flex justify-between items-center">
                                    <span class="cursor-pointer" onclick="toggleDetails('mobile-plan-{{ year }}-{{ forloop.counter }}')">
                                        {{ item.year_month|format_year_month }}
                                        <span class="text-xs text-gray-400 ml-1">▼</span>
                                    </span>
                                    <button type="button" onclick="openPlanModal({{ item.plan.pk }}, '{{ item.year_month|format_year_month }}', '{{ item.year_month }}')" class="text-xs text-blue-600 hover:text-blue-800">編集</button>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">収入</span>
                                        <span class="text-sm font-medium text-green-600">{{ item.income|yen }}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">支出</span>
                                        <span class="text-sm font-medium text-red-600">{{ item.expenses|yen }}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">純収支</span>
                                        <span class="text-sm font-medium {% if item.net_income >= 0 %}text-blue-600{% else %}text-orange-600{% endif %}">{{ item.net_income|yen }}</span>
                                    </div>
                                </div>
                                <div id="mobile-plan-{{ year }}-{{ forloop.counter }}" class="hidden mt-3 pt-3 border-t border-gray-200">
                                    <div class="space-y-2">
                                        <div class="font-semibold text-blue-700 text-xs mb-2">明細一覧</div>
                                        {% for trans in item.transactions %}
                                            <div class="bg-gray-50 p-2 rounded text-xs flex justify-between items-center">
                                                <div class="flex items-center gap-1 flex-wrap">
                                                    <span class="text-gray-500">
                                                        {{ item.year_month|slice:":4" }}/{{ item.year_month|slice:"5:7" }}{% if trans.date %}/{{ trans.date|date:"j" }}{% endif %}
                                                    </span>
                                                    <span class="font-medium text-gray-700">{{ trans.name }}</span>
                                                </div>
                                                <span class="{% if trans.type == 'income' %}text-green-600{% else %}text-red-600{% endif %} font-medium whitespace-nowrap">{{ trans.amount|yen }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                        <!-- モバイル合計 -->
                        <div class="bg-gray-100 rounded-lg shadow p-4 border-2 border-gray-300">
                            <div class="font-bold text-gray-900 mb-3">{{ year }}年 合計</div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">収入合計</span>
                                    <span class="text-sm font-bold text-green-700">
                                        {{ yearly_data|get_item:year|get_item:'total_income'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">支出合計</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_expenses'|yen }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                                    <span class="text-sm font-semibold text-gray-700">純収支</span>
                                    <span class="text-sm font-bold {% if yearly_data|get_item:year|get_item:'total_net_income' >= 0 %}text-blue-700{% else %}text-orange-700{% endif %}">
                                        {{ yearly_data|get_item:year|get_item:'total_net_income'|yen }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- クレカ見積り -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-purple-800 bg-purple-100 px-3 py-2 rounded">クレカ請求</h3>
                        {% if yearly_data|get_item:year|get_item:'credit_months' %}
                            {% for month_data in yearly_data|get_item:year|get_item:'credit_months' %}
                                <div class="bg-white rounded-lg shadow p-4">
                                    <div class="font-semibold text-gray-800 mb-3 pb-2 border-b cursor-pointer" onclick="toggleDetails('mobile-credit-{{ year }}-{{ forloop.counter }}')">
                                        {{ month_data.year_month|format_year_month }}
                                        <span class="text-xs text-gray-400 ml-1">▼</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">合計金額</span>
                                        <span class="text-sm font-medium text-red-600">{{ month_data.total_amount|yen }}</span>
                                    </div>
                                    <div id="mobile-credit-{{ year }}-{{ forloop.counter }}" class="hidden mt-3 pt-3 border-t border-gray-200">
                                        <div class="space-y-3">
                                            {% for card in month_data.cards %}
                                                <div>
                                                    <div class="flex justify-between items-center mb-1">
                                                        <div class="font-semibold text-purple-700 text-xs">{{ card.card_name }}</div>
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-red-600 font-medium text-xs">{{ card.total_amount|yen }}</span>
                                                            <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="reflect_card">
                                                                <input type="hidden" name="year_month" value="{{ month_data.year_month }}">
                                                                <input type="hidden" name="card_type" value="{{ card.card_type }}">
                                                                <button type="submit" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">反映</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        {% for est in card.estimates %}
                                                            <div class="bg-gray-50 p-2 rounded text-xs">
                                                                <div class="flex justify-between items-start mb-1">
                                                                    <div class="flex items-center gap-1 flex-wrap">
                                                                        <span class="text-gray-500">
                                                                            {% if est.estimate.is_bonus_payment and est.estimate.purchase_date %}
                                                                                {{ est.estimate.purchase_date|date:"Y/n/j" }}
                                                                            {% elif est.estimate.due_date %}
                                                                                {{ est.estimate.due_date|date:"Y/n/j" }}
                                                                            {% else %}
                                                                                {{ est.estimate.year_month }}
                                                                            {% endif %}
                                                                        </span>
                                                                        <span class="font-medium text-gray-700">{{ est.memo|default:"（明細名なし）" }}</span>
                                                                        {% if est.estimate.is_split_payment %}
                                                                            <span class="px-1.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">分割払い</span>
                                                                            {% if est.estimate.split_payment_part == 1 %}
                                                                                <span class="px-1.5 py-0.5 bg-green-100 text-green-800 text-xs rounded">1回目</span>
                                                                            {% elif est.estimate.split_payment_part == 2 %}
                                                                                <span class="px-1.5 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">2回目</span>
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </div>
                                                                    <span class="text-red-600 font-medium whitespace-nowrap">{{ est.amount|yen }}</span>
                                                                </div>
                                                                <div class="flex gap-2 justify-end">
                                                                    <button type="button" onclick="openEditModal({{ est.estimate.pk }}, '{{ est.estimate.year_month }}', '{{ est.estimate.card_type }}', '{{ est.estimate.description|escapejs }}', {{ est.estimate.amount }}, '{{ est.estimate.due_date|date:'Y-m-d' }}', '{{ est.estimate.purchase_date|date:'Y-m-d'|default:'' }}', {{ est.estimate.is_split_payment|lower }}, {{ est.estimate.is_bonus_payment|lower }})" class="text-blue-600 hover:text-blue-800 text-xs cursor-pointer">編集</button>
                                                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' est.estimate.pk %}" class="inline" onsubmit="return confirm('本当に削除しますか？');">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="text-red-600 hover:text-red-800 text-xs">削除</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- モバイル合計 -->
                            <div class="bg-gray-100 rounded-lg shadow p-4 border-2 border-gray-300">
                                <div class="font-bold text-gray-900 mb-3">{{ year }}年 クレカ合計</div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-700">合計金額</span>
                                    <span class="text-sm font-bold text-red-700">
                                        {{ yearly_data|get_item:year|get_item:'total_credit'|yen }}
                                    </span>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-white rounded-lg shadow p-4 text-center text-gray-500 text-sm">
                                クレカ見積りデータがありません
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>

<!-- 月次計画編集モーダル -->
<div id="planModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closePlanModal()">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-lg sm:rounded-2xl transform transition-all my-2 sm:my-4 max-h-[85vh] overflow-y-auto overflow-x-hidden" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-lg sm:rounded-t-2xl px-3 sm:px-4 py-2.5 sm:py-3 flex justify-between items-center sticky top-0 z-10">
            <h3 id="planModalTitle" class="text-base sm:text-lg font-bold text-white">月次計画の編集</h3>
            <button type="button" onclick="closePlanModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="planForm" method="post" class="p-3 sm:p-4 space-y-3 sm:space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="plan_year_month">

            <!-- 収入セクション -->
            <div class="bg-green-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-green-800 mb-2 sm:mb-3">収入</h4>
                <div id="incomeFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <!-- 支出セクション -->
            <div class="bg-red-50 p-3 sm:p-4 rounded-lg">
                <h4 class="font-semibold text-sm text-red-800 mb-2 sm:mb-3">支出</h4>
                <div id="expenseFields" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3"></div>
            </div>

            <div class="flex gap-2 pt-2 sm:pt-3 sticky bottom-0 bg-white pb-1">
                <button type="button" onclick="closePlanModal()" class="flex-1 px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-3 sm:px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<!-- クレカ見積もり編集モーダル -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-white shadow-2xl rounded-2xl transform transition-all my-4 flex flex-col max-h-[85vh] overflow-x-hidden overflow-y-auto">
        <!-- ヘッダー -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-t-2xl px-4 py-3 flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-bold text-white">見積り編集</h3>
            <button type="button" onclick="closeEditModal()" class="text-white hover:text-gray-200 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- ボディ -->
        <form id="editForm" method="post" class="p-4 pb-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="year_month" id="edit_year_month_hidden">

            <!-- 年月 -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">利用年</label>
                    <select name="year" id="edit_year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">利用月</label>
                    <select name="month" id="edit_month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                        <option value="01">1月</option>
                        <option value="02">2月</option>
                        <option value="03">3月</option>
                        <option value="04">4月</option>
                        <option value="05">5月</option>
                        <option value="06">6月</option>
                        <option value="07">7月</option>
                        <option value="08">8月</option>
                        <option value="09">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
            </div>

            <!-- カード種別 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">カード種別</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="relative cursor-pointer card-type-label" data-value="item_6">
                        <input type="radio" name="card_type" value="item_6" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VIEWカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_8">
                        <input type="radio" name="card_type" value="item_8" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">楽天カード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_9">
                        <input type="radio" name="card_type" value="item_9" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">PayPayカード</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_10">
                        <input type="radio" name="card_type" value="item_10" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">VERMILLION</span>
                            </div>
                        </div>
                    </label>
                    <label class="relative cursor-pointer card-type-label" data-value="item_12">
                        <input type="radio" name="card_type" value="item_12" class="hidden card-type-radio">
                        <div class="border-2 border-gray-300 rounded-lg p-2 transition hover:border-blue-400 hover:bg-blue-50 card-type-box">
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center mr-2 radio-indicator">
                                    <div class="w-2.5 h-2.5 rounded-full bg-blue-600 hidden radio-dot"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-700">Olive</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 内容 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">内容</label>
                <input type="text" name="description" id="edit_description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="例: 旅行、家電など">
            </div>

            <!-- 金額 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">金額（円）</label>
                <input type="number" name="amount" id="edit_amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" min="0" placeholder="30000">
            </div>

            <!-- 利用日 -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">利用日</label>
                <input type="date" name="due_date" id="edit_due_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">
            </div>

            <!-- チェックボックス -->
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_split_payment_wrapper">
                    <input type="checkbox" name="is_split_payment" id="edit_is_split_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">分割2回払い</span>
                </label>
                <label class="flex items-center p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" id="edit_bonus_payment_wrapper">
                    <input type="checkbox" name="is_bonus_payment" id="edit_is_bonus_payment" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm font-medium text-gray-700">ボーナス払い</span>
                </label>
            </div>

            <!-- ボタン -->
            <div class="flex gap-2 pt-3">
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition text-sm">
                    キャンセル
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-medium transition shadow-md text-sm">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// 年の選択肢を動的に生成
(function() {
    const editYearSelect = document.getElementById('edit_year');
    if (editYearSelect) {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear - 3; year <= currentYear + 4; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            editYearSelect.appendChild(option);
        }
    }
})();

// 分割払いとボーナス払いを排他的にする
document.addEventListener('DOMContentLoaded', function() {
    const splitCheckbox = document.getElementById('edit_is_split_payment');
    const bonusCheckbox = document.getElementById('edit_is_bonus_payment');

    if (splitCheckbox && bonusCheckbox) {
        splitCheckbox.addEventListener('change', function() {
            if (this.checked) {
                bonusCheckbox.checked = false;
            }
        });

        bonusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                splitCheckbox.checked = false;
            }
        });
    }
});

function openEditModal(pk, yearMonth, cardType, description, amount, dueDate, purchaseDate, isSplitPayment, isBonusPayment) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');

    form.action = `/credit-estimates/${pk}/edit/`;

    // 年月を分割して設定
    const [year, month] = yearMonth.split('-');
    document.getElementById('edit_year').value = year;
    document.getElementById('edit_month').value = month;
    document.getElementById('edit_year_month_hidden').value = yearMonth;

    // カード種別を設定
    document.querySelectorAll('#editModal .card-type-radio').forEach(radio => {
        radio.checked = (radio.value === cardType);
        const label = radio.closest('.card-type-label');
        const box = label.querySelector('.card-type-box');
        const indicator = label.querySelector('.radio-indicator');
        const dot = label.querySelector('.radio-dot');

        if (radio.checked) {
            box.classList.add('border-blue-600', 'bg-blue-50');
            box.classList.remove('border-gray-300');
            indicator.classList.add('border-blue-600');
            indicator.classList.remove('border-gray-400');
            dot.classList.remove('hidden');
        } else {
            box.classList.remove('border-blue-600', 'bg-blue-50');
            box.classList.add('border-gray-300');
            indicator.classList.remove('border-blue-600');
            indicator.classList.add('border-gray-400');
            dot.classList.add('hidden');
        }
    });

    // その他のフィールドを設定
    document.getElementById('edit_description').value = description || '';
    document.getElementById('edit_amount').value = amount || '';

    // ボーナス払いの場合は購入日（利用日）を表示、それ以外は支払日を表示
    if (isBonusPayment && purchaseDate) {
        document.getElementById('edit_due_date').value = purchaseDate;
    } else {
        document.getElementById('edit_due_date').value = dueDate || '';
    }

    document.getElementById('edit_is_split_payment').checked = isSplitPayment;
    document.getElementById('edit_is_bonus_payment').checked = isBonusPayment;

    // カード種別に応じて分割払い・ボーナス払いの表示を更新
    togglePaymentOptions();

    modal.classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

function toggleDetails(id) {
    const element = document.getElementById(id);
    if (element) {
        element.classList.toggle('hidden');
    }
}

// 月次計画モーダルを開く
async function openPlanModal(planId, displayYearMonth, yearMonth) {
    const modal = document.getElementById('planModal');
    const form = document.getElementById('planForm');
    const title = document.getElementById('planModalTitle');

    form.action = `/plans/${planId}/edit/`;
    title.textContent = `${displayYearMonth} の編集`;
    document.getElementById('plan_year_month').value = yearMonth;

    // プランデータを取得
    try {
        const response = await fetch(`/plans/${planId}/data/`);
        const data = await response.json();

        // 収入フィールドを生成
        const incomeFields = document.getElementById('incomeFields');
        incomeFields.innerHTML = '';

        if (data.income_items && data.income_items.length > 0) {
            data.income_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}（円）</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-sm">
                `;
                incomeFields.appendChild(div);
            });
        }

        // 支出フィールドを生成
        const expenseFields = document.getElementById('expenseFields');
        expenseFields.innerHTML = '';

        if (data.expense_items && data.expense_items.length > 0) {
            data.expense_items.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">${item.label}（円）</label>
                    <input type="number" name="${item.key}" value="${item.value}" class="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition text-sm">
                `;
                expenseFields.appendChild(div);
            });
        }

        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading plan data:', error);
        showToast('データの読み込みに失敗しました', 'error');
    }
}

function closePlanModal() {
    document.getElementById('planModal').classList.add('hidden');
}

// 分割払い・ボーナス払いの表示制御
function togglePaymentOptions() {
    const editSplitWrapper = document.getElementById('edit_split_payment_wrapper');
    const editBonusWrapper = document.getElementById('edit_bonus_payment_wrapper');
    const editSplitCheckbox = document.getElementById('edit_is_split_payment');
    const editBonusCheckbox = document.getElementById('edit_is_bonus_payment');

    // 選択されているカード種別を取得
    const selectedRadio = document.querySelector('#editModal .card-type-radio:checked');
    const isViewCard = selectedRadio && selectedRadio.value === 'item_6';

    // 分割払いはVIEWカードの場合のみ表示
    if (editSplitWrapper) {
        editSplitWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editSplitCheckbox) {
            editSplitCheckbox.checked = false;
        }
    }

    // ボーナス払いはVIEWカードの場合のみ表示
    if (editBonusWrapper) {
        editBonusWrapper.style.display = isViewCard ? 'flex' : 'none';
        if (!isViewCard && editBonusCheckbox) {
            editBonusCheckbox.checked = false;
        }
    }
}

// カード種別のラジオボタン選択時のスタイル更新
document.querySelectorAll('#editModal .card-type-label').forEach(label => {
    label.addEventListener('click', function() {
        const radio = this.querySelector('.card-type-radio');
        radio.checked = true;

        // 全てのカード種別ボタンをリセット
        document.querySelectorAll('#editModal .card-type-label').forEach(otherLabel => {
            const otherBox = otherLabel.querySelector('.card-type-box');
            const otherIndicator = otherLabel.querySelector('.radio-indicator');
            const otherDot = otherLabel.querySelector('.radio-dot');

            otherBox.classList.remove('border-blue-600', 'bg-blue-50');
            otherBox.classList.add('border-gray-300');
            otherIndicator.classList.remove('border-blue-600');
            otherIndicator.classList.add('border-gray-400');
            otherDot.classList.add('hidden');
        });

        // 選択されたボタンをアクティブ化
        const box = this.querySelector('.card-type-box');
        const indicator = this.querySelector('.radio-indicator');
        const dot = this.querySelector('.radio-dot');

        box.classList.add('border-blue-600', 'bg-blue-50');
        box.classList.remove('border-gray-300');
        indicator.classList.add('border-blue-600');
        indicator.classList.remove('border-gray-400');
        dot.classList.remove('hidden');

        // カード種別変更時に分割払い・ボーナス払いの表示を更新
        togglePaymentOptions();
    });
});

// トースト通知を表示
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');
    const toastContainer = toast.querySelector('div');

    // アイコンとスタイルを設定
    if (type === 'success') {
        icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    } else if (type === 'error') {
        icon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        toastContainer.className = 'bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 max-w-md';
        messageEl.className = 'text-sm font-medium text-gray-800';
    }

    messageEl.textContent = message;
    toast.classList.remove('hidden');

    // 3秒後に非表示
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// 編集フォームの送信処理（AJAX）
const editForm = document.getElementById('editForm');
editForm.addEventListener('submit', function(e) {
    e.preventDefault(); // デフォルトのフォーム送信を防ぐ

    const formData = new FormData(editForm);

    // ボーナス払いの場合、due_date（利用日）をpurchase_date（購入日）としても送信
    const isBonusPayment = formData.get('is_bonus_payment');
    if (isBonusPayment) {
        const dueDate = formData.get('due_date');
        if (dueDate) {
            formData.append('purchase_date', dueDate);
        }
    }

    // AJAXで送信
    fetch(editForm.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message);
            closeEditModal();
            // ページをリロード
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            // バリデーションエラーを表示
            if (data.errors) {
                let errorMessages = [];
                for (let field in data.errors) {
                    if (data.errors[field]) {
                        errorMessages.push(data.errors[field].join(' '));
                    }
                }
                showToast(errorMessages.join('\n') || '更新に失敗しました。', 'error');
            } else {
                showToast('更新に失敗しました。入力内容を確認してください。', 'error');
            }
        }
    })
    .catch(error => {
        showToast('エラーが発生しました。', 'error');
        console.error('Error:', error);
    });
});

// 月次計画モーダルフォームの送信処理（AJAX）
const planForm = document.getElementById('planForm');
if (planForm) {
    planForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            return response.json().then(data => ({
                ok: response.ok,
                status: response.status,
                data: data
            }));
        })
        .then(result => {
            if (result.ok && result.data.status === 'success') {
                showToast(result.data.message);
                closePlanModal();
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                let errorMsg = '更新に失敗しました。';
                if (result.data.errors) {
                    const errorList = [];
                    for (const [field, errors] of Object.entries(result.data.errors)) {
                        errorList.push(...errors);
                    }
                    if (errorList.length > 0) {
                        errorMsg = errorList.join(', ');
                    }
                }
                showToast(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('エラーが発生しました。', 'error');
        });
    });
}

// Djangoのmessagesフレームワークからのメッセージをトーストで表示
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        showToast("{{ message|escapejs }}", "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}");
    {% endfor %}
});
</script>
{% endblock %}
