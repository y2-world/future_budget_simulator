{% extends 'budget_app/base.html' %}

{% block content %}
<div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 max-w-5xl mx-auto border-2 border-gray-100">
    <div class="mb-8 flex items-center gap-3">
        <div class="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">{{ title }}</h2>
    </div>

    <form method="post" id="planForm" >
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="mb-6 p-4 bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-300 text-red-700 rounded-xl shadow-md">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-semibold">{{ form.non_field_errors }}</span>
                </div>
            </div>
        {% endif %}

        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.year.label }}</label>
                {{ form.year }}
                {% if form.year.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.year.errors.0 }}</p>
                {% endif %}
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.month.label }}</label>
                {{ form.month }}
                {% if form.month.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.month.errors.0 }}</p>
                {% endif %}
            </div>
            {{ form.year_month }}
            {% if form.year_month.errors %}
                <p class="text-red-500 text-sm mt-1 col-span-2">{{ form.year_month.errors.0 }}</p>
            {% endif %}
        </div>

        <script>
            function toggleBonusField() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const bonusWrapper = document.getElementById('bonus-field-wrapper');

                if (!yearSelect || !monthSelect || !bonusWrapper) {
                    return;
                }

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);
                const bonusInput = bonusWrapper.querySelector('input');

                // ボーナスフィールドの表示ロジック:
                // 2025年2月以前: 2月と8月
                // 2025年3月以降: 6月と12月
                let isBonusMonth = false;
                if (selectedYear < 2025 || (selectedYear === 2025 && selectedMonth <= 2)) {
                    // 2025年2月以前
                    isBonusMonth = selectedMonth === 2 || selectedMonth === 8;
                } else {
                    // 2025年3月以降
                    isBonusMonth = selectedMonth === 6 || selectedMonth === 12;
                }

                if (isBonusMonth) {
                    bonusWrapper.style.display = 'block';
                    if (bonusInput) bonusInput.removeAttribute('required');
                } else {
                    bonusWrapper.style.display = 'none';
                    if (bonusInput) {
                        bonusInput.removeAttribute('required');
                        bonusInput.value = bonusInput.value || 0;
                    }
                }
            }

            function getLastDay(year, month) {
                return new Date(year, month, 0).getDate();
            }
            
            function updateLabels() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);

                if (!year || !month) return;

                const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                const monthName = monthNames[month];

                // 末日を計算
                const lastDay = getLastDay(year, month);

                // MonthlyPlanDefaultから動的にラベルを生成
                const defaultItems = {{ default_items_json|safe }};
                const labels = {};

                defaultItems.forEach(item => {
                    const key = item.key;
                    const title = item.title;
                    let day = '';

                    // 引き落とし日を計算
                    if (item.is_withdrawal_end_of_month) {
                        day = lastDay;
                    } else if (item.withdrawal_day) {
                        day = item.withdrawal_day;
                    }

                    // ラベルを生成
                    if (day) {
                        labels[key] = `${title}（${year}年${monthName}${day}日）`;
                    } else {
                        labels[key] = `${title}（${year}年${monthName}）`;
                    }
                });

                // 各フィールドのラベルを更新
                Object.keys(labels).forEach(fieldName => {
                    // ラッパー要素を取得
                    const wrapper = document.getElementById(`${fieldName}-field-wrapper`);
                    if (!wrapper) return;

                    const label = wrapper.querySelector('label');
                    if (label && labels[fieldName]) {
                        label.textContent = labels[fieldName];
                    }
                });
            }
            
            function updateYearMonth() {
                // 支出項目も動的にラベルを更新するため、ここで呼び出す
                // updateLabels();
                // ただし、現状では支出項目は固定なので、呼び出しは不要
                // もし支出項目も年月でラベルが変わるなら、このコメントを外す

                // view_card_bonus フィールドの表示/非表示を切り替える
                const monthSelectForBonus = document.querySelector('select[name="month"]');
                const viewCardBonusWrapper = document.getElementById('view_card_bonus-field-wrapper');

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const yearMonthInput = document.querySelector('input[name="year_month"]');

                if (yearSelect && monthSelect && yearMonthInput) {
                    const year = yearSelect.value;
                    const month = monthSelect.value.padStart(2, '0');
                    yearMonthInput.value = `${year}-${month}`;
                }

                if (viewCardBonusWrapper) {
                    const month = monthSelectForBonus ? monthSelectForBonus.value : null;
                    const shouldShow = month === '1' || month === '8';
                    const viewCardBonusInput = viewCardBonusWrapper.querySelector('input');

                    viewCardBonusWrapper.style.display = shouldShow ? 'block' : 'none';
                    if (viewCardBonusInput) {
                        viewCardBonusInput.removeAttribute('required');
                        if (!shouldShow) {
                            viewCardBonusInput.value = viewCardBonusInput.value || 0;
                        }
                    }
                }

            }


            function toggleBonusDetailFields() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const bonusGrossSalaryWrapper = document.getElementById('bonus_gross_salary-field-wrapper');
                const bonusDeductionsWrapper = document.getElementById('bonus_deductions-field-wrapper');

                if (!yearSelect || !monthSelect) {
                    return;
                }

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);

                // ボーナス明細フィールドの表示ロジック:
                // 2025年2月以前: 2月と8月
                // 2025年3月以降: 6月と12月
                let isBonusMonth = false;
                if (selectedYear < 2025 || (selectedYear === 2025 && selectedMonth <= 2)) {
                    // 2025年2月以前
                    isBonusMonth = selectedMonth === 2 || selectedMonth === 8;
                } else {
                    // 2025年3月以降
                    isBonusMonth = selectedMonth === 6 || selectedMonth === 12;
                }

                if (bonusGrossSalaryWrapper) {
                    bonusGrossSalaryWrapper.style.display = isBonusMonth ? 'block' : 'none';
                }
                if (bonusDeductionsWrapper) {
                    bonusDeductionsWrapper.style.display = isBonusMonth ? 'block' : 'none';
                }
            }


            function restrictMonthChoices() {
                {% if is_past_mode %}
                // 過去給与モード: 現在月より前の月のみ選択可能
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const selectedYear = parseInt(yearSelect.value);

                // 全ての月の選択肢
                const allMonths = [
                    {value: '01', label: '1月'}, {value: '02', label: '2月'},
                    {value: '03', label: '3月'}, {value: '04', label: '4月'},
                    {value: '05', label: '5月'}, {value: '06', label: '6月'},
                    {value: '07', label: '7月'}, {value: '08', label: '8月'},
                    {value: '09', label: '9月'}, {value: '10', label: '10月'},
                    {value: '11', label: '11月'}, {value: '12', label: '12月'}
                ];

                // 現在選択されている月を保存
                const currentSelectedMonth = monthSelect.value;

                // 月の選択肢をクリア
                monthSelect.innerHTML = '';

                // 選択可能な月を追加
                if (selectedYear < currentYear) {
                    // 過去の年: 全ての月を表示
                    allMonths.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month.value;
                        option.textContent = month.label;
                        monthSelect.appendChild(option);
                    });
                } else if (selectedYear === currentYear) {
                    // 今年: 先月までを表示
                    allMonths.forEach(month => {
                        if (parseInt(month.value) < currentMonth) {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.label;
                            monthSelect.appendChild(option);
                        }
                    });
                }

                // 以前の選択を復元（可能なら）
                if (monthSelect.querySelector(`option[value="${currentSelectedMonth}"]`)) {
                    monthSelect.value = currentSelectedMonth;
                } else if (monthSelect.options.length > 0) {
                    monthSelect.selectedIndex = monthSelect.options.length - 1; // 最後の月（最新の過去月）を選択
                }
                {% else %}
                // 月次計画モード: 今月以降で未登録の月のみ選択可能
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const selectedYear = parseInt(yearSelect.value);

                // 登録済みの年月リスト
                const registeredMonths = {{ registered_months_json|safe }};

                // 全ての月の選択肢
                const allMonths = [
                    {value: '01', label: '1月'}, {value: '02', label: '2月'},
                    {value: '03', label: '3月'}, {value: '04', label: '4月'},
                    {value: '05', label: '5月'}, {value: '06', label: '6月'},
                    {value: '07', label: '7月'}, {value: '08', label: '8月'},
                    {value: '09', label: '9月'}, {value: '10', label: '10月'},
                    {value: '11', label: '11月'}, {value: '12', label: '12月'}
                ];

                // 現在選択されている月を保存
                const currentSelectedMonth = monthSelect.value;

                // 月の選択肢をクリア
                monthSelect.innerHTML = '';

                // 選択可能な月を追加
                if (selectedYear > currentYear) {
                    // 未来の年: 未登録の月のみ表示
                    allMonths.forEach(month => {
                        const yearMonth = `${selectedYear}-${month.value}`;
                        if (!registeredMonths.includes(yearMonth)) {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.label;
                            monthSelect.appendChild(option);
                        }
                    });
                } else if (selectedYear === currentYear) {
                    // 今年: 今月以降で未登録の月のみ表示
                    allMonths.forEach(month => {
                        const monthNum = parseInt(month.value);
                        const yearMonth = `${selectedYear}-${month.value}`;
                        if (monthNum >= currentMonth && !registeredMonths.includes(yearMonth)) {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.label;
                            monthSelect.appendChild(option);
                        }
                    });
                }

                // 以前の選択を復元（可能なら）
                if (monthSelect.querySelector(`option[value="${currentSelectedMonth}"]`)) {
                    monthSelect.value = currentSelectedMonth;
                } else if (monthSelect.options.length > 0) {
                    monthSelect.selectedIndex = 0; // 最初の月を選択
                }
                {% endif %}
            }

            function toggleExcludeFields() {
                // 繰上げ返済チェックボックスのフィールドを全て制御
                // default_items_jsonからクレジットカード項目を動的に取得
                const defaultItems = {{ default_items_json|safe }};
                const excludeFields = [];

                defaultItems.forEach(item => {
                    if (item.is_credit_card) {
                        excludeFields.push(`exclude_${item.key}`);
                    }
                });

                excludeFields.forEach(fieldName => {
                    const wrapper = document.getElementById(`${fieldName}-field-wrapper`);
                    if (wrapper) {
                        {% if is_past_mode %}
                        // 過去給与モードでは表示
                        wrapper.style.display = 'block';
                        {% else %}
                        // 月次計画モードでは非表示（繰上げ返済チェックボックス）
                        wrapper.style.display = 'none';
                        {% endif %}
                    }
                });
            }

            // ページ読み込み時と年・月の選択変更時にラベルを更新
            document.addEventListener('DOMContentLoaded', function() {
                toggleExcludeFields(); // 初回ロード時に繰上げ返済チェックボックスの表示を制御

                restrictMonthChoices(); // 月の選択肢を制限
                updateLabels();
                updateYearMonth();
                toggleBonusField(); // ページ読み込み時にボーナス表示を更新
                toggleBonusDetailFields(); // ページ読み込み時にボーナス明細フィールド表示を更新

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (yearSelect) {
                    yearSelect.addEventListener('change', function() {
                        restrictMonthChoices(); // 年が変更されたら月の選択肢を更新
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // 年変更時にもボーナス表示を更新
                        toggleBonusDetailFields(); // 年変更時にボーナス明細フィールド表示を更新
                    });
                }

                if (monthSelect) {
                    monthSelect.addEventListener('change', function() {
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // 月変更時にボーナス表示を更新
                        toggleBonusDetailFields(); // 月変更時にボーナス明細フィールド表示を更新
                    });
                }

                // フォーム送信前にyear_monthを更新
                const form = document.getElementById('planForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        updateYearMonth();
                    });
                }
            });
        </script>

        <div class="grid grid-cols-1 {% if not is_past_mode %}lg:grid-cols-2{% endif %} gap-6">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 md:p-7 rounded-2xl shadow-lg border-2 border-green-100">
                <div class="mb-6 flex items-center gap-3">
                    <div class="p-2.5 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="font-bold text-xl text-green-800">収入</h3>
                </div>

                <!-- 給与 -->
                {% for field in form %}
                    {% if field.name == 'salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- 総支給額 -->
                {% for field in form %}
                    {% if field.name == 'gross_salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- 控除額 -->
                {% for field in form %}
                    {% if field.name == 'deductions' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- 交通費 -->
                {% for field in form %}
                    {% if field.name == 'transportation' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ボーナス（6月、12月、2025年2月） -->
                {% for field in form %}
                    {% if field.name == 'bonus' %}
                        <div class="mb-4" id="bonus-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ボーナス総支給額（6月、12月、2025年2月） -->
                {% for field in form %}
                    {% if field.name == 'bonus_gross_salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ボーナス控除額（6月、12月、2025年2月） -->
                {% for field in form %}
                    {% if field.name == 'bonus_deductions' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- 支出セクション -->
            {% if not is_past_mode %}
            <div class="bg-gradient-to-br from-red-50 to-pink-50 p-6 md:p-7 rounded-2xl shadow-lg border-2 border-red-100">
                <div class="mb-6 flex items-center gap-3">
                    <div class="p-2.5 bg-gradient-to-br from-red-500 to-pink-600 rounded-lg shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                    <h3 class="font-bold text-xl text-red-800">支出</h3>
                </div>

                <!-- 動的に生成された支出項目 -->
                {% for field in form %}
                    {% if field.name not in 'year,month,year_month,salary,gross_salary,transportation,deductions,bonus,bonus_gross_salary,bonus_deductions' %}
                        {% if 'exclude_' not in field.name or field.name|slice:':8' != 'exclude_' %}
                            <div class="mb-4" id="{{ field.name }}-field-wrapper">
                                <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <!-- 繰上げ返済チェックボックス（過去給与モードのみ） -->
                {% for field in form %}
                    {% if field.name|slice:':8' == 'exclude_' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper" style="display: none;">
                            <label class="inline-flex items-center text-gray-700 font-semibold text-sm">
                                {{ field }}
                                <span class="ml-2">{{ field.label }}</span>
                            </label>
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-4 p-6 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border-2 border-gray-200">
            <button type="submit" class="flex-1 inline-flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3.5 rounded-xl hover:from-blue-600 hover:to-blue-700 font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                保存
            </button>
            <a href="{% if is_past_mode %}{% url 'budget_app:salary_list' %}{% else %}{% url 'budget_app:plan_list' %}{% endif %}" class="flex-1 inline-flex items-center justify-center gap-2 bg-white text-gray-700 px-6 py-3.5 rounded-xl hover:bg-gray-50 font-bold border-2 border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                キャンセル
            </a>
        </div>
    </form>
</div>

{% endblock %}
