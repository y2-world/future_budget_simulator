{% extends 'budget_app/base.html' %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-4 md:p-6 max-w-4xl mx-auto">
    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">{{ title }}</h2>

    <form method="post" id="planForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.year.label }}</label>
                {{ form.year }}
                {% if form.year.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.year.errors.0 }}</p>
                {% endif %}
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.month.label }}</label>
                {{ form.month }}
                {% if form.month.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.month.errors.0 }}</p>
                {% endif %}
            </div>
            {{ form.year_month }}
            {% if form.year_month.errors %}
                <p class="text-red-500 text-sm mt-1 col-span-2">{{ form.year_month.errors.0 }}</p>
            {% endif %}
        </div>

        <script>
            function toggleBonusField() {
                const monthSelect = document.querySelector('select[name="month"]');
                const bonusWrapper = document.getElementById('bonus-field-wrapper');

                if (!monthSelect || !bonusWrapper) {
                    return;
                }

                const selectedMonth = parseInt(monthSelect.value);
                const bonusInput = bonusWrapper.querySelector('input');

                if (selectedMonth === 6 || selectedMonth === 12) {
                    bonusWrapper.style.display = 'block';
                    if (bonusInput) bonusInput.removeAttribute('required');
                } else {
                    bonusWrapper.style.display = 'none';
                    if (bonusInput) {
                        bonusInput.removeAttribute('required');
                        bonusInput.value = bonusInput.value || 0;
                    }
                }
            }

            function toggleLakeField() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const lakeWrapper = document.getElementById('lake-field-wrapper');

                if (!yearSelect || !monthSelect || !lakeWrapper) {
                    return;
                }

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);
                const lakeInput = lakeWrapper.querySelector('input');

                // 2026å¹´6æœˆä»¥é™ã¯éè¡¨ç¤º
                if (selectedYear > 2026 || (selectedYear === 2026 && selectedMonth > 5)) {
                    lakeWrapper.style.display = 'none';
                    // éè¡¨ç¤ºã®å ´åˆã¯å€¤ã‚’0ã«ã‚¯ãƒªã‚¢ã—ã€requiredã‚’å‰Šé™¤
                    if (lakeInput) {
                        lakeInput.value = 0;
                        lakeInput.removeAttribute('required');
                    }
                } else {
                    lakeWrapper.style.display = 'block';
                    if (lakeInput) lakeInput.removeAttribute('required');
                }
            }

            function getLastDay(year, month) {
                return new Date(year, month, 0).getDate();
            }
            
            function updateLabels() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);

                if (!year || !month) return;

                const monthNames = ['', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                const monthName = monthNames[month];

                // å‰æœˆã‚’è¨ˆç®—
                let prevYear = year;
                let prevMonth = month - 1;
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear = year - 1;
                }
                const prevMonthName = monthNames[prevMonth];

                // æœ«æ—¥ã‚’è¨ˆç®—
                const lastDay = getLastDay(year, month);

                // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                const labels = {
                    'bonus': `ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ${year}å¹´${monthName}ï¼‰`,
                    'salary': `çµ¦ä¸ï¼ˆ${year}å¹´${monthName}25æ—¥ï¼‰`,
                    'food': `é£Ÿè²»ï¼ˆ${year}å¹´${monthName}1æ—¥ï¼‰`,
                    'rent': `å®¶è³ƒï¼ˆ${year}å¹´${monthName}27æ—¥ï¼‰`,
                    'lake': `ãƒ¬ã‚¤ã‚¯è¿”æ¸ˆï¼ˆ${year}å¹´${monthName}27æ—¥ï¼‰`,
                    'view_card': `VIEWã‚«ãƒ¼ãƒ‰ï¼ˆ${year}å¹´${monthName}4æ—¥ï¼‰`,
                    'rakuten_card': `æ¥½å¤©ã‚«ãƒ¼ãƒ‰ï¼ˆ${year}å¹´${monthName}27æ—¥ï¼‰`,
                    'paypay_card': `PayPayã‚«ãƒ¼ãƒ‰ï¼ˆ${year}å¹´${monthName}27æ—¥ï¼‰`,
                    'vermillion_card': `VERMILLION CARDï¼ˆ${year}å¹´${monthName}4æ—¥ï¼‰`,
                    'amazon_card': `Amazonã‚«ãƒ¼ãƒ‰ï¼ˆ${year}å¹´${monthName}26æ—¥ï¼‰`,
                    'olive_card': `Oliveï¼ˆ${year}å¹´${monthName}26æ—¥ï¼‰`,
                    'loan': `ãƒãƒãƒ¼ã‚¢ã‚·ã‚¹ãƒˆè¿”æ¸ˆï¼ˆ${year}å¹´${monthName}${lastDay}æ—¥ï¼‰`
                };

                // 1æœˆã¨8æœˆã®å ´åˆã€ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã‚‚æ›´æ–°
                if (month === 1 || month === 8) {
                    labels['view_card_bonus'] = `VIEWãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ï¼ˆ${year}å¹´${monthName}4æ—¥ï¼‰`;
                }

                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                Object.keys(labels).forEach(fieldName => {
                    // ãƒ©ãƒƒãƒ‘ãƒ¼è¦ç´ ã‚’å–å¾—
                    const wrapper = document.getElementById(`${fieldName}-field-wrapper`);
                    if (!wrapper) return;

                    const label = wrapper.querySelector('label');
                    if (label && labels[fieldName]) {
                        label.textContent = labels[fieldName];
                    }
                });
            }
            
            function updateYearMonth() {
                // æ”¯å‡ºé …ç›®ã‚‚å‹•çš„ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ã“ã“ã§å‘¼ã³å‡ºã™
                // updateLabels();
                // ãŸã ã—ã€ç¾çŠ¶ã§ã¯æ”¯å‡ºé …ç›®ã¯å›ºå®šãªã®ã§ã€å‘¼ã³å‡ºã—ã¯ä¸è¦
                // ã‚‚ã—æ”¯å‡ºé …ç›®ã‚‚å¹´æœˆã§ãƒ©ãƒ™ãƒ«ãŒå¤‰ã‚ã‚‹ãªã‚‰ã€ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™

                // view_card_bonus ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                const monthSelectForBonus = document.querySelector('select[name="month"]');
                const viewCardBonusWrapper = document.getElementById('view_card_bonus-field-wrapper');

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const yearMonthInput = document.querySelector('input[name="year_month"]');

                if (yearSelect && monthSelect && yearMonthInput) {
                    const year = yearSelect.value;
                    const month = monthSelect.value.padStart(2, '0');
                    yearMonthInput.value = `${year}-${month}`;
                }

                if (viewCardBonusWrapper) {
                    const month = monthSelectForBonus ? monthSelectForBonus.value : null;
                    const shouldShow = month === '1' || month === '8';
                    const viewCardBonusInput = viewCardBonusWrapper.querySelector('input');

                    viewCardBonusWrapper.style.display = shouldShow ? 'block' : 'none';
                    if (viewCardBonusInput) {
                        viewCardBonusInput.removeAttribute('required');
                        if (!shouldShow) {
                            viewCardBonusInput.value = viewCardBonusInput.value || 0;
                        }
                    }
                }

            }

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨å¹´ãƒ»æœˆã®é¸æŠå¤‰æ›´æ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
            document.addEventListener('DOMContentLoaded', function() {
                updateLabels();
                updateYearMonth();
                toggleBonusField(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                toggleLakeField(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¬ã‚¤ã‚¯è¿”æ¸ˆè¡¨ç¤ºã‚’æ›´æ–°

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (yearSelect) {
                    yearSelect.addEventListener('change', function() {
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // å¹´å¤‰æ›´æ™‚ã«ã‚‚ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                        toggleLakeField(); // å¹´å¤‰æ›´æ™‚ã«ãƒ¬ã‚¤ã‚¯è¿”æ¸ˆè¡¨ç¤ºã‚’æ›´æ–°
                    });
                }

                if (monthSelect) {
                    monthSelect.addEventListener('change', function() {
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // æœˆå¤‰æ›´æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                        toggleLakeField(); // æœˆå¤‰æ›´æ™‚ã«ãƒ¬ã‚¤ã‚¯è¿”æ¸ˆè¡¨ç¤ºã‚’æ›´æ–°
                    });
                }

                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«year_monthã‚’æ›´æ–°
                const form = document.getElementById('planForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        updateYearMonth();
                    });
                }
            });
        </script>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 md:p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-lg md:text-xl mb-4 text-green-800 flex items-center">
                    <span class="mr-2">ğŸ’°</span>åå…¥
                </h3>
                {% for field in form %}
                    {% if field.name == 'salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% elif field.name == 'bonus' %}
                        <div class="mb-4" id="bonus-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% elif field.name == 'gross_salary' or field.name == 'deductions' or field.name == 'transportation' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="bg-gradient-to-br from-red-50 to-pink-50 p-4 md:p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-lg md:text-xl mb-4 text-red-800 flex items-center">
                    <span class="mr-2">ğŸ’³</span>æ”¯å‡º
                </h3>
                {% for field in form %}
                    {% if field.name != 'year_month' and field.name != 'salary' and field.name != 'bonus' and field.name != 'year' and field.name != 'month' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg hover:from-blue-600 hover:to-blue-700 font-bold shadow-md transition transform hover:scale-[1.02]">
                ä¿å­˜
            </button>
            <a href="{% url 'budget_app:plan_list' %}" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white p-3 rounded-lg hover:from-gray-600 hover:to-gray-700 font-bold text-center shadow-md transition transform hover:scale-[1.02]">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </a>
        </div>
    </form>
</div>
{% endblock %}
