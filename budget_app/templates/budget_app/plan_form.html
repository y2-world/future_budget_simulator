{% extends 'budget_app/base.html' %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-4 md:p-6 max-w-4xl mx-auto">
    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">{{ title }}</h2>

    <form method="post" id="planForm" >
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.year.label }}</label>
                {{ form.year }}
                {% if form.year.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.year.errors.0 }}</p>
                {% endif %}
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">{{ form.month.label }}</label>
                {{ form.month }}
                {% if form.month.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.month.errors.0 }}</p>
                {% endif %}
            </div>
            {{ form.year_month }}
            {% if form.year_month.errors %}
                <p class="text-red-500 text-sm mt-1 col-span-2">{{ form.year_month.errors.0 }}</p>
            {% endif %}
        </div>

        <script>
            function toggleBonusField() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const bonusWrapper = document.getElementById('bonus-field-wrapper');

                if (!yearSelect || !monthSelect || !bonusWrapper) {
                    return;
                }

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);
                const bonusInput = bonusWrapper.querySelector('input');

                // ãƒœãƒ¼ãƒŠã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯:
                // 2025å¹´2æœˆä»¥å‰: 2æœˆã¨8æœˆ
                // 2025å¹´3æœˆä»¥é™: 6æœˆã¨12æœˆ
                let isBonusMonth = false;
                if (selectedYear < 2025 || (selectedYear === 2025 && selectedMonth <= 2)) {
                    // 2025å¹´2æœˆä»¥å‰
                    isBonusMonth = selectedMonth === 2 || selectedMonth === 8;
                } else {
                    // 2025å¹´3æœˆä»¥é™
                    isBonusMonth = selectedMonth === 6 || selectedMonth === 12;
                }

                if (isBonusMonth) {
                    bonusWrapper.style.display = 'block';
                    if (bonusInput) bonusInput.removeAttribute('required');
                } else {
                    bonusWrapper.style.display = 'none';
                    if (bonusInput) {
                        bonusInput.removeAttribute('required');
                        bonusInput.value = bonusInput.value || 0;
                    }
                }
            }

            function getLastDay(year, month) {
                return new Date(year, month, 0).getDate();
            }
            
            function updateLabels() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);

                if (!year || !month) return;

                const monthNames = ['', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                const monthName = monthNames[month];

                // æœ«æ—¥ã‚’è¨ˆç®—
                const lastDay = getLastDay(year, month);

                // MonthlyPlanDefaultã‹ã‚‰å‹•çš„ã«ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
                const defaultItems = {{ default_items_json|safe }};
                const labels = {};

                defaultItems.forEach(item => {
                    const key = item.key;
                    const title = item.title;
                    let day = '';

                    // å¼•ãè½ã¨ã—æ—¥ã‚’è¨ˆç®—
                    if (item.is_withdrawal_end_of_month) {
                        day = lastDay;
                    } else if (item.withdrawal_day) {
                        day = item.withdrawal_day;
                    }

                    // ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
                    if (day) {
                        labels[key] = `${title}ï¼ˆ${year}å¹´${monthName}${day}æ—¥ï¼‰`;
                    } else {
                        labels[key] = `${title}ï¼ˆ${year}å¹´${monthName}ï¼‰`;
                    }
                });

                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                Object.keys(labels).forEach(fieldName => {
                    // ãƒ©ãƒƒãƒ‘ãƒ¼è¦ç´ ã‚’å–å¾—
                    const wrapper = document.getElementById(`${fieldName}-field-wrapper`);
                    if (!wrapper) return;

                    const label = wrapper.querySelector('label');
                    if (label && labels[fieldName]) {
                        label.textContent = labels[fieldName];
                    }
                });
            }
            
            function updateYearMonth() {
                // æ”¯å‡ºé …ç›®ã‚‚å‹•çš„ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ã“ã“ã§å‘¼ã³å‡ºã™
                // updateLabels();
                // ãŸã ã—ã€ç¾çŠ¶ã§ã¯æ”¯å‡ºé …ç›®ã¯å›ºå®šãªã®ã§ã€å‘¼ã³å‡ºã—ã¯ä¸è¦
                // ã‚‚ã—æ”¯å‡ºé …ç›®ã‚‚å¹´æœˆã§ãƒ©ãƒ™ãƒ«ãŒå¤‰ã‚ã‚‹ãªã‚‰ã€ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™

                // view_card_bonus ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                const monthSelectForBonus = document.querySelector('select[name="month"]');
                const viewCardBonusWrapper = document.getElementById('view_card_bonus-field-wrapper');

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const yearMonthInput = document.querySelector('input[name="year_month"]');

                if (yearSelect && monthSelect && yearMonthInput) {
                    const year = yearSelect.value;
                    const month = monthSelect.value.padStart(2, '0');
                    yearMonthInput.value = `${year}-${month}`;
                }

                if (viewCardBonusWrapper) {
                    const month = monthSelectForBonus ? monthSelectForBonus.value : null;
                    const shouldShow = month === '1' || month === '8';
                    const viewCardBonusInput = viewCardBonusWrapper.querySelector('input');

                    viewCardBonusWrapper.style.display = shouldShow ? 'block' : 'none';
                    if (viewCardBonusInput) {
                        viewCardBonusInput.removeAttribute('required');
                        if (!shouldShow) {
                            viewCardBonusInput.value = viewCardBonusInput.value || 0;
                        }
                    }
                }

            }


            function toggleBonusDetailFields() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');
                const bonusGrossSalaryWrapper = document.getElementById('bonus_gross_salary-field-wrapper');
                const bonusDeductionsWrapper = document.getElementById('bonus_deductions-field-wrapper');

                if (!yearSelect || !monthSelect) {
                    return;
                }

                const selectedYear = parseInt(yearSelect.value);
                const selectedMonth = parseInt(monthSelect.value);

                // ãƒœãƒ¼ãƒŠã‚¹æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯:
                // 2025å¹´2æœˆä»¥å‰: 2æœˆã¨8æœˆ
                // 2025å¹´3æœˆä»¥é™: 6æœˆã¨12æœˆ
                let isBonusMonth = false;
                if (selectedYear < 2025 || (selectedYear === 2025 && selectedMonth <= 2)) {
                    // 2025å¹´2æœˆä»¥å‰
                    isBonusMonth = selectedMonth === 2 || selectedMonth === 8;
                } else {
                    // 2025å¹´3æœˆä»¥é™
                    isBonusMonth = selectedMonth === 6 || selectedMonth === 12;
                }

                if (bonusGrossSalaryWrapper) {
                    bonusGrossSalaryWrapper.style.display = isBonusMonth ? 'block' : 'none';
                }
                if (bonusDeductionsWrapper) {
                    bonusDeductionsWrapper.style.display = isBonusMonth ? 'block' : 'none';
                }
            }


            // å¹´æœˆã«åŸºã¥ã„ã¦æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            async function loadPlanData() {
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) {
                    return;
                }

                const year = yearSelect.value;
                const month = monthSelect.value;

                if (!year || !month) {
                    return;
                }

                try {
                    const response = await fetch(`/api/plans/get-by-month/?year=${year}&month=${month}`);
                    if (!response.ok) {
                        console.error('Failed to load plan data');
                        return;
                    }

                    const data = await response.json();

                    // ãƒ•ã‚©ãƒ¼ãƒ ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
                    // default_items_jsonã‹ã‚‰å‹•çš„ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å–å¾—
                    const defaultItems = {{ default_items_json|safe }};
                    const fields = [
                        'gross_salary', 'transportation', 'deductions',
                        'bonus_gross_salary', 'bonus_deductions'
                    ];

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã®keyã‚’è¿½åŠ 
                    defaultItems.forEach(item => {
                        fields.push(item.key);
                    });

                    fields.forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input && data.hasOwnProperty(field)) {
                            // æ–°è¦ä½œæˆæ™‚ï¼ˆexists === falseï¼‰ã§otherãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯7700ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã™ã‚‹
                            if (field === 'other' && !data.exists && (data[field] === 0 || data[field] === null)) {
                                input.value = 7700;
                            } else {
                                input.value = data[field] || 0;
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading plan data:', error);
                }
            }

            function restrictMonthChoices() {
                {% if is_past_mode %}
                // éå»çµ¦ä¸ãƒ¢ãƒ¼ãƒ‰: ç¾åœ¨æœˆã‚ˆã‚Šå‰ã®æœˆã®ã¿é¸æŠå¯èƒ½
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const selectedYear = parseInt(yearSelect.value);

                // å…¨ã¦ã®æœˆã®é¸æŠè‚¢
                const allMonths = [
                    {value: '01', label: '1æœˆ'}, {value: '02', label: '2æœˆ'},
                    {value: '03', label: '3æœˆ'}, {value: '04', label: '4æœˆ'},
                    {value: '05', label: '5æœˆ'}, {value: '06', label: '6æœˆ'},
                    {value: '07', label: '7æœˆ'}, {value: '08', label: '8æœˆ'},
                    {value: '09', label: '9æœˆ'}, {value: '10', label: '10æœˆ'},
                    {value: '11', label: '11æœˆ'}, {value: '12', label: '12æœˆ'}
                ];

                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æœˆã‚’ä¿å­˜
                const currentSelectedMonth = monthSelect.value;

                // æœˆã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                monthSelect.innerHTML = '';

                // é¸æŠå¯èƒ½ãªæœˆã‚’è¿½åŠ 
                if (selectedYear < currentYear) {
                    // éå»ã®å¹´: å…¨ã¦ã®æœˆã‚’è¡¨ç¤º
                    allMonths.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month.value;
                        option.textContent = month.label;
                        monthSelect.appendChild(option);
                    });
                } else if (selectedYear === currentYear) {
                    // ä»Šå¹´: å…ˆæœˆã¾ã§ã‚’è¡¨ç¤º
                    allMonths.forEach(month => {
                        if (parseInt(month.value) < currentMonth) {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.label;
                            monthSelect.appendChild(option);
                        }
                    });
                }

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒï¼ˆå¯èƒ½ãªã‚‰ï¼‰
                if (monthSelect.querySelector(`option[value="${currentSelectedMonth}"]`)) {
                    monthSelect.value = currentSelectedMonth;
                } else if (monthSelect.options.length > 0) {
                    monthSelect.selectedIndex = monthSelect.options.length - 1; // æœ€å¾Œã®æœˆï¼ˆæœ€æ–°ã®éå»æœˆï¼‰ã‚’é¸æŠ
                }
                {% else %}
                // æœˆæ¬¡è¨ˆç”»ãƒ¢ãƒ¼ãƒ‰: ä»Šæœˆä»¥é™ã®æœˆã®ã¿é¸æŠå¯èƒ½
                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (!yearSelect || !monthSelect) return;

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const selectedYear = parseInt(yearSelect.value);

                // å…¨ã¦ã®æœˆã®é¸æŠè‚¢
                const allMonths = [
                    {value: '01', label: '1æœˆ'}, {value: '02', label: '2æœˆ'},
                    {value: '03', label: '3æœˆ'}, {value: '04', label: '4æœˆ'},
                    {value: '05', label: '5æœˆ'}, {value: '06', label: '6æœˆ'},
                    {value: '07', label: '7æœˆ'}, {value: '08', label: '8æœˆ'},
                    {value: '09', label: '9æœˆ'}, {value: '10', label: '10æœˆ'},
                    {value: '11', label: '11æœˆ'}, {value: '12', label: '12æœˆ'}
                ];

                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æœˆã‚’ä¿å­˜
                const currentSelectedMonth = monthSelect.value;

                // æœˆã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                monthSelect.innerHTML = '';

                // é¸æŠå¯èƒ½ãªæœˆã‚’è¿½åŠ 
                if (selectedYear > currentYear) {
                    // æœªæ¥ã®å¹´: å…¨ã¦ã®æœˆã‚’è¡¨ç¤º
                    allMonths.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month.value;
                        option.textContent = month.label;
                        monthSelect.appendChild(option);
                    });
                } else if (selectedYear === currentYear) {
                    // ä»Šå¹´: ä»Šæœˆä»¥é™ã‚’è¡¨ç¤º
                    allMonths.forEach(month => {
                        if (parseInt(month.value) >= currentMonth) {
                            const option = document.createElement('option');
                            option.value = month.value;
                            option.textContent = month.label;
                            monthSelect.appendChild(option);
                        }
                    });
                }

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒï¼ˆå¯èƒ½ãªã‚‰ï¼‰
                if (monthSelect.querySelector(`option[value="${currentSelectedMonth}"]`)) {
                    monthSelect.value = currentSelectedMonth;
                } else if (monthSelect.options.length > 0) {
                    monthSelect.selectedIndex = 0; // æœ€åˆã®æœˆã‚’é¸æŠ
                }
                {% endif %}
            }

            function toggleExcludeFields() {
                // ç¹°ä¸Šã’è¿”æ¸ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¨ã¦åˆ¶å¾¡
                // default_items_jsonã‹ã‚‰ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é …ç›®ã‚’å‹•çš„ã«å–å¾—
                const defaultItems = {{ default_items_json|safe }};
                const excludeFields = [];

                defaultItems.forEach(item => {
                    if (item.is_credit_card) {
                        excludeFields.push(`exclude_${item.key}`);
                    }
                });

                excludeFields.forEach(fieldName => {
                    const wrapper = document.getElementById(`${fieldName}-field-wrapper`);
                    if (wrapper) {
                        {% if is_past_mode %}
                        // éå»çµ¦ä¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯è¡¨ç¤º
                        wrapper.style.display = 'block';
                        {% else %}
                        // æœˆæ¬¡è¨ˆç”»ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼ˆç¹°ä¸Šã’è¿”æ¸ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
                        wrapper.style.display = 'none';
                        {% endif %}
                    }
                });
            }

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨å¹´ãƒ»æœˆã®é¸æŠå¤‰æ›´æ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
            document.addEventListener('DOMContentLoaded', function() {
                toggleExcludeFields(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ç¹°ä¸Šã’è¿”æ¸ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’åˆ¶å¾¡

                restrictMonthChoices(); // æœˆã®é¸æŠè‚¢ã‚’åˆ¶é™
                updateLabels();
                updateYearMonth();
                toggleBonusField(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                toggleBonusDetailFields(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                loadPlanData(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ãƒ»ç¢ºèª

                const yearSelect = document.querySelector('select[name="year"]');
                const monthSelect = document.querySelector('select[name="month"]');

                if (yearSelect) {
                    yearSelect.addEventListener('change', function() {
                        restrictMonthChoices(); // å¹´ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æœˆã®é¸æŠè‚¢ã‚’æ›´æ–°
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // å¹´å¤‰æ›´æ™‚ã«ã‚‚ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                        toggleBonusDetailFields(); // å¹´å¤‰æ›´æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                        loadPlanData(); // å¹´å¤‰æ›´æ™‚ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    });
                }

                if (monthSelect) {
                    monthSelect.addEventListener('change', function() {
                        updateLabels();
                        updateYearMonth();
                        toggleBonusField(); // æœˆå¤‰æ›´æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                        toggleBonusDetailFields(); // æœˆå¤‰æ›´æ™‚ã«ãƒœãƒ¼ãƒŠã‚¹æ˜ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                        loadPlanData(); // æœˆå¤‰æ›´æ™‚ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    });
                }

                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«year_monthã‚’æ›´æ–°ã—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ç¢ºèª
                const form = document.getElementById('planForm');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault(); // ä¸€æ—¦é€ä¿¡ã‚’æ­¢ã‚ã‚‹
                        updateYearMonth();

                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const year = yearSelect.value;
                        const month = monthSelect.value;

                        try {
                            const response = await fetch(`/api/plans/get-by-month/?year=${year}&month=${month}`);
                            if (response.ok) {
                                const data = await response.json();

                                if (data.exists) {
                                    const monthName = ('0' + month).slice(-2);
                                    const confirmed = confirm(`${year}å¹´${monthName}æœˆã®æœˆæ¬¡è¨ˆç”»ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚\n\nç™»éŒ²ã‚’ç¶šã‘ã‚‹ã¨æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹?`);

                                    if (!confirmed) {
                                        return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰é€ä¿¡ã—ãªã„
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error checking existing plan:', error);
                        }

                        // ç¢ºèªOKã¾ãŸã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯é€ä¿¡
                        form.submit();
                    });
                }
            });
        </script>

        <div class="grid grid-cols-1 {% if not is_past_mode %}lg:grid-cols-2{% endif %} gap-6">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 md:p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-lg md:text-xl mb-4 text-green-800 flex items-center">
                    <span class="mr-2">ğŸ’°</span>åå…¥
                </h3>

                <!-- çµ¦ä¸ -->
                {% for field in form %}
                    {% if field.name == 'salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ç·æ”¯çµ¦é¡ -->
                {% for field in form %}
                    {% if field.name == 'gross_salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- æ§é™¤é¡ -->
                {% for field in form %}
                    {% if field.name == 'deductions' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- äº¤é€šè²» -->
                {% for field in form %}
                    {% if field.name == 'transportation' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ6æœˆã€12æœˆã€2025å¹´2æœˆï¼‰ -->
                {% for field in form %}
                    {% if field.name == 'bonus' %}
                        <div class="mb-4" id="bonus-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ãƒœãƒ¼ãƒŠã‚¹ç·æ”¯çµ¦é¡ï¼ˆ6æœˆã€12æœˆã€2025å¹´2æœˆï¼‰ -->
                {% for field in form %}
                    {% if field.name == 'bonus_gross_salary' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- ãƒœãƒ¼ãƒŠã‚¹æ§é™¤é¡ï¼ˆ6æœˆã€12æœˆã€2025å¹´2æœˆï¼‰ -->
                {% for field in form %}
                    {% if field.name == 'bonus_deductions' %}
                        <div class="mb-4" id="{{ field.name }}-field-wrapper" style="display: none;">
                            <label class="block text-gray-700 font-semibold mb-2 text-sm" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <button type="submit" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg hover:from-blue-600 hover:to-blue-700 font-bold shadow-md transition transform hover:scale-[1.02]">
                ä¿å­˜
            </button>
            <a href="{% if is_past_mode %}{% url 'budget_app:salary_list' %}{% else %}{% url 'budget_app:plan_list' %}{% endif %}" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white p-3 rounded-lg hover:from-gray-600 hover:to-gray-700 font-bold text-center shadow-md transition transform hover:scale-[1.02]">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </a>
        </div>
    </form>
</div>
{% endblock %}
