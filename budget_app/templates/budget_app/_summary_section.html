{% load humanize budget_filters %}

{% if summary_data %}
    <div class="space-y-6">
        {% for ym, cards in summary_data.items %}
            <div class="border rounded">
            <div class="bg-gray-100 px-4 py-2 font-semibold flex justify-between items-center cursor-pointer hover:bg-gray-200 transition" data-toggle-estimate="{{ ym }}">
                <div class="flex items-center gap-2">
                    <svg id="collapse-icon-{{ ym }}" class="w-5 h-5 transition-transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                    <span>{{ ym|format_year_month }}</span>
                </div>
                <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline" onclick="event.stopPropagation()">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reflect">
                    <input type="hidden" name="year_month" value="{{ ym }}">
                    <input type="hidden" name="reflect_type" value="normal">
                </form>
            </div>
            <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤ºï¼šãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div id="estimate-content-{{ ym }}" class="hidden md:block p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-3 py-2 text-left w-28">åˆ©ç”¨æ—¥</th>
                            <th class="px-3 py-2 text-left">å†…å®¹</th>
                            <th class="px-3 py-2 text-right w-32">é‡‘é¡</th>
                            <th class="px-3 py-2 text-center w-32">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for card_type, data in cards.items %}
                            <tr class="bg-blue-50 font-semibold">
                                <td class="px-3 py-2 font-bold whitespace-wrap" colspan="2">{{ data.label }}</td>
                                <td class="px-3 py-2 text-right whitespace-wrap">{{ data.total|yen }}</td>
                                <td class="px-3 py-2 text-center">
                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline reflect-card-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="reflect_card">
                                        <input type="hidden" name="year_month" value="{% if '_bonus' in ym %}{{ ym|slice:':-6' }}{% else %}{{ ym }}{% endif %}">
                                        <input type="hidden" name="card_type" value="{{ card_type }}">
                                        <button type="submit" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600">åæ˜ </button>
                                    </form>
                                </td>
                            </tr>
                            {% for item in data.entries %}
                            <tr class="border-b {% if item.is_default %}bg-gray-50{% endif %}">
                                <td class="px-3 py-2">
                                    {% if item.is_bonus_payment and item.purchase_date %}
                                        {# ãƒœãƒ¼ãƒŠã‚¹æ‰•ã„ã¯åˆ©ç”¨æ—¥ï¼ˆåˆ©ç”¨æ—¥ï¼‰ã‚’è¡¨ç¤º #}
                                        {{ item.purchase_date|date:'Y/m/d' }}
                                    {% elif item.due_date %}
                                        {{ item.due_date|date:'Y/m/d' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2">
                                    {% if item.description %}
                                        {{ item.description }}
                                    {% else %}
                                        -
                                    {% endif %}
                                    {% if item.is_default %}
                                        <span class="text-xs text-gray-400 ml-1">(å®šæœŸ)</span>
                                    {% endif %}
                                    {% if item.split_payment_part %}
                                        <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded ml-1">åˆ†å‰²æ‰•ã„</span>
                                        {% if item.split_payment_part == 1 %}
                                            <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded ml-1">1å›ç›®</span>
                                        {% elif item.split_payment_part == 2 %}
                                            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded ml-1">2å›ç›®</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-right">
                                    {{ item.amount|yen }}
                                </td>
                                <td class="px-3 py-2 text-center">
                                    {% if not item.is_default %}
                                        <button type="button" data-pk="{{ item.pk }}" data-year-month="{{ item.year_month }}" data-card-type="{{ item.card_type }}" data-description="{{ item.description }}" data-amount="{{ item.amount|stringformat:'d' }}" data-due-date="{{ item.due_date|date:'Y-m-d'|default:'' }}" data-purchase-date="{{ item.purchase_date|date:'Y-m-d'|default:'' }}" data-split="{{ item.is_split_payment|yesno:'true,false' }}" data-bonus="{{ item.is_bonus_payment|yesno:'true,false' }}" class="edit-btn bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 mr-1">ç·¨é›†</button>
                                        <form method="post" action="{% url 'budget_app:credit_estimate_delete' item.pk %}" class="inline" data-recurring="{{ item.is_recurring|yesno:'true,false' }}">
                                            {% csrf_token %}
                                            <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs">å‰Šé™¤</button>
                                        </form>
                                    {% else %}
                                        <button type="button" data-default-id="{{ item.default_id }}" data-label="{{ item.description }}" data-amount="{{ item.original_amount|stringformat:'d' }}" data-card-type="{{ item.card_type }}" data-year-month="{{ item.original_year_month }}" data-split="{{ item.is_split_payment|yesno:'true,false' }}" class="default-edit-btn bg-blue-500 text-white text-xs px-2 py-1 rounded hover:bg-blue-600 mr-1">ç·¨é›†</button>
                                        {# å®šæœŸé …ç›®ã‚’ã“ã®æœˆã ã‘éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  #}
                                        <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="inline delete-default-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete_default_for_month">
                                            <input type="hidden" name="default_id" value="{{ item.default_id }}">
                                            <input type="hidden" name="year_month" value="{{ item.original_year_month }}">
                                            <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs">å‰Šé™¤</button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºï¼šã‚«ãƒ¼ãƒ‰å½¢å¼ -->
            <div id="estimate-content-mobile-{{ ym }}" class="md:hidden p-4 space-y-6">
                {% for card_type, data in cards.items %}
                    <!-- ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white shadow-md">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold whitespace-wrap">{{ data.label }}</div>
                            <h4 class="text-2xl font-bold whitespace-wrap ml-2">{{ data.total|yen }}</h4>
                        </div>
                        <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="reflect-card-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="reflect_card">
                            <input type="hidden" name="year_month" value="{% if '_bonus' in ym %}{{ ym|slice:':-6' }}{% else %}{{ ym }}{% endif %}">
                            <input type="hidden" name="card_type" value="{{ card_type }}">
                            <button type="submit" class="w-full bg-white text-blue-600 text-sm px-4 py-2 rounded-md font-semibold hover:bg-blue-50 transition">
                                æœˆæ¬¡è¨ˆç”»ã«åæ˜ 
                            </button>
                        </form>
                    </div>

                    <!-- å€‹åˆ¥é …ç›® -->
                    <div class="space-y-3 ml-2">
                        {% for item in data.entries %}
                        <div class="border-l-4 {% if item.is_default %}border-gray-400 bg-gray-50{% else %}border-blue-300 bg-white{% endif %} rounded-r-lg shadow-sm p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-base mb-1">
                                        {% if item.description %}
                                            {{ item.description }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% if item.is_default %}
                                            <span class="text-xs text-gray-500 ml-1">(å®šæœŸ)</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        {% if item.is_bonus_payment and item.purchase_date %}
                                            <div>ğŸ“… {{ item.purchase_date|date:'Y/m/d' }}</div>
                                        {% elif item.due_date %}
                                            <div>ğŸ“… {{ item.due_date|date:'Y/m/d' }}</div>
                                        {% endif %}
                                        {% if item.split_payment_part %}
                                            <div class="flex gap-1 flex-wrap">
                                                <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">åˆ†å‰²æ‰•ã„</span>
                                                {% if item.split_payment_part == 1 %}
                                                    <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded">1å›ç›®</span>
                                                {% elif item.split_payment_part == 2 %}
                                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">2å›ç›®</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-right ml-3">
                                    <div class="text-xl font-bold text-blue-600">{{ item.amount|yen }}</div>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-3">
                                {% if not item.is_default %}
                                    <button type="button" data-pk="{{ item.pk }}" data-year-month="{{ item.year_month }}" data-card-type="{{ item.card_type }}" data-description="{{ item.description }}" data-amount="{{ item.amount|stringformat:'d' }}" data-due-date="{{ item.due_date|date:'Y-m-d'|default:'' }}" data-purchase-date="{{ item.purchase_date|date:'Y-m-d'|default:'' }}" data-split="{{ item.is_split_payment|yesno:'true,false' }}" data-bonus="{{ item.is_bonus_payment|yesno:'true,false' }}" class="edit-btn flex-1 bg-blue-500 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-600 font-medium">
                                        ç·¨é›†
                                    </button>
                                    <form method="post" action="{% url 'budget_app:credit_estimate_delete' item.pk %}" class="flex-1" data-recurring="{{ item.is_recurring|yesno:'true,false' }}">
                                        {% csrf_token %}
                                        <button type="submit" class="w-full bg-red-500 text-white text-sm px-3 py-2 rounded-md hover:bg-red-600 font-medium">
                                            å‰Šé™¤
                                        </button>
                                    </form>
                                {% else %}
                                    <button type="button" data-default-id="{{ item.default_id }}" data-label="{{ item.description }}" data-amount="{{ item.original_amount|stringformat:'d' }}" data-card-type="{{ item.card_type }}" data-year-month="{{ item.original_year_month }}" data-split="{{ item.is_split_payment|yesno:'true,false' }}" class="default-edit-btn flex-1 bg-blue-500 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-600 font-medium">
                                        ç·¨é›†
                                    </button>
                                    <form method="post" action="{% url 'budget_app:credit_estimates' %}" class="delete-default-form flex-1">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_default_for_month">
                                        <input type="hidden" name="default_id" value="{{ item.default_id }}">
                                        <input type="hidden" name="year_month" value="{{ item.original_year_month }}">
                                        <button type="submit" class="w-full bg-red-500 text-white text-sm px-3 py-2 rounded-md hover:bg-red-600 font-medium">
                                            å‰Šé™¤
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="text-gray-600">{{ title }}ã®è¦‹ç©ã‚‚ã‚Šã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
{% endif %}